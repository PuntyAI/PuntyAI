name: Deploy

on:
  push:
    branches: ['**']

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: pytest tests/unit/ -v --tb=short

  e2e-test:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: Run E2E tests
        run: pytest tests/e2e/ -v --tb=short

      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots
          path: tests/e2e/screenshots/
          if-no-files-found: ignore

  deploy-staging:
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to staging
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          command_timeout: 120s
          script: |
            cd /opt/puntyai-staging
            PREV=$(git rev-parse HEAD)
            git fetch origin
            git checkout -f origin/${{ github.ref_name }} 2>/dev/null || git checkout -f origin/master
            source venv/bin/activate
            pip install -e . --quiet 2>&1 | tail -1
            chmod 666 prompts/*.md
            systemctl restart puntyai-staging
            sleep 3
            HTTP=$(curl -sf -o /dev/null -w "%{http_code}" http://127.0.0.1:8001/health)
            if [ "$HTTP" != "200" ]; then
              echo "FAIL: health check returned $HTTP, rolling back to $PREV"
              git checkout -f $PREV
              systemctl restart puntyai-staging
              exit 1
            fi
            echo "Staging deploy successful ($(git rev-parse --short HEAD))"
            # Auto-seed staging DB from production if empty
            ROWS=$(sqlite3 /opt/puntyai-staging/data/punty.db "SELECT COUNT(*) FROM meetings" 2>/dev/null || echo "0")
            if [ "$ROWS" = "0" ]; then
              cd /opt/puntyai && source venv/bin/activate && python scripts/seed_staging.py
              systemctl restart puntyai-staging
              sleep 3
              curl -sf http://127.0.0.1:8001/health || exit 1
              echo "Seeded staging DB from production"
            fi

  deploy-production:
    needs: [unit-test, deploy-staging]
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          command_timeout: 120s
          script: |
            cd /opt/puntyai
            PREV=$(git rev-parse HEAD)
            git fetch origin master
            git checkout -f origin/master
            source venv/bin/activate
            pip install -e . --quiet 2>&1 | tail -1
            chmod 666 prompts/*.md
            systemctl restart puntyai
            sleep 5
            for i in 1 2 3; do
              HTTP=$(curl -sf -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/health)
              if [ "$HTTP" = "200" ]; then
                echo "Production deploy successful ($(git rev-parse --short HEAD))"
                exit 0
              fi
              echo "Health check attempt $i: $HTTP"
              sleep 3
            done
            echo "FAIL: health check failed after 3 retries, rolling back to $PREV"
            git checkout -f $PREV
            systemctl restart puntyai
            exit 1
