{% extends "base.html" %}

{% block title %}Settings - PuntyAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
        <p class="text-gray-500">Configure Punty's behaviour and integrations</p>
    </div>

    <!-- Scheduler Status -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-punty-border flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Daily Automation</h2>
                <p class="text-sm text-gray-500">Automatic morning prep runs daily between 7:30-8:30 AM Melbourne time</p>
            </div>
            <div id="scheduler-status" class="flex items-center gap-3">
                <span class="text-sm text-gray-500">Loading...</span>
            </div>
        </div>
        <div class="p-6">
            <div class="flex flex-wrap items-center gap-4">
                <div id="morning-time" class="text-center px-6 py-3 bg-punty-card2 rounded-lg">
                    <div class="text-xs text-gray-500 uppercase tracking-wider">Today's Run Time</div>
                    <div class="text-2xl font-bold text-punty-coral font-mono" id="scheduled-time">--:--</div>
                    <div id="automation-status" class="text-xs mt-1 text-green-500">Active</div>
                </div>
                <div class="space-y-2">
                    <button onclick="toggleAutomation()" id="btn-toggle-automation"
                            class="block w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-500 text-sm">
                        &#x23F8; Pause Automation
                    </button>
                    <button onclick="runMorningPrepNow()"
                            class="block w-full bg-punty-coral text-white px-4 py-2 rounded-lg hover:bg-punty-coral/90 text-sm">
                        &#x25B6; Run Now
                    </button>
                    <button onclick="rescheduleMorningPrep()"
                            class="block w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 text-sm">
                        &#x1F504; Pick New Time
                    </button>
                </div>
                <div class="text-sm text-gray-500 flex-1">
                    <p><strong>Morning prep includes:</strong></p>
                    <ul class="list-disc list-inside mt-1 space-y-0.5">
                        <li>Scrape racing calendar</li>
                        <li>Auto-select metro meetings</li>
                        <li>Scrape form data + speed maps</li>
                        <li>Generate early mail for all selected</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Notifications (Resend) -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-punty-border">
            <h2 class="text-lg font-semibold text-gray-900">Email Notifications</h2>
            <p class="text-sm text-gray-500">Resend API for scheduler notifications (HTTP-based, no firewall issues)</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Resend API Key</label>
                    <input type="password" id="resend_api_key"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           placeholder="re_..."
                           value="{{ settings.get('resend_api_key', {}).get('value', '') }}">
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://resend.com/api-keys" target="_blank" class="text-punty-coral hover:underline">resend.com</a></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Address</label>
                    <input type="text" id="email_from"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           placeholder="PuntyAI <noreply@punty.ai>"
                           value="{{ settings.get('email_from', {}).get('value', 'PuntyAI <noreply@punty.ai>') }}">
                    <p class="text-xs text-gray-500 mt-1">Must be from a verified domain</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notification Email</label>
                    <input type="email" id="notification_email"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           placeholder="punty@punty.ai"
                           value="{{ settings.get('notification_email', {}).get('value', '') }}">
                    <p class="text-xs text-gray-500 mt-1">Where to send scheduler notifications</p>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-3">
                <button onclick="saveResendSettings()"
                        class="bg-punty-coral text-white px-4 py-2 rounded-lg hover:bg-punty-coral/90 text-sm">
                    Save Email Settings
                </button>
                <button onclick="testEmail()"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 text-sm">
                    Send Test Email
                </button>
                <span id="email-status" class="text-sm text-gray-500"></span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Analysis Framework Weights -->
        <div class="bg-white rounded-lg shadow lg:col-span-2">
            <div class="px-6 py-4 border-b border-punty-border flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Analysis Framework Weights</h2>
                    <p class="text-sm text-gray-500">Configure how Punty weighs different factors when analysing horses</p>
                </div>
                <button hx-post="/api/settings/weights/reset"
                        hx-target="#weights-form"
                        hx-swap="outerHTML"
                        class="text-sm text-gray-500 hover:text-punty-coral">
                    Reset to Defaults
                </button>
            </div>
            <form id="weights-form" class="p-6" hx-put="/api/settings/weights" hx-trigger="change" hx-swap="none">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for key, label in weight_labels.items() %}
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-gray-700">{{ label }}</label>
                        <select name="weights[{{ key }}]"
                                class="w-full bg-punty-card2 border border-punty-border text-white rounded px-3 py-1.5 text-sm focus:ring-punty-coral focus:border-punty-coral">
                            {% for option in weight_options %}
                            <option value="{{ option }}" {% if weights.get(key) == option %}selected{% endif %}>
                                {{ option|title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-4 pt-4 border-t text-sm text-gray-500">
                    <p><strong>Tip:</strong> Higher weights give more importance to that factor in Punty's analysis. "High" factors are critical to selections, "Low" factors are considered but not heavily weighted.</p>
                </div>
            </form>
        </div>

        <!-- Favorites Detection Settings -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-punty-border">
                <h2 class="text-lg font-semibold text-gray-900">Value vs Favorites</h2>
                <p class="text-sm text-gray-500">Configure how Punty handles market favorites</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Favorites Odds Threshold</label>
                    <input type="number" step="0.10" min="1.00" max="5.00"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           value="{{ settings.get('favorites_threshold', {}).get('value', '2.50') }}"
                           hx-put="/api/settings/favorites_threshold"
                           hx-trigger="change"
                           hx-swap="none"
                           name="value">
                    <p class="text-xs text-gray-500 mt-1">Horses at or below this price are considered "favorites"</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Favorites Per Card</label>
                    <input type="number" min="1" max="10"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           value="{{ settings.get('max_favorites_per_card', {}).get('value', '3') }}"
                           hx-put="/api/settings/max_favorites_per_card"
                           hx-trigger="change"
                           hx-swap="none"
                           name="value">
                    <p class="text-xs text-gray-500 mt-1">Trigger widen request if more favorites selected</p>
                </div>

                <label class="flex items-center space-x-3 mt-4">
                    <input type="checkbox"
                           class="rounded text-punty-coral focus:ring-punty-coral"
                           {% if settings.get('auto_widen_favorites', {}).get('value', 'false') == 'true' %}checked{% endif %}
                           hx-put="/api/settings/auto_widen_favorites"
                           hx-trigger="change"
                           hx-swap="none"
                           hx-vals='{"value": "{{ 'false' if settings.get('auto_widen_favorites', {}).get('value', 'false') == 'true' else 'true' }}"}'>
                    <div>
                        <span class="text-sm font-medium text-gray-700">Auto-widen selections</span>
                        <p class="text-xs text-gray-500">Automatically ask AI to reconsider when too many favorites</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- WhatsApp Settings -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-punty-border">
                <h2 class="text-lg font-semibold text-gray-900">WhatsApp Settings</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Group Invite Link</label>
                    <input type="url"
                           class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2"
                           placeholder="https://chat.whatsapp.com/..."
                           value="{{ settings.get('whatsapp_invite_link', {}).get('value', '') }}"
                           hx-put="/api/settings/whatsapp_invite_link"
                           hx-trigger="change"
                           hx-swap="none"
                           name="value">
                    <p class="text-xs text-gray-500 mt-1">The only link allowed in Early Mail</p>
                </div>

                <label class="flex items-center space-x-3">
                    <input type="checkbox"
                           class="rounded text-punty-coral focus:ring-punty-coral"
                           {% if settings.get('use_emojis', {}).get('value', 'false') == 'true' %}checked{% endif %}
                           hx-put="/api/settings/use_emojis"
                           hx-trigger="change"
                           hx-swap="none"
                           hx-vals='{"value": "{{ 'false' if settings.get('use_emojis', {}).get('value', 'false') == 'true' else 'true' }}"}'>
                    <div>
                        <span class="text-sm font-medium text-gray-700">Use Emojis</span>
                        <p class="text-xs text-gray-500">PUNTY_MASTER v3.13 says no emojis!</p>
                    </div>
                </label>

                <label class="flex items-center space-x-3">
                    <input type="checkbox"
                           class="rounded text-punty-coral focus:ring-punty-coral"
                           {% if settings.get('persona_swearing', {}).get('value', 'true') == 'true' %}checked{% endif %}
                           hx-put="/api/settings/persona_swearing"
                           hx-trigger="change"
                           hx-swap="none"
                           hx-vals='{"value": "{{ 'false' if settings.get('persona_swearing', {}).get('value', 'true') == 'true' else 'true' }}"}'>
                    <div>
                        <span class="text-sm font-medium text-gray-700">Colorful Language</span>
                        <p class="text-xs text-gray-500">Allow Punty to swear for colour</p>
                    </div>
                </label>
            </div>
        </div>

        <!-- API Keys -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-punty-border">
                <h2 class="text-lg font-semibold text-gray-900">API Keys</h2>
            </div>
            <div class="p-6 space-y-6">

                <!-- OpenAI -->
                <div id="openai-section">
                    <label class="block text-sm font-medium text-gray-700 mb-1">OpenAI API Key</label>
                    <div id="openai-display" class="flex items-center space-x-2">
                        <span class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-punty-card2 text-sm text-gray-600">
                            {{ api_key_status.openai if api_key_status.openai else 'Not configured' }}
                        </span>
                        <span class="text-xs px-2 py-1 rounded {{ 'bg-green-100 text-green-700' if api_key_status.openai else 'bg-red-100 text-red-700' }}">
                            {{ 'Active' if api_key_status.openai else 'Missing' }}
                        </span>
                        <button onclick="document.getElementById('openai-edit').classList.remove('hidden'); this.parentElement.classList.add('hidden')"
                                class="text-punty-coral hover:underline text-sm">Edit</button>
                    </div>
                    <div id="openai-edit" class="hidden space-y-2 mt-2">
                        <input type="text" id="oai_key" placeholder="sk-proj-..."
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="saveApiKeys('openai', {openai_api_key: document.getElementById('oai_key').value})"
                                    class="bg-punty-coral text-white px-3 py-1 rounded text-sm hover:bg-punty-coral/90">Save</button>
                            <button onclick="document.getElementById('openai-edit').classList.add('hidden'); document.getElementById('openai-display').classList.remove('hidden')"
                                    class="text-gray-500 hover:underline text-sm">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Twitter/X -->
                <div id="twitter-section">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Twitter/X API</label>
                    <div id="twitter-display" class="flex items-center space-x-2">
                        <span class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-punty-card2 text-sm text-gray-600">
                            {{ api_key_status.twitter if api_key_status.twitter else 'Not configured' }}
                        </span>
                        <span class="text-xs px-2 py-1 rounded {{ 'bg-green-100 text-green-700' if api_key_status.twitter else 'bg-red-100 text-red-700' }}">
                            {{ 'Active' if api_key_status.twitter else 'Missing' }}
                        </span>
                        <button onclick="document.getElementById('twitter-edit').classList.remove('hidden'); this.parentElement.classList.add('hidden')"
                                class="text-punty-coral hover:underline text-sm">Configure</button>
                    </div>
                    <div id="twitter-edit" class="hidden space-y-2 mt-2">
                        <input type="text" id="tw_api_key" placeholder="API Key (Consumer Key)"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="tw_api_secret" placeholder="API Secret (Consumer Secret)"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="tw_access_token" placeholder="Access Token"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="tw_access_secret" placeholder="Access Secret"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="saveApiKeys('twitter', {twitter_api_key: document.getElementById('tw_api_key').value, twitter_api_secret: document.getElementById('tw_api_secret').value, twitter_access_token: document.getElementById('tw_access_token').value, twitter_access_secret: document.getElementById('tw_access_secret').value})"
                                    class="bg-punty-coral text-white px-3 py-1 rounded text-sm hover:bg-punty-coral/90">Save</button>
                            <button onclick="document.getElementById('twitter-edit').classList.add('hidden'); document.getElementById('twitter-display').classList.remove('hidden')"
                                    class="text-gray-500 hover:underline text-sm">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp -->
                <div id="whatsapp-section">
                    <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Business API</label>
                    <div id="whatsapp-display" class="flex items-center space-x-2">
                        <span class="flex-1 border border-gray-300 rounded-lg px-3 py-2 bg-punty-card2 text-sm text-gray-600">
                            {{ api_key_status.whatsapp if api_key_status.whatsapp else 'Not configured' }}
                        </span>
                        <span class="text-xs px-2 py-1 rounded {{ 'bg-green-100 text-green-700' if api_key_status.whatsapp else 'bg-red-100 text-red-700' }}">
                            {{ 'Active' if api_key_status.whatsapp else 'Missing' }}
                        </span>
                        <button onclick="document.getElementById('whatsapp-edit').classList.remove('hidden'); this.parentElement.classList.add('hidden')"
                                class="text-punty-coral hover:underline text-sm">Configure</button>
                    </div>
                    <div id="whatsapp-edit" class="hidden space-y-2 mt-2">
                        <input type="text" id="wa_api_token" placeholder="API Token"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="wa_phone_id" placeholder="Phone Number ID"
                               class="w-full bg-punty-card2 border border-punty-border text-white rounded-lg px-3 py-2 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="saveApiKeys('whatsapp', {whatsapp_api_token: document.getElementById('wa_api_token').value, whatsapp_phone_number_id: document.getElementById('wa_phone_id').value})"
                                    class="bg-punty-coral text-white px-3 py-1 rounded text-sm hover:bg-punty-coral/90">Save</button>
                            <button onclick="document.getElementById('whatsapp-edit').classList.add('hidden'); document.getElementById('whatsapp-display').classList.remove('hidden')"
                                    class="text-gray-500 hover:underline text-sm">Cancel</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Approval Settings -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-punty-border">
                <h2 class="text-lg font-semibold text-gray-900">Approval Settings</h2>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-500 mb-4">Configure which content types require manual review</p>

                <div class="space-y-3">
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Early Mail</span>
                        <input type="checkbox" checked class="rounded text-punty-coral focus:ring-punty-coral">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Race Previews</span>
                        <input type="checkbox" class="rounded text-punty-coral focus:ring-punty-coral">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Results</span>
                        <input type="checkbox" class="rounded text-punty-coral focus:ring-punty-coral">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Update Alerts</span>
                        <input type="checkbox" checked class="rounded text-punty-coral focus:ring-punty-coral">
                    </label>
                    <label class="flex items-center justify-between">
                        <span class="text-sm text-gray-700">Group 1 Races</span>
                        <input type="checkbox" checked class="rounded text-punty-coral focus:ring-punty-coral">
                    </label>
                </div>
            </div>
        </div>

        <!-- Scheduled Jobs -->
        <div class="bg-white rounded-lg shadow lg:col-span-2">
            <div class="px-6 py-4 border-b border-punty-border flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Scheduled Jobs</h2>
                <button class="text-punty-coral hover:underline text-sm">+ Add Job</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-punty-border">
                    <thead class="bg-punty-card2">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Meeting</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Schedule</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Run</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-punty-border">
                        {% for job in jobs %}
                        <tr class="hover:bg-punty-card2">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ job.job_type|replace('_', ' ')|title }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ job.meeting_id or 'All' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
                                {{ job.cron_expression or 'Manual' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ job.last_run.strftime('%d %b %H:%M') if job.last_run else 'Never' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if job.enabled %}
                                <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Active</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800">Disabled</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                <button hx-put="/api/scheduler/jobs/{{ job.id }}/toggle"
                                        class="text-punty-coral hover:underline">
                                    {{ 'Disable' if job.enabled else 'Enable' }}
                                </button>
                                <button hx-post="/api/scheduler/run/{{ job.job_type }}?meeting_id={{ job.meeting_id }}"
                                        class="text-blue-600 hover:underline">
                                    Run Now
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                No scheduled jobs configured
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Punty Personality -->
        <div class="bg-white rounded-lg shadow lg:col-span-2">
            <div class="px-6 py-4 border-b border-punty-border">
                <h2 class="text-lg font-semibold text-gray-900">Punty's Personality (PUNTY_MASTER v3.13)</h2>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-500 mb-4">
                    Edit the personality prompt that defines how Punty writes content.
                    This is loaded from <code class="bg-gray-100 px-1 rounded">prompts/personality.md</code>
                </p>
                <textarea class="w-full h-64 bg-punty-card2 border border-punty-border text-white rounded-lg p-4 font-mono text-sm"
                          placeholder="Loading personality prompt...">{{ personality_prompt }}</textarea>
                <div class="mt-4 flex justify-end space-x-3">
                    <button class="text-gray-500 hover:text-gray-700 px-4 py-2">
                        Reset to Default
                    </button>
                    <button class="bg-punty-coral text-white px-4 py-2 rounded-lg hover:bg-punty-coral/90">
                        Save Personality
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function saveApiKeys(provider, keys) {
    try {
        const resp = await fetch(`/api/settings/api-keys/${provider}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keys: keys})
        });
        if (!resp.ok) {
            const err = await resp.text();
            alert('Save failed: ' + err);
            return;
        }
        window.location.reload();
    } catch (e) {
        alert('Save failed: ' + e.message);
    }
}

// Scheduler functions
var automationPaused = false;

async function loadSchedulerStatus() {
    try {
        const resp = await fetch('/api/scheduler/status');
        const data = await resp.json();

        const statusEl = document.getElementById('scheduler-status');
        const timeEl = document.getElementById('scheduled-time');

        if (data.running) {
            statusEl.innerHTML = '<span class="px-2 py-1 rounded bg-green-100 text-green-800 text-sm">Running</span>';
        } else {
            statusEl.innerHTML = '<span class="px-2 py-1 rounded bg-red-100 text-red-800 text-sm">Stopped</span>';
        }

        if (data.morning_prep_time) {
            timeEl.textContent = data.morning_prep_time;
        } else {
            timeEl.textContent = 'Not scheduled';
        }

        // Check if paused
        const pausedResp = await fetch('/api/scheduler/morning-prep/paused');
        const pausedData = await pausedResp.json();
        automationPaused = pausedData.paused;
        updateToggleButton();
    } catch (e) {
        console.error('Failed to load scheduler status:', e);
    }
}

function updateToggleButton() {
    const btn = document.getElementById('btn-toggle-automation');
    const statusEl = document.getElementById('automation-status');

    if (automationPaused) {
        btn.innerHTML = '&#x25B6; Resume Automation';
        btn.className = 'block w-full bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-500 text-sm';
        statusEl.textContent = 'Paused';
        statusEl.className = 'text-xs mt-1 text-yellow-500';
    } else {
        btn.innerHTML = '&#x23F8; Pause Automation';
        btn.className = 'block w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-500 text-sm';
        statusEl.textContent = 'Active';
        statusEl.className = 'text-xs mt-1 text-green-500';
    }
}

async function toggleAutomation() {
    try {
        const resp = await fetch('/api/scheduler/morning-prep/toggle', { method: 'POST' });
        const data = await resp.json();

        automationPaused = data.paused;
        updateToggleButton();

        if (data.paused) {
            showToast('Automation paused', 'warning');
        } else {
            showToast('Automation resumed', 'success');
            loadSchedulerStatus(); // Refresh to get new time
        }
    } catch (e) {
        showToast('Failed to toggle automation', 'error');
    }
}

async function runMorningPrepNow() {
    if (!confirm('Run the morning prep job now? This will scrape all data and generate early mail for selected meetings.')) {
        return;
    }

    try {
        const resp = await fetch('/api/scheduler/morning-prep/run', { method: 'POST' });
        const data = await resp.json();
        showToast('Morning prep started in background', 'success');
    } catch (e) {
        showToast('Failed to start morning prep: ' + e.message, 'error');
    }
}

async function rescheduleMorningPrep() {
    try {
        const resp = await fetch('/api/scheduler/morning-prep/reschedule', { method: 'POST' });
        const data = await resp.json();
        document.getElementById('scheduled-time').textContent = data.new_time;
        showToast('Morning prep rescheduled to ' + data.new_time, 'success');
    } catch (e) {
        showToast('Failed to reschedule: ' + e.message, 'error');
    }
}

// Load scheduler status on page load
loadSchedulerStatus();

// Resend email settings functions
async function saveResendSettings() {
    const keys = {
        resend_api_key: document.getElementById('resend_api_key').value,
        email_from: document.getElementById('email_from').value,
        notification_email: document.getElementById('notification_email').value,
    };

    try {
        const resp = await fetch('/api/settings/api-keys/resend', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keys: keys})
        });
        if (resp.ok) {
            document.getElementById('email-status').textContent = 'Saved!';
            document.getElementById('email-status').style.color = 'green';
            showToast('Email settings saved', 'success');
        } else {
            throw new Error('Save failed');
        }
    } catch (e) {
        document.getElementById('email-status').textContent = 'Error saving';
        document.getElementById('email-status').style.color = 'red';
        showToast('Failed to save email settings', 'error');
    }
}

async function testEmail() {
    const statusEl = document.getElementById('email-status');
    const notifEmail = document.getElementById('notification_email').value || 'punty@punty.ai';
    statusEl.textContent = 'Sending test email...';
    statusEl.style.color = 'orange';

    try {
        const resp = await fetch('/api/settings/test-email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({to_email: notifEmail})
        });
        const data = await resp.json();

        if (data.status === 'sent') {
            statusEl.textContent = 'Test email sent!';
            statusEl.style.color = 'green';
            showToast('Test email sent to ' + notifEmail, 'success');
        } else {
            statusEl.textContent = 'Error: ' + (data.message || 'Unknown error');
            statusEl.style.color = 'red';
            showToast('Email failed: ' + (data.message || 'Check email settings'), 'error');
        }
    } catch (e) {
        statusEl.textContent = 'Error sending';
        statusEl.style.color = 'red';
        showToast('Failed to send test email', 'error');
    }
}
</script>
{% endblock %}
