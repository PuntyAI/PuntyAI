{% extends "glory/base.html" %}

{% block title %}{{ competition.name }} - Admin - Group One Glory{% endblock %}

{% block content %}
<div x-data="competitionDetailApp()" class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <a href="/group1glory/admin/competitions" class="text-glory-gold-400 hover:text-glory-gold-300">&larr; Back</a>
            </div>
            <h1 class="text-3xl font-display text-gold">{{ competition.name }}</h1>
            <p class="text-secondary">
                {{ competition.start_date.strftime('%d %B %Y') }} - {{ competition.end_date.strftime('%d %B %Y') }}
            </p>
        </div>
        <div class="flex items-center gap-3">
            {% if competition.is_active %}
            <span class="bg-glory-green-600 text-white px-3 py-1 rounded">Active</span>
            {% else %}
            <button @click="activate()" class="btn-gold">Activate</button>
            {% endif %}
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-card rounded-xl p-4">
            <div class="text-3xl font-bold text-gold">{{ stats.total_races }}</div>
            <div class="text-sm text-muted">Total Races</div>
        </div>
        <div class="bg-card rounded-xl p-4">
            <div class="text-3xl font-bold text-glory-green-300">{{ stats.resulted_races }}</div>
            <div class="text-sm text-muted">Resulted</div>
        </div>
        <div class="bg-card rounded-xl p-4">
            <div class="text-3xl font-bold text-glory-gold-400">{{ stats.open_races }}</div>
            <div class="text-sm text-muted">Open</div>
        </div>
        <div class="bg-card rounded-xl p-4">
            <div class="text-3xl font-bold text-secondary">{{ stats.upcoming_races }}</div>
            <div class="text-sm text-muted">Upcoming</div>
        </div>
    </div>

    <!-- Import Races -->
    <div class="bg-card rounded-xl p-6">
        <h2 class="text-xl font-display text-gold mb-4">Import Races from Calendar</h2>
        <p class="text-secondary mb-4">
            Import Group 1 races from the Racing Australia calendar into this competition.
        </p>
        <button @click="importCalendar()" class="btn-primary" :disabled="importing">
            <span x-show="!importing">Import Calendar Races</span>
            <span x-show="importing"><span class="spinner"></span> Importing...</span>
        </button>
    </div>

    <!-- Races List -->
    <div class="bg-card rounded-xl overflow-hidden">
        <div class="p-4 border-b border-glory-gold/10 flex items-center justify-between">
            <h2 class="text-lg font-display text-gold">Races ({{ competition.races|length }})</h2>
            <button @click="showAddRaceModal = true" class="btn-outline text-sm">Add Race Manually</button>
        </div>

        {% if competition.races %}
        <table class="w-full">
            <thead class="bg-glory-green-800/50 text-sm text-secondary">
                <tr>
                    <th class="px-4 py-3 text-left">Race</th>
                    <th class="px-4 py-3 text-left">Venue</th>
                    <th class="px-4 py-3 text-center">Date</th>
                    <th class="px-4 py-3 text-center">Horses</th>
                    <th class="px-4 py-3 text-center">Status</th>
                    <th class="px-4 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-glory-gold/10">
                {% for race in competition.races|sort(attribute='race_date') %}
                <tr>
                    <td class="px-4 py-3">
                        <div class="font-semibold">{{ race.race_name }}</div>
                        <div class="text-xs text-muted">{{ race.distance }}m</div>
                    </td>
                    <td class="px-4 py-3 text-secondary">{{ race.venue }}</td>
                    <td class="px-4 py-3 text-center text-secondary">{{ race.race_date|melb_date }}</td>
                    <td class="px-4 py-3 text-center">{{ race.horses|length if race.horses else 0 }}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded text-xs
                            {% if race.status == 'resulted' %}bg-glory-green-600 text-white
                            {% elif race.status == 'open' %}bg-glory-gold-400 text-glory-green-800
                            {% elif race.status == 'closed' %}bg-gray-600 text-white
                            {% else %}bg-gray-700 text-gray-300{% endif %}">
                            {{ race.status|title }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <a href="/group1glory/admin/races/{{ race.id }}" class="text-glory-gold-400 hover:text-glory-gold-300 text-sm">
                            Manage
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-8 text-center">
            <p class="text-muted">No races in this competition yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Add Race Modal -->
    <div x-show="showAddRaceModal" x-cloak class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div @click.away="showAddRaceModal = false" class="bg-glory-green-800 rounded-xl p-6 max-w-md w-full">
            <h2 class="text-xl font-display text-gold mb-4">Add Race</h2>

            <form @submit.prevent="addRace()" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Race Name</label>
                    <input type="text" x-model="newRace.race_name" required class="input-field" placeholder="e.g., Melbourne Cup">
                </div>

                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Venue</label>
                    <input type="text" x-model="newRace.venue" required class="input-field" placeholder="e.g., Flemington">
                </div>

                <div>
                    <label class="block text-sm font-medium text-secondary mb-1">Date & Time</label>
                    <input type="datetime-local" x-model="newRace.race_date" required class="input-field">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Distance (m)</label>
                        <input type="number" x-model="newRace.distance" required class="input-field" placeholder="2000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-1">Prize Money ($)</label>
                        <input type="number" x-model="newRace.prize_money" class="input-field" placeholder="0">
                    </div>
                </div>

                <div class="flex gap-3 justify-end pt-4">
                    <button type="button" @click="showAddRaceModal = false" class="btn-outline">Cancel</button>
                    <button type="submit" class="btn-gold">Add Race</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function competitionDetailApp() {
    return {
        showAddRaceModal: false,
        importing: false,
        newRace: {
            race_name: '',
            venue: '',
            race_date: '',
            distance: 2000,
            prize_money: null,
        },

        async activate() {
            try {
                const response = await fetch('/group1glory/api/admin/competitions/{{ competition.id }}/activate', {
                    method: 'POST',
                });
                if (response.ok) {
                    showToast('Competition activated!', 'success');
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            }
        },

        async importCalendar() {
            this.importing = true;
            try {
                const response = await fetch('/group1glory/api/admin/import-calendar?competition_id={{ competition.id }}', {
                    method: 'POST',
                });
                const data = await response.json();

                if (response.ok) {
                    showToast(`Imported ${data.races_imported} races!`, 'success');
                    window.location.reload();
                } else {
                    showToast(data.detail || 'Import failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            } finally {
                this.importing = false;
            }
        },

        async addRace() {
            try {
                const response = await fetch('/group1glory/api/admin/races', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        competition_id: '{{ competition.id }}',
                        race_name: this.newRace.race_name,
                        venue: this.newRace.venue,
                        race_date: this.newRace.race_date,
                        distance: parseInt(this.newRace.distance),
                        prize_money: this.newRace.prize_money ? parseInt(this.newRace.prize_money) * 100 : null,
                    }),
                });

                if (response.ok) {
                    showToast('Race added!', 'success');
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            }
        },
    };
}
</script>
{% endblock %}
