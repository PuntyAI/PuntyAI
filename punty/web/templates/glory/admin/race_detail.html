{% extends "glory/base.html" %}

{% block title %}{{ race.race_name }} - Admin - Group One Glory{% endblock %}

{% block content %}
<div x-data="raceDetailApp()" class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <a href="/group1glory/admin/races" class="text-glory-gold-400 hover:text-glory-gold-300 text-sm">&larr; Back to Races</a>
            <h1 class="text-3xl font-display text-gold mt-2">{{ race.race_name }}</h1>
            <p class="text-secondary">
                {{ race.venue }} &bull; {{ race.distance }}m &bull; {{ race.race_date|melb_date }}
            </p>
        </div>
        <div class="flex items-center gap-3">
            <span class="px-3 py-1 rounded
                {% if race.status == 'resulted' %}bg-glory-green-600 text-white
                {% elif race.status == 'open' %}bg-glory-gold-400 text-glory-green-800
                {% elif race.status == 'closed' %}bg-gray-600 text-white
                {% else %}bg-gray-700 text-gray-300{% endif %}">
                {{ race.status|title }}
            </span>
        </div>
    </div>

    <!-- Actions -->
    <div class="bg-card rounded-xl p-6">
        <h2 class="text-lg font-display text-gold mb-4">Race Actions</h2>

        <div class="grid md:grid-cols-2 gap-4">
            <!-- Import Horses -->
            <div class="p-4 bg-glory-green-800/30 rounded-lg">
                <h3 class="font-semibold mb-2">Import Horses from Racing.com</h3>
                <p class="text-sm text-secondary mb-3">Fetch the latest field data including jockeys, weights, and odds.</p>
                <button @click="importHorses()" class="btn-primary" :disabled="importing">
                    <span x-show="!importing">Import Horses</span>
                    <span x-show="importing"><span class="spinner"></span> Importing...</span>
                </button>
            </div>

            <!-- Update Status -->
            <div class="p-4 bg-glory-green-800/30 rounded-lg">
                <h3 class="font-semibold mb-2">Update Status</h3>
                <p class="text-sm text-secondary mb-3">Change the race status to control tipping.</p>
                <div class="flex gap-2 flex-wrap">
                    <button @click="updateStatus('nominations')" class="btn-outline text-sm" :disabled="race.status === 'nominations'">Nominations</button>
                    <button @click="updateStatus('final_field')" class="btn-outline text-sm" :disabled="race.status === 'final_field'">Final Field</button>
                    <button @click="updateStatus('open')" class="btn-outline text-sm" :disabled="race.status === 'open'">Open</button>
                    <button @click="updateStatus('closed')" class="btn-outline text-sm" :disabled="race.status === 'closed'">Closed</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Horses -->
    <div class="bg-card rounded-xl overflow-hidden">
        <div class="p-4 border-b border-glory-gold/10 flex items-center justify-between">
            <h2 class="text-lg font-display text-gold">Horses ({{ race.horses|length if race.horses else 0 }})</h2>
        </div>

        {% if race.horses %}
        <table class="w-full">
            <thead class="bg-glory-green-800/50 text-sm text-secondary">
                <tr>
                    <th class="px-4 py-3 text-left">No.</th>
                    <th class="px-4 py-3 text-left">Horse</th>
                    <th class="px-4 py-3 text-left">Jockey</th>
                    <th class="px-4 py-3 text-left">Trainer</th>
                    <th class="px-4 py-3 text-center">Barrier</th>
                    <th class="px-4 py-3 text-center">Weight</th>
                    <th class="px-4 py-3 text-center">Odds</th>
                    <th class="px-4 py-3 text-center">Result</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-glory-gold/10">
                {% for horse in race.horses|sort(attribute='saddlecloth') %}
                <tr class="{% if horse.is_scratched %}opacity-50{% endif %}">
                    <td class="px-4 py-3 font-bold">{{ horse.saddlecloth or '-' }}</td>
                    <td class="px-4 py-3">
                        <span class="{% if horse.is_scratched %}line-through{% endif %}">{{ horse.name }}</span>
                        {% if horse.is_scratched %}
                        <span class="text-red-400 text-xs ml-1">SCR</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-secondary">{{ horse.jockey or 'TBA' }}</td>
                    <td class="px-4 py-3 text-secondary">{{ horse.trainer or 'TBA' }}</td>
                    <td class="px-4 py-3 text-center">{{ horse.barrier or '-' }}</td>
                    <td class="px-4 py-3 text-center">{{ horse.weight or '-' }}kg</td>
                    <td class="px-4 py-3 text-center text-glory-gold-400">
                        {% if horse.odds %}${{ "%.2f"|format(horse.odds) }}{% else %}-{% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if horse.finish_position %}
                        <span class="px-2 py-1 rounded text-sm font-bold
                            {% if horse.finish_position == 1 %}pos-1st
                            {% elif horse.finish_position == 2 %}pos-2nd
                            {% elif horse.finish_position == 3 %}pos-3rd
                            {% else %}bg-gray-700{% endif %}">
                            {{ horse.finish_position }}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-8 text-center">
            <p class="text-muted mb-4">No horses imported yet.</p>
            <button @click="importHorses()" class="btn-outline">Import Horses</button>
        </div>
        {% endif %}
    </div>

    <!-- Picks -->
    {% if picks %}
    <div class="bg-card rounded-xl overflow-hidden">
        <div class="p-4 border-b border-glory-gold/10">
            <h2 class="text-lg font-display text-gold">User Picks ({{ picks|length }})</h2>
        </div>
        <table class="w-full">
            <thead class="bg-glory-green-800/50 text-sm text-secondary">
                <tr>
                    <th class="px-4 py-3 text-left">User</th>
                    <th class="px-4 py-3 text-left">Pick</th>
                    <th class="px-4 py-3 text-center">Points</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-glory-gold/10">
                {% for pick in picks %}
                <tr>
                    <td class="px-4 py-3">{{ pick.user.display_name }}</td>
                    <td class="px-4 py-3 font-semibold">{{ pick.horse.name }}</td>
                    <td class="px-4 py-3 text-center">
                        {% if pick.points_earned is not none %}
                        <span class="px-2 py-1 rounded text-sm font-bold
                            {% if pick.points_earned == 3 %}bg-form-1 text-glory-green-800
                            {% elif pick.points_earned == 2 %}bg-form-2 text-gray-800
                            {% elif pick.points_earned == 1 %}bg-form-3 text-gray-800
                            {% else %}bg-gray-700{% endif %}">
                            {{ pick.points_earned }}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Enter Results Link -->
    {% if race.status == 'closed' and race.horses %}
    <div class="bg-card rounded-xl p-6 text-center">
        <a href="/group1glory/admin/results/{{ race.id }}" class="btn-gold text-lg px-8">Enter Results</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function raceDetailApp() {
    return {
        race: {
            status: '{{ race.status }}',
        },
        importing: false,

        async importHorses() {
            this.importing = true;
            try {
                const response = await fetch('/group1glory/api/admin/races/{{ race.id }}/import-horses', {
                    method: 'POST',
                });
                const data = await response.json();

                if (response.ok) {
                    showToast(`Imported ${data.horses_added} horses!`, 'success');
                    window.location.reload();
                } else {
                    showToast(data.detail || 'Import failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            } finally {
                this.importing = false;
            }
        },

        async updateStatus(status) {
            try {
                const response = await fetch('/group1glory/api/admin/races/{{ race.id }}/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status }),
                });

                if (response.ok) {
                    showToast(`Status updated to ${status}`, 'success');
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            }
        },
    };
}
</script>
{% endblock %}
