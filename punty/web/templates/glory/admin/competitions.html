{% extends "glory/base.html" %}

{% block title %}Manage Competitions - Group One Glory{% endblock %}

{% block content %}
<div x-data="competitionsApp()" class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="font-display text-3xl font-bold text-g1-navy">Competitions</h1>
            <p class="text-gray-600">Create and manage tipping competitions</p>
        </div>
        <button @click="showCreateModal = true" class="btn-gold">Create Competition</button>
    </div>

    <!-- Competitions List -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        {% if competitions %}
        <table class="w-full">
            <thead class="bg-g1-green text-white text-sm">
                <tr>
                    <th class="px-6 py-4 text-left font-semibold">Name</th>
                    <th class="px-6 py-4 text-left font-semibold">Dates</th>
                    <th class="px-6 py-4 text-center font-semibold">Races</th>
                    <th class="px-6 py-4 text-center font-semibold">Status</th>
                    <th class="px-6 py-4 text-right font-semibold">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for comp in competitions %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 font-semibold text-g1-navy">{{ comp.name }}</td>
                    <td class="px-6 py-4 text-gray-600">
                        {{ comp.start_date.strftime('%d %b') }} - {{ comp.end_date.strftime('%d %b %Y') }}
                    </td>
                    <td class="px-6 py-4 text-center text-gray-700">{{ comp.races|length }}</td>
                    <td class="px-6 py-4 text-center">
                        {% if comp.is_active %}
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-semibold">Active</span>
                        {% else %}
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-semibold">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right space-x-3">
                        {% if not comp.is_active %}
                        <button @click="activateCompetition('{{ comp.id }}')" class="text-g1-green hover:text-g1-green-light font-semibold text-sm">
                            Activate
                        </button>
                        {% endif %}
                        <a href="/group1glory/admin/competitions/{{ comp.id }}" class="text-g1-gold hover:text-g1-gold-light font-semibold text-sm">
                            Manage
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="p-12 text-center">
            <div class="w-16 h-16 bg-g1-gold/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-g1-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
            </div>
            <p class="text-gray-500 mb-6">No competitions created yet.</p>
            <button @click="showCreateModal = true" class="btn-outline">Create Your First Competition</button>
        </div>
        {% endif %}
    </div>

    <!-- Import Races Section -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="font-display text-xl font-bold text-g1-navy mb-4">Import Race Calendar</h2>

        <!-- Method 1: Hardcoded (Recommended) -->
        <div class="bg-g1-gold/10 border-2 border-g1-gold/30 rounded-xl p-5 mb-6">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-g1-gold rounded-xl flex items-center justify-center text-2xl flex-shrink-0">üìÖ</div>
                <div class="flex-1">
                    <h3 class="font-bold text-g1-navy text-lg mb-1">Import Standard Calendar (Recommended)</h3>
                    <p class="text-gray-600 text-sm mb-3">
                        Import the standard Melbourne & Sydney Group 1 calendar for 2026. This includes all major races like Melbourne Cup, Cox Plate, Golden Slipper, etc.
                    </p>
                    <div class="flex flex-wrap gap-3">
                        <button @click="importHardcodedCalendar()" class="btn-gold flex items-center gap-2" :disabled="importingHardcoded">
                            <span x-show="!importingHardcoded">Import 2026 Calendar</span>
                            <span x-show="importingHardcoded"><span class="spinner"></span> Importing...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Method 2: Scrape (Fallback) -->
        <div class="border border-gray-200 rounded-xl p-5">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl flex-shrink-0">üîç</div>
                <div class="flex-1">
                    <h3 class="font-bold text-g1-navy text-lg mb-1">Scrape Racing Australia (Advanced)</h3>
                    <p class="text-gray-600 text-sm mb-3">
                        Try to scrape live data from Racing Australia. This may not always work due to website changes.
                    </p>
                    <button @click="scrapeCalendar()" class="btn-outline flex items-center gap-2" :disabled="scraping">
                        <span x-show="!scraping">Try Scraping</span>
                        <span x-show="scraping"><span class="spinner"></span> Scraping...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div x-show="scrapeResults || importResults" x-cloak class="mt-6 p-4 bg-g1-green/10 border border-g1-green/30 rounded-xl">
            <div x-show="scrapeResults" class="font-semibold text-g1-navy mb-2">
                Scrape found <span x-text="scrapeResults?.races_found || 0" class="text-g1-green font-bold"></span> races
            </div>
            <div x-show="importResults" class="font-semibold text-g1-green">
                <span x-text="importResults?.message"></span>
            </div>
            <div x-show="scrapeResults?.races?.length > 0" class="max-h-48 overflow-y-auto text-sm text-gray-600 space-y-1 mt-2">
                <template x-for="race in scrapeResults?.races || []">
                    <div x-text="`${race.race_name} - ${race.venue} (${race.distance}m)`"></div>
                </template>
            </div>
        </div>
    </div>

    <!-- Create Competition Modal -->
    <div x-show="showCreateModal" x-cloak class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div @click.away="showCreateModal = false" class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="font-display text-2xl font-bold text-g1-navy mb-6">Create Competition</h2>

            <form @submit.prevent="createCompetition()" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                    <input type="text" x-model="newComp.name" required class="input-modern" placeholder="e.g., Autumn Carnival 2026">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                        <input type="date" x-model="newComp.start_date" required class="input-modern">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                        <input type="date" x-model="newComp.end_date" required class="input-modern">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Prize Pool (optional, in dollars)</label>
                    <input type="number" x-model="newComp.prize_pool" class="input-modern" placeholder="0">
                </div>

                <div class="flex gap-3 justify-end pt-4">
                    <button type="button" @click="showCreateModal = false" class="btn-outline">Cancel</button>
                    <button type="submit" class="btn-gold">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function competitionsApp() {
    return {
        showCreateModal: false,
        scraping: false,
        scrapeResults: null,
        importingHardcoded: false,
        importResults: null,
        newComp: {
            name: '',
            start_date: '',
            end_date: '',
            prize_pool: null,
        },

        async createCompetition() {
            try {
                const response = await fetch('/group1glory/api/admin/competitions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: this.newComp.name,
                        start_date: this.newComp.start_date,
                        end_date: this.newComp.end_date,
                        prize_pool: this.newComp.prize_pool ? parseInt(this.newComp.prize_pool) * 100 : null,
                    }),
                });

                if (response.ok) {
                    showToast('Competition created!', 'success');
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to create competition', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            }
        },

        async activateCompetition(id) {
            try {
                const response = await fetch(`/group1glory/api/admin/competitions/${id}/activate`, {
                    method: 'POST',
                });

                if (response.ok) {
                    showToast('Competition activated!', 'success');
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast(data.detail || 'Failed to activate', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            }
        },

        async scrapeCalendar() {
            this.scraping = true;
            this.importResults = null;
            try {
                const response = await fetch('/group1glory/api/admin/scrape-calendar', {
                    method: 'POST',
                });
                const data = await response.json();

                if (response.ok) {
                    this.scrapeResults = data;
                    showToast(`Found ${data.races_found} races!`, 'success');
                } else {
                    showToast(data.detail || 'Scrape failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            } finally {
                this.scraping = false;
            }
        },

        async importHardcodedCalendar() {
            // Need a competition to import into
            const competitions = document.querySelectorAll('table tbody tr');
            if (competitions.length === 0) {
                showToast('Create a competition first!', 'warning');
                return;
            }

            // Get the first (most recent) competition ID from the Manage link
            const manageLinks = document.querySelectorAll('a[href*="/admin/competitions/"]');
            if (manageLinks.length === 0) {
                showToast('Create a competition first!', 'warning');
                return;
            }

            const href = manageLinks[0].getAttribute('href');
            const competitionId = href.split('/').pop();

            this.importingHardcoded = true;
            this.scrapeResults = null;
            try {
                const response = await fetch(`/group1glory/api/admin/import-hardcoded-calendar?competition_id=${competitionId}`, {
                    method: 'POST',
                });
                const data = await response.json();

                if (response.ok) {
                    this.importResults = data;
                    showToast(data.message || `Imported ${data.races_imported} races!`, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast(data.detail || 'Import failed', 'error');
                }
            } catch (err) {
                showToast('An error occurred', 'error');
            } finally {
                this.importingHardcoded = false;
            }
        },
    };
}
</script>
{% endblock %}
