{% extends "base.html" %}

{% block title %}{{ meeting.venue }} - {{ meeting.date }} - PuntyAI{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-2">
        <div>
            <nav class="text-sm mb-2" style="color: var(--text-muted);">
                <a href="/meets" class="hover:text-punty-coral" style="color: var(--text-secondary);">Meets</a> /
                <span>{{ meeting.venue }}</span>
            </nav>
            <!-- Meeting Selector Dropdown -->
            <div class="relative inline-block">
                <select id="meeting-selector" onchange="switchMeeting(this.value)"
                        style="font-family: Orbitron, sans-serif; font-size: 1.8rem; font-weight: 700; letter-spacing: 1px;
                               background: transparent; border: none; color: var(--text-primary);
                               cursor: pointer; appearance: none; padding-right: 2rem;"
                        class="hover:text-punty-coral focus:outline-none">
                    {% for m in all_meetings %}
                    <option value="{{ m.id }}" {% if m.id == meeting.id %}selected{% endif %}
                            style="background: var(--bg-card); color: var(--text-primary); font-size: 1rem;">
                        {{ m.venue }}
                    </option>
                    {% endfor %}
                </select>
                <span style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--magenta);">&#x25BC;</span>
            </div>
            <div class="flex flex-wrap gap-4 mt-1" style="font-family: Rajdhani, sans-serif; font-size: 0.9rem; color: var(--text-secondary);">
                <span>{{ meeting.date.strftime('%A, %d %B %Y') if meeting.date else '' }}</span>
                {% if meeting.track_condition %}
                <span style="color: var(--cyan); font-weight: 600;">{{ meeting.track_condition }}</span>
                {% endif %}
                {% if meeting.weather_condition %}
                <span style="color: var(--yellow);">{{ meeting.weather_condition }}</span>
                {% elif meeting.weather %}
                <span style="color: var(--yellow);">{{ meeting.weather }}</span>
                {% endif %}
                {% if meeting.weather_temp %}
                <span>{{ meeting.weather_temp }}&deg;C</span>
                {% endif %}
            </div>
        </div>
        <!-- Race 1 Countdown -->
        {% set first_race = meeting.races|sort(attribute='race_number')|first if meeting.races else none %}
        {% if first_race and first_race.start_time %}
        <div class="text-right" style="font-family: Orbitron, sans-serif;">
            <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Race 1</div>
            <div class="text-lg font-bold" style="color: var(--cyan);">{{ first_race.start_time.strftime('%H:%M') }}</div>
            <div id="race1-countdown" class="race-countdown text-sm font-mono" style="color: var(--magenta);" data-start-time="{{ first_race.start_time|melb_iso }}"></div>
        </div>
        {% endif %}
    </div>

    <!-- Data Incomplete Warning Banner -->
    {% if meeting.speed_map_complete == false %}
    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 flex items-start gap-3">
        <span class="text-2xl">⚠️</span>
        <div>
            <h3 class="font-semibold text-red-400">Speed Map Data Incomplete</h3>
            <p class="text-sm text-red-300/80 mt-1">
                This meeting has missing or incomplete speed map data. Generating Early Mail may result in
                inaccurate pace analysis and race shape predictions.
            </p>
            <p class="text-sm text-red-300/80 mt-1">
                Try clicking "Fetch Speed Maps" again, or proceed with caution.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px;" class="p-3 sm:p-4 flex flex-wrap gap-2 sm:gap-3">
        <button onclick="startScrape()" id="scrape-btn"
                class="bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50">
            &#x1F504; Scrape All Data
        </button>
        <button onclick="startSpeedMaps()" id="speedmap-btn"
                class="bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50">
            &#x1F3C3; Fetch Speed Maps
        </button>
        <button onclick="startGenerate()" id="generate-btn"
                class="bg-punty-coral text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-punty-coral/90 text-sm">
            &#x1F4E7; Generate Early Mail
        </button>
        <button onclick="checkResults()" id="results-btn"
                class="bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50">
            &#x1F3C6; Check Results
        </button>
        <button onclick="startPuntReview()" id="puntreview-btn"
                class="bg-punty-coral text-white px-4 py-2 rounded-lg hover:bg-punty-coral/90">
            &#x1F4CA; Generate Punt Review
        </button>
        <button onclick="preRaceScrape()" id="prerace-btn"
                class="bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50">
            &#x23F1; Pre-Race Refresh
        </button>
        <button onclick="toggleMonitor()" id="monitor-btn"
                class="bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50">
            &#x1F50D; Start Monitor
        </button>
    </div>

    <!-- Scrape Progress -->
    <div id="scrape-progress" class="hidden rounded-lg shadow p-4 space-y-3" style="background: var(--bg-card);">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold" style="color: var(--text-primary);">Scraping Data</h3>
            <div class="flex items-center gap-3">
                <span id="progress-pct" class="text-sm" style="color: var(--text-secondary);">0%</span>
                <button id="scrape-cancel" onclick="cancelProcess('scrape')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">Cancel</button>
            </div>
        </div>
        <div class="w-full rounded-full h-3" style="background: var(--bg-card-alt);">
            <div id="progress-bar" class="bg-punty-coral h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="progress-log" class="text-sm space-y-1 max-h-48 overflow-y-auto font-mono"></div>
    </div>

    <!-- Generate Progress -->
    <div id="generate-progress" class="hidden rounded-lg shadow p-4 space-y-3" style="background: var(--bg-card);">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold" style="color: var(--text-primary);">Generating Early Mail</h3>
            <div class="flex items-center gap-3">
                <span id="generate-pct" class="text-sm" style="color: var(--text-secondary);">0%</span>
                <button id="generate-cancel" onclick="cancelProcess('generate')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">Cancel</button>
            </div>
        </div>
        <div class="w-full rounded-full h-3" style="background: var(--bg-card-alt);">
            <div id="generate-bar" class="bg-punty-coral h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="generate-log" class="text-sm space-y-1 max-h-48 overflow-y-auto font-mono"></div>
    </div>

    <!-- Punt Review Progress -->
    <div id="puntreview-progress" class="hidden rounded-lg shadow p-4 space-y-3" style="background: var(--bg-card);">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold" style="color: var(--text-primary);">Generating Punt Review</h3>
            <div class="flex items-center gap-3">
                <span id="puntreview-pct" class="text-sm" style="color: var(--text-secondary);">0%</span>
                <button id="puntreview-cancel" onclick="cancelProcess('puntreview')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">Cancel</button>
            </div>
        </div>
        <div class="w-full rounded-full h-3" style="background: var(--bg-card-alt);">
            <div id="puntreview-bar" class="bg-punty-gold h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="puntreview-log" class="text-sm space-y-1 max-h-48 overflow-y-auto font-mono"></div>
    </div>

    <!-- Speed Map Progress -->
    <div id="speedmap-progress" class="hidden rounded-lg shadow p-4 space-y-3" style="background: var(--bg-card);">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold" style="color: var(--text-primary);">Fetching Speed Maps</h3>
            <div class="flex items-center gap-3">
                <span id="speedmap-pct" class="text-sm" style="color: var(--text-secondary);">0%</span>
                <button id="speedmap-cancel" onclick="cancelProcess('speedmap')" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">Cancel</button>
            </div>
        </div>
        <div class="w-full rounded-full h-3" style="background: var(--bg-card-alt);">
            <div id="speedmap-bar" class="bg-punty-coral h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="speedmap-log" class="text-sm space-y-1 max-h-48 overflow-y-auto font-mono"></div>
    </div>

    <!-- Results Progress -->
    <div id="results-progress" class="hidden rounded-lg shadow p-4 space-y-3" style="background: var(--bg-card);">
        <div class="flex items-center justify-between">
            <h3 class="font-semibold" style="color: var(--text-primary);">Checking Results</h3>
            <div class="flex items-center gap-3">
                <span id="results-status" class="text-sm text-gray-500">
                    <span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin align-middle"></span>
                    Checking...
                </span>
                <button id="results-cancel" onclick="cancelResults()" class="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors">Cancel</button>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="results-bar" class="bg-punty-coral h-3 rounded-full transition-all duration-500 animate-pulse" style="width: 100%"></div>
        </div>
        <div id="results-log" class="text-sm space-y-1 max-h-48 overflow-y-auto font-mono"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Races -->
        <div class="lg:col-span-2">
            <div style="background: var(--bg-card);" class="rounded-lg shadow">
                <div class="px-6 py-4" style="border-bottom: 1px solid var(--border-subtle);">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">
                        Races ({{ meeting.races|length }})
                    </h2>
                </div>
                <div style="border-color: var(--border-subtle);" class="divide-y">
                    {% for race in meeting.races|sort(attribute='race_number') %}
                    <div class="p-6" x-data="{ open: false, detail: null }">
                        <div class="flex justify-between items-start cursor-pointer" @click="open = !open">
                            <div>
                                <div class="flex items-center space-x-3">
                                    <span class="race-num-pill">
                                        {{ race.race_number }}
                                    </span>
                                    <div>
                                        <h3 style="font-family: Rajdhani, sans-serif; font-size: 1.05rem; font-weight: 700;">{{ race.name }}</h3>
                                        <div class="flex flex-wrap gap-1.5 mt-1">
                                            <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.05); color: var(--text-secondary);">{{ race.distance }}m</span>
                                            <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.05); color: var(--text-secondary);">{{ race.class_ or 'Open' }}</span>
                                            {% if race.prize_money %}<span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.05); color: var(--text-secondary);">${{ "{:,}".format(race.prize_money) }}</span>{% endif %}
                                            {% if race.weight_type %}<span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.05); color: var(--text-secondary);">{{ race.weight_type }}</span>{% endif %}
                                        </div>
                                        {% if race.track_condition %}
                                        <p class="text-xs text-gray-400">Track: {{ race.track_condition }}{% if race.field_size %} | Field: {{ race.field_size }}{% endif %}</p>
                                        {% endif %}
                                        {% set active_runners = race.runners|rejectattr('scratched')|list %}
                                        {% set runners_with_speedmap = active_runners|selectattr('speed_map_position')|list %}
                                        {% if active_runners and runners_with_speedmap|length == 0 %}
                                        <span class="inline-block mt-1 px-2 py-0.5 text-xs rounded bg-red-500/20 text-red-400 border border-red-500/30">
                                            ⚠ No Speed Map Data
                                        </span>
                                        {% elif active_runners and runners_with_speedmap|length < (active_runners|length * 0.5) %}
                                        <span class="inline-block mt-1 px-2 py-0.5 text-xs rounded bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
                                            ⚠ Partial Speed Map ({{ runners_with_speedmap|length }}/{{ active_runners|length }})
                                        </span>
                                        {% endif %}
                                        {% if race.results_status %}
                                        {% set rs_colors = {
                                            'Open': 'bg-blue-100 text-blue-700',
                                            'Closed': 'bg-gray-100 text-gray-700',
                                            'Interim': 'bg-yellow-100 text-yellow-700',
                                            'Paying': 'bg-green-100 text-green-700',
                                            'Abandoned': 'bg-red-100 text-red-700'
                                        } %}
                                        <span class="inline-block mt-1 px-2 py-0.5 text-xs rounded {{ rs_colors.get(race.results_status, 'bg-gray-100') }}">
                                            {{ race.results_status }}
                                        </span>
                                        {% if race.winning_time %}
                                        <span class="text-xs text-gray-400 ml-2">Time: {{ race.winning_time }}</span>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                {% if race.start_time %}
                                <span style="font-family: Orbitron, sans-serif; font-size: 1.1rem; font-weight: 600; color: var(--cyan);">{{ race.start_time.strftime('%H:%M') }}</span>
                                {% endif %}
                                {% if race_previews_enabled %}
                                <button hx-post="/api/content/generate"
                                        hx-ext="json-enc"
                                        hx-vals='{"meeting_id": "{{ meeting.id }}", "content_type": "race_preview", "race_id": "{{ race.id }}"}'
                                        hx-swap="none"
                                        hx-on::after-request="if(event.detail.successful) showToast('Preview generated', 'success'); else showToast('Failed', 'error');"
                                        class="text-punty-coral hover:underline text-sm"
                                        @click.stop>
                                    Generate Preview
                                </button>
                                {% endif %}
                                <span class="text-gray-400" x-text="open ? '&#x25B2;' : '&#x25BC;'"></span>
                            </div>
                        </div>

                        <!-- Picks Banner -->
                        {% set race_picks = picks_by_race.get(race.race_number, []) %}
                        {% set selections = race_picks|selectattr('pick_type', 'equalto', 'selection')|list %}
                        {% set exotics = race_picks|selectattr('pick_type', 'equalto', 'exotic')|list %}
                        {% set race_sequences = sequences_by_race.get(race.race_number, []) %}
                        {% if selections or exotics or race_sequences %}
                        <div style="background: var(--bg-card-alt); border-top: 1px solid var(--border-subtle);" class="mt-0 px-4 py-2.5">
                            <div class="flex flex-wrap items-center gap-2" style="font-family: Rajdhani, sans-serif;">
                                {% for pick in selections|sort(attribute='tip_rank') %}
                                {% set rank_labels = {1: 'TOP', 2: '2nd', 3: '3rd', 4: 'Roughie'} %}
                                {% set rank_styles = {1: 'pick-top', 2: 'pick-2nd', 3: 'pick-3rd', 4: 'pick-roughie'} %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold {{ rank_styles.get(pick.tip_rank, 'pick-2nd') }}">
                                    {% if pick.tip_rank == 1 %}&#9733; {% endif %}{{ rank_labels.get(pick.tip_rank, '#' ~ pick.tip_rank) }}:
                                    #{{ pick.saddlecloth }} {{ pick.horse_name }}
                                    {% set display_odds = pick.place_odds_at_tip if pick.bet_type == 'place' else pick.odds_at_tip %}
                                    {% if display_odds %}${{ "%.2f"|format(display_odds) }}{% endif %}
                                    {% if pick.win_probability %}
                                        {% set prob_pct = (pick.win_probability * 100)|round(0)|int %}
                                        <span style="background:{% if prob_pct >= 30 %}#166534{% elif prob_pct >= 15 %}#0e7490{% elif prob_pct >= 8 %}#a16207{% else %}#6b7280{% endif %};color:#fff;padding:0 4px;border-radius:3px;font-size:0.65rem;">{{ prob_pct }}%</span>
                                    {% endif %}
                                    {% if pick.value_rating and pick.value_rating > 1.05 %}
                                        <span style="color:#4ade80;font-size:0.65rem;" title="Value: {{ '%.2f'|format(pick.value_rating) }}x">VALUE</span>
                                    {% endif %}
                                    {% if pick.bet_stake %}<span style="opacity:0.8;">${{ "%.0f"|format(pick.bet_stake) }} {{ (pick.bet_type or 'win')|replace('_', ' ')|title }}</span>{% endif %}
                                    {% if pick.settled %}
                                        {% if pick.hit %}<span style="color:#4ade80;">&#10003;</span>{% else %}<span style="color:#f87171;">&#10007;</span>{% endif %}
                                    {% endif %}
                                </span>
                                {% endfor %}
                                {% for pick in exotics %}
                                {% set runners = pick.exotic_runners|fromjson if pick.exotic_runners else [] %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold pick-exotic">
                                    {{ pick.exotic_type or 'Exotic' }}: {% if runners and runners[0] is sequence and runners[0] is not string %}{% for leg in runners %}{{ leg|join(', ') }}{% if not loop.last %} / {% endif %}{% endfor %}{% else %}{{ runners|join(', ') }}{% endif %}
                                    {% if pick.exotic_stake %}&bull; ${{ "%.0f"|format(pick.exotic_stake) }}{% endif %}
                                    {% if pick.estimated_return_pct %}({{ "%.0f"|format(pick.estimated_return_pct) }}%){% endif %}
                                    {% if pick.settled %}
                                        {% if pick.hit %}<span style="color:#4ade80;">&#10003;</span>{% else %}<span style="color:#f87171;">&#10007;</span>{% endif %}
                                    {% endif %}
                                </span>
                                {% endfor %}
                                {% for seq in race_sequences %}
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold pick-sequence">
                                    {{ seq.label }} Leg {{ seq.leg_index + 1 }}: {{ seq.saddlecloths|join(', ') }}
                                    {% if seq.pick.exotic_stake %}&bull; ${{ "%.2f"|format(seq.pick.exotic_stake) }}/combo{% endif %}
                                    {% if seq.pick.estimated_return_pct %}({{ "%.0f"|format(seq.pick.estimated_return_pct) }}%){% endif %}
                                    {% if seq.pick.settled %}
                                        {% if seq.pick.hit %}<span style="color:#4ade80;">&#10003;</span>{% else %}<span style="color:#f87171;">&#10007;</span>{% endif %}
                                    {% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Runners -->
                        <div x-show="open" x-collapse class="mt-4 overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">No</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Horse</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Jockey</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Wt</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Form</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Speed</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Odds</th>
                                        {% if race.results_status and race.results_status in ('Paying', 'Closed', 'Interim') %}
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Pos</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Margin</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">SP</th>
                                        {% endif %}
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500"></th>
                                    </tr>
                                </thead>
                                    {% for runner in race.runners|sort(attribute='saddlecloth') %}
                                <tbody class="divide-y divide-gray-100" x-data="{ expanded: false }">
                                    <tr class="{{ 'line-through text-gray-400' if runner.scratched else '' }}">
                                        <td class="px-3 py-2">{{ runner.saddlecloth or runner.barrier }}</td>
                                        <td class="px-3 py-2 font-medium">
                                            {{ runner.horse_name }}
                                            {% if runner.scratched %}
                                            <span class="text-red-500 text-xs">(SCR)</span>
                                            {% endif %}
                                            {% if runner.horse_age and runner.horse_sex and not runner.scratched %}
                                            <span class="text-xs text-gray-400">{{ runner.horse_age }}yo {{ runner.horse_sex[0] if runner.horse_sex else '' }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-3 py-2 text-xs">{{ runner.jockey or '-' }}</td>
                                        <td class="px-3 py-2">{{ runner.weight or '-' }}</td>
                                        <td class="px-3 py-2 font-mono text-xs">{{ runner.last_five or runner.form or '-' }}</td>
                                        <td class="px-3 py-2">
                                            {% if runner.speed_map_position %}
                                            {% set pos_colors = {
                                                'leader': 'bg-red-100 text-red-700',
                                                'on_pace': 'bg-orange-100 text-orange-700',
                                                'midfield': 'bg-yellow-100 text-yellow-700',
                                                'backmarker': 'bg-blue-100 text-blue-700'
                                            } %}
                                            <span class="px-2 py-0.5 text-xs rounded {{ pos_colors.get(runner.speed_map_position, 'bg-gray-100') }}">
                                                {{ runner.speed_map_position|replace('_', ' ')|title }}
                                            </span>
                                            {% else %}
                                            <span class="text-gray-400">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-3 py-2">
                                            {% if runner.current_odds %}
                                            ${{ "%.2f"|format(runner.current_odds) }}
                                            {% if runner.opening_odds and runner.current_odds != runner.opening_odds %}
                                            <span class="text-xs {{ 'text-green-600' if runner.current_odds < runner.opening_odds else 'text-red-600' }}">
                                                ({{ "%.2f"|format(runner.opening_odds) }})
                                            </span>
                                            {% endif %}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        {% if race.results_status and race.results_status in ('Paying', 'Closed', 'Interim') %}
                                        <td class="px-3 py-2 font-bold">
                                            {% if runner.finish_position %}
                                            {% if runner.finish_position == 1 %}
                                            <span class="text-green-700">1st</span>
                                            {% elif runner.finish_position == 2 %}
                                            <span class="text-blue-700">2nd</span>
                                            {% elif runner.finish_position == 3 %}
                                            <span class="text-amber-700">3rd</span>
                                            {% else %}
                                            {{ runner.finish_position }}
                                            {% endif %}
                                            {% else %}-{% endif %}
                                        </td>
                                        <td class="px-3 py-2 text-xs">{{ runner.result_margin or '-' }}</td>
                                        <td class="px-3 py-2 text-xs">{{ runner.starting_price or '-' }}</td>
                                        {% endif %}
                                        <td class="px-3 py-2">
                                            {% if not runner.scratched %}
                                            <button @click.stop="expanded = !expanded" class="text-xs text-punty-coral hover:underline">
                                                <span x-text="expanded ? 'Less' : 'More'"></span>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <!-- Expandable detail row -->
                                    {% if not runner.scratched %}
                                    <tr x-show="expanded" x-collapse class="bg-gray-50">
                                        <td colspan="11" class="px-3 py-3">
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                                                <!-- Pedigree -->
                                                {% if runner.sire %}
                                                <div>
                                                    <span class="text-gray-500">Sire:</span>
                                                    <span class="font-medium">{{ runner.sire }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.dam %}
                                                <div>
                                                    <span class="text-gray-500">Dam:</span>
                                                    <span class="font-medium">{{ runner.dam }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Trainer -->
                                                {% if runner.trainer %}
                                                <div>
                                                    <span class="text-gray-500">Trainer:</span>
                                                    <span class="font-medium">{{ runner.trainer }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Handicap Rating -->
                                                {% if runner.handicap_rating %}
                                                <div>
                                                    <span class="text-gray-500">HC Rating:</span>
                                                    <span class="font-medium">{{ runner.handicap_rating }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Career -->
                                                {% if runner.career_record %}
                                                <div>
                                                    <span class="text-gray-500">Career:</span>
                                                    <span class="font-medium">{{ runner.career_record }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.career_prize_money %}
                                                <div>
                                                    <span class="text-gray-500">Prize $:</span>
                                                    <span class="font-medium">${{ "{:,}".format(runner.career_prize_money) }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.days_since_last_run is not none %}
                                                <div>
                                                    <span class="text-gray-500">Days since run:</span>
                                                    <span class="font-medium">{{ runner.days_since_last_run }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Stats -->
                                                {% if runner.track_dist_stats %}
                                                <div>
                                                    <span class="text-gray-500">Trk/Dist:</span>
                                                    <span class="font-medium">{{ runner.track_dist_stats }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.track_stats %}
                                                <div>
                                                    <span class="text-gray-500">Track:</span>
                                                    <span class="font-medium">{{ runner.track_stats }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.distance_stats %}
                                                <div>
                                                    <span class="text-gray-500">Distance:</span>
                                                    <span class="font-medium">{{ runner.distance_stats }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.first_up_stats %}
                                                <div>
                                                    <span class="text-gray-500">1st Up:</span>
                                                    <span class="font-medium">{{ runner.first_up_stats }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.second_up_stats %}
                                                <div>
                                                    <span class="text-gray-500">2nd Up:</span>
                                                    <span class="font-medium">{{ runner.second_up_stats }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Gear -->
                                                {% if runner.gear %}
                                                <div class="col-span-2">
                                                    <span class="text-gray-500">Gear:</span>
                                                    <span class="font-medium">{{ runner.gear }}</span>
                                                </div>
                                                {% endif %}
                                                {% if runner.gear_changes %}
                                                <div class="col-span-2">
                                                    <span class="text-gray-500">Gear Changes:</span>
                                                    <span class="font-medium text-amber-700">{{ runner.gear_changes }}</span>
                                                </div>
                                                {% endif %}
                                                <!-- Multi-provider odds -->
                                                {% if runner.odds_tab or runner.odds_sportsbet or runner.odds_bet365 or runner.odds_ladbrokes or runner.odds_betfair %}
                                                <div class="col-span-2 md:col-span-4">
                                                    <span style="color: var(--text-secondary);">Odds:</span>
                                                    {% if runner.odds_tab %}<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold" style="background: #00a651; color: #000;">TAB ${{ "%.2f"|format(runner.odds_tab) }}</span>{% endif %}
                                                    {% if runner.odds_sportsbet %}<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold" style="background: #ff6b00; color: #000;">SB ${{ "%.2f"|format(runner.odds_sportsbet) }}</span>{% endif %}
                                                    {% if runner.odds_bet365 %}<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold" style="background: #ffdf00; color: #000;">B365 ${{ "%.2f"|format(runner.odds_bet365) }}</span>{% endif %}
                                                    {% if runner.odds_ladbrokes %}<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold" style="background: #ec1c24; color: #fff;">LAD ${{ "%.2f"|format(runner.odds_ladbrokes) }}</span>{% endif %}
                                                    {% if runner.odds_betfair %}<span class="ml-1 px-1.5 py-0.5 rounded text-xs font-semibold" style="background: #ffb80c; color: #000;">BF ${{ "%.2f"|format(runner.odds_betfair) }}</span>{% endif %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <!-- Comments -->
                                            {% if runner.comment_long %}
                                            <div class="mt-2 text-xs text-gray-600 italic border-t border-gray-200 pt-2">
                                                {{ runner.comment_long }}
                                            </div>
                                            {% endif %}
                                            {% if runner.stewards_comment %}
                                            <div class="mt-1 text-xs text-red-600">
                                                <span class="font-medium">Stewards:</span> {{ runner.stewards_comment }}
                                            </div>
                                            {% endif %}
                                            <!-- Extended Form History -->
                                            {% if runner.form_history %}
                                            {% set form_runs = runner.form_history|fromjson if runner.form_history is string else runner.form_history %}
                                            {% if form_runs and form_runs|length > 0 %}
                                            <div class="mt-3 border-t border-gray-200 pt-2" x-data="{ showForm: false }">
                                                <button @click="showForm = !showForm" class="flex items-center gap-1 text-xs font-medium text-punty-coral hover:underline">
                                                    <svg x-show="!showForm" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                    </svg>
                                                    <svg x-show="showForm" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                    </svg>
                                                    Extended Form ({{ form_runs|length }} runs)
                                                </button>
                                                <div x-show="showForm" x-collapse class="mt-2 overflow-x-auto">
                                                    <table class="min-w-full text-xs">
                                                        <thead class="bg-gray-700/50">
                                                            <tr>
                                                                <th class="px-2 py-1 text-left font-medium text-gray-300">Date</th>
                                                                <th class="px-2 py-1 text-left font-medium text-gray-300">Venue</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">Dist</th>
                                                                <th class="px-2 py-1 text-left font-medium text-gray-300">Class</th>
                                                                <th class="px-2 py-1 text-center font-medium text-gray-300">Track</th>
                                                                <th class="px-2 py-1 text-center font-medium text-gray-300">Fld</th>
                                                                <th class="px-2 py-1 text-center font-medium text-gray-300">Pos</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">Marg</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">Wgt</th>
                                                                <th class="px-2 py-1 text-left font-medium text-gray-300">Jockey</th>
                                                                <th class="px-2 py-1 text-center font-medium text-gray-300">Bar</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">SP</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">800m</th>
                                                                <th class="px-2 py-1 text-right font-medium text-gray-300">400m</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="divide-y divide-gray-700/30">
                                                            {% for run in form_runs %}
                                                            <tr class="hover:bg-gray-700/20">
                                                                <td class="px-2 py-1 whitespace-nowrap text-gray-300">{% if run.date %}{{ run.date[8:10] }}-{{ run.date[5:7] }}-{{ run.date[2:4] }}{% else %}-{% endif %}</td>
                                                                <td class="px-2 py-1 whitespace-nowrap font-medium text-gray-200">{{ run.venue or '-' }}</td>
                                                                <td class="px-2 py-1 text-right text-gray-300">{{ run.distance or '-' }}</td>
                                                                <td class="px-2 py-1 whitespace-nowrap text-gray-300">{% if run.class %}{{ run.class }}{% elif runner.career_record and runner.career_record.split(':')[1].split('-')[0] == '0' %}MDN{% else %}-{% endif %}</td>
                                                                <td class="px-2 py-1 text-center">
                                                                    {% if run.track %}
                                                                    <span class="px-1.5 py-0.5 rounded text-[10px] font-semibold
                                                                        {% if 'Heavy' in run.track %}bg-blue-500/80 text-white
                                                                        {% elif 'Soft' in run.track %}bg-emerald-500/80 text-white
                                                                        {% elif 'Good' in run.track %}bg-gray-500/80 text-white
                                                                        {% else %}bg-gray-600/80 text-gray-200{% endif %}">
                                                                        {{ run.track }}
                                                                    </span>
                                                                    {% else %}-{% endif %}
                                                                </td>
                                                                <td class="px-2 py-1 text-center text-gray-300">{{ run.field or '-' }}</td>
                                                                <td class="px-2 py-1 text-center">
                                                                    {% if run.pos %}
                                                                    <span class="px-1.5 py-0.5 rounded text-[10px] font-bold
                                                                        {% if run.pos == '1' %}bg-yellow-500 text-yellow-900
                                                                        {% elif run.pos in ['2', '3'] %}bg-emerald-500/80 text-white
                                                                        {% else %}bg-gray-600/80 text-gray-200{% endif %}">
                                                                        {{ run.pos }}
                                                                    </span>
                                                                    {% else %}-{% endif %}
                                                                </td>
                                                                <td class="px-2 py-1 text-right text-gray-300">{{ run.margin or '-' }}</td>
                                                                <td class="px-2 py-1 text-right text-gray-300">{{ run.weight or '-' }}</td>
                                                                <td class="px-2 py-1 whitespace-nowrap text-gray-300">{{ run.jockey or '-' }}</td>
                                                                <td class="px-2 py-1 text-center text-gray-300">{{ run.barrier or '-' }}</td>
                                                                <td class="px-2 py-1 text-right font-medium text-gray-200">{{ run.sp or '-' }}</td>
                                                                <td class="px-2 py-1 text-right text-gray-400">{{ run.at800 or '-' }}</td>
                                                                <td class="px-2 py-1 text-right text-gray-400">{{ run.at400 or '-' }}</td>
                                                            </tr>
                                                            {% if run.comment %}
                                                            <tr class="bg-gray-800/30">
                                                                <td colspan="14" class="px-2 py-1 text-[10px] text-gray-400 italic">
                                                                    {{ run.comment }}
                                                                </td>
                                                            </tr>
                                                            {% endif %}
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <!-- Bottom separator after extended form -->
                                            <div class="mt-3 border-b-2 border-gray-600"></div>
                                            {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                                    {% else %}
                                <tbody>
                                    <tr>
                                        <td colspan="11" class="px-3 py-4 text-center text-gray-500">
                                            No runners loaded yet
                                        </td>
                                    </tr>
                                </tbody>
                                    {% endfor %}
                            </table>

                            <!-- Results & Dividends Panel -->
                            {% if race.results_status and race.results_status in ('Paying', 'Closed') %}
                            {% set placed_runners = race.runners|selectattr('finish_position')|sort(attribute='finish_position')|list %}
                            {% set winner = placed_runners|selectattr('finish_position', 'equalto', 1)|first %}
                            {% set second = placed_runners|selectattr('finish_position', 'equalto', 2)|first %}
                            {% set third = placed_runners|selectattr('finish_position', 'equalto', 3)|first %}
                            {% set fourth = placed_runners|selectattr('finish_position', 'equalto', 4)|first %}
                            <div class="mt-4 bg-gray-50 rounded-lg border border-gray-200">
                                <!-- Placings -->
                                <div class="border-b border-gray-200">
                                    <div class="px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-500 uppercase flex">
                                        <span class="w-10">Pos</span>
                                        <span class="flex-1">Runner</span>
                                        <span class="w-16 text-right">Win</span>
                                        <span class="w-16 text-right">Place</span>
                                    </div>
                                    {% set pos_labels = {1: '1st', 2: '2nd', 3: '3rd', 4: '4th'} %}
                                    {% set pos_colors = {1: 'text-green-700 font-bold', 2: 'text-blue-600 font-semibold', 3: 'text-amber-600 font-semibold', 4: 'text-gray-600'} %}
                                    {% for r in [winner, second, third, fourth] if r %}
                                    <div class="px-4 py-1.5 flex items-center text-sm {{ 'bg-green-50' if r.finish_position == 1 else '' }}">
                                        <span class="w-10 {{ pos_colors.get(r.finish_position, 'text-gray-600') }}">{{ pos_labels.get(r.finish_position, r.finish_position) }}</span>
                                        <span class="flex-1">
                                            <span class="font-medium {{ 'text-gray-900' if r.finish_position <= 2 else 'text-gray-700' }}">{{ r.saddlecloth }}. {{ r.horse_name|upper }}</span>
                                            <span class="text-xs text-gray-400 ml-1">{{ r.jockey or '' }}</span>
                                            {% if r.result_margin and r.finish_position > 1 %}
                                            <span class="text-xs text-gray-400 ml-1">({{ r.result_margin }})</span>
                                            {% endif %}
                                        </span>
                                        <span class="w-16 text-right font-medium">{% if r.finish_position == 1 and r.win_dividend %}${{ "%.2f"|format(r.win_dividend) }}{% endif %}</span>
                                        <span class="w-16 text-right text-gray-600">{% if r.place_dividend %}${{ "%.2f"|format(r.place_dividend) }}{% endif %}</span>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Exotic Dividends -->
                                {% if race.exotic_results %}
                                {% set exr = race.exotic_results|fromjson %}
                                {% if exr %}
                                {% set p1 = winner.saddlecloth if winner else '?' %}
                                {% set p2 = second.saddlecloth if second else '?' %}
                                {% set p3 = third.saddlecloth if third else '?' %}
                                {% set p4 = fourth.saddlecloth if fourth else '?' %}
                                {% set exotic_info = {
                                    'quinella': {'label': 'Quinella', 'result': p1 ~ '-' ~ p2},
                                    'exacta': {'label': 'Exacta', 'result': p1 ~ '-' ~ p2},
                                    'trifecta': {'label': 'Trifecta', 'result': p1 ~ '-' ~ p2 ~ '-' ~ p3},
                                    'trifecta 1': {'label': 'Trifecta (1)', 'result': p1 ~ '-' ~ p2 ~ '-' ~ p3},
                                    'trifecta 2': {'label': 'Trifecta (2)', 'result': p1 ~ '-' ~ p2 ~ '-' ~ p3},
                                    'first4': {'label': 'First 4', 'result': p1 ~ '-' ~ p2 ~ '-' ~ p3 ~ '-' ~ p4},
                                    'first_4': {'label': 'First 4', 'result': p1 ~ '-' ~ p2 ~ '-' ~ p3 ~ '-' ~ p4}
                                } %}
                                <div class="border-b border-gray-200">
                                    <div class="px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-500 uppercase flex">
                                        <span class="flex-1">Exotic Results</span>
                                        <span class="w-20 text-right">Results</span>
                                        <span class="w-20 text-right">Dividend</span>
                                    </div>
                                    {% for etype in ['quinella', 'exacta', 'trifecta', 'trifecta 1', 'trifecta 2', 'first4', 'first_4'] %}
                                    {% if exr.get(etype) %}
                                    {% set elabel = exotic_info.get(etype, {'label': etype|title, 'result': ''}) %}
                                    <div class="px-4 py-1 flex text-sm">
                                        <span class="flex-1 text-gray-600">{{ elabel.label }}</span>
                                        <span class="w-20 text-right text-gray-500">{{ elabel.result }}</span>
                                        <span class="w-20 text-right font-medium">${{ "%.2f"|format(exr[etype]|float) }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                    {% for dkey in ['quinella place 1', 'quinella place 2', 'quinella place 3'] %}
                                    {% if exr.get(dkey) %}
                                    <div class="px-4 py-1 flex text-sm">
                                        <span class="flex-1 text-gray-600">Duet</span>
                                        <span class="w-20 text-right text-gray-500"></span>
                                        <span class="w-20 text-right font-medium">${{ "%.2f"|format(exr[dkey]|float) }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                    {% set seq_keys = [
                                        ('daily double', 'Daily Double'),
                                        ('treble', 'Treble'),
                                        ('early quaddie', 'Early Quaddie'),
                                        ('quaddie', 'Quaddie'),
                                        ('big6', 'Big 6'),
                                        ('big 6', 'Big 6'),
                                    ] %}
                                    {% for skey, slabel in seq_keys %}
                                    {% if exr.get(skey) %}
                                    <div class="px-4 py-1 flex text-sm">
                                        <span class="flex-1 text-amber-600 font-medium">{{ slabel }}</span>
                                        <span class="w-20 text-right text-gray-500"></span>
                                        <span class="w-20 text-right font-medium text-amber-600">${{ "%.2f"|format(exr[skey]|float) }}</span>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endif %}

                                <!-- Our Bets -->
                                {% set settled_selections = race_picks|selectattr('settled')|sort(attribute='pick_type', reverse=true)|list %}
                                {% set settled_sequences = [] %}
                                {% for seq in race_sequences %}
                                    {% set legs = seq.pick.sequence_legs|fromjson if seq.pick.sequence_legs else [] %}
                                    {% if seq.pick.settled and seq.leg_index == (legs|length - 1) %}
                                        {% if settled_sequences.append(seq) %}{% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if settled_selections or settled_sequences %}
                                <div>
                                    <div class="px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-500 uppercase">
                                        Our Bets
                                    </div>
                                    {% for pick in settled_selections %}
                                    {% set rank_labels = {1: 'Top 1', 2: 'Top 2', 3: 'Top 3', 4: 'Roughie'} %}
                                    <div class="px-4 py-1 flex justify-between items-center text-sm">
                                        <span class="text-gray-600">
                                            {% if pick.pick_type == 'selection' %}
                                            {{ rank_labels.get(pick.tip_rank, 'Pick') }}: #{{ pick.saddlecloth }} {{ pick.horse_name }}
                                            {% if pick.win_probability %}
                                                {% set prob_pct = (pick.win_probability * 100)|round(0)|int %}
                                                <span style="background:{% if prob_pct >= 30 %}#166534{% elif prob_pct >= 15 %}#0e7490{% elif prob_pct >= 8 %}#a16207{% else %}#6b7280{% endif %};color:#fff;padding:0 3px;border-radius:3px;font-size:0.7rem;">{{ prob_pct }}%</span>
                                            {% endif %}
                                            {% if pick.bet_stake %}<span class="text-gray-400">${{ "%.0f"|format(pick.bet_stake) }} {{ (pick.bet_type or 'win')|replace('_', ' ')|title }}</span>{% endif %}
                                            {% elif pick.pick_type == 'exotic' %}
                                            {% set runners = pick.exotic_runners|fromjson if pick.exotic_runners else [] %}
                                            {{ pick.exotic_type or 'Exotic' }}: {% if runners and runners[0] is sequence and runners[0] is not string %}{% for leg in runners %}{{ leg|join(', ') }}{% if not loop.last %} / {% endif %}{% endfor %}{% else %}{{ runners|join(', ') }}{% endif %}
                                            {% endif %}
                                        </span>
                                        {% if (pick.pnl or 0) > 0 %}
                                        <span class="font-semibold text-green-600">WON +${{ "%.2f"|format(pick.pnl) }}</span>
                                        {% elif (pick.pnl or 0) < 0 %}
                                        <span class="font-medium text-red-500">-${{ "%.2f"|format((pick.pnl)|abs) }}</span>
                                        {% else %}
                                        <span class="font-medium text-gray-500">$0.00</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                    {% for seq in settled_sequences %}
                                    <div class="px-4 py-1 flex justify-between items-center text-sm">
                                        <span class="text-gray-600">{{ seq.label }}</span>
                                        {% if (seq.pick.pnl or 0) > 0 %}
                                        <span class="font-semibold text-green-600">WON +${{ "%.2f"|format(seq.pick.pnl) }}</span>
                                        {% elif (seq.pick.pnl or 0) < 0 %}
                                        <span class="font-medium text-red-500">-${{ "%.2f"|format((seq.pick.pnl)|abs) }}</span>
                                        {% else %}
                                        <span class="font-medium text-gray-500">$0.00</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="p-6 text-center text-gray-500">
                        No races loaded yet. Click "Scrape All Data" to fetch.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-4">
            <!-- Generated Content -->
            <div style="background: var(--bg-card);" class="rounded-lg shadow">
                <div class="px-6 py-4" style="border-bottom: 1px solid var(--border-subtle);">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Generated Content</h2>
                </div>
                <div class="p-4">
                    {% if content_items %}
                    <ul style="border-color: var(--border-subtle);" class="divide-y">
                        {% for item in content_items[:10] %}
                        <li class="py-3">
                            <a href="/review/{{ item.id }}" class="flex justify-between items-center hover:opacity-80 -mx-2 px-2 py-1 rounded">
                                <div>
                                    <p class="font-medium" style="color: var(--text-primary);">{{ item.content_type|replace('_', ' ')|title }}</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">{{ item.created_at|melb('%H:%M') }}</p>
                                </div>
                                {% set status_colors = {
                                    'draft': 'bg-gray-100 text-gray-600',
                                    'pending_review': 'bg-yellow-100 text-yellow-600',
                                    'approved': 'bg-green-100 text-green-600',
                                    'sent': 'bg-purple-100 text-purple-600',
                                    'superseded': 'bg-gray-100 text-gray-500'
                                } %}
                                <span class="px-2 py-0.5 text-xs rounded {{ status_colors.get(item.status, 'bg-gray-100') }}">
                                    {{ item.status|replace('_', ' ')|title }}
                                </span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center py-4" style="color: var(--text-secondary);">No content generated yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Meeting Info -->
            <div style="background: var(--bg-card);" class="rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Meeting Info</h3>
                <dl class="space-y-3 text-sm">
                    <div>
                        <dt style="color: var(--text-secondary);">Track Condition</dt>
                        <dd class="font-medium" style="color: var(--text-primary);">{{ meeting.track_condition or 'TBC' }}</dd>
                    </div>
                    <div>
                        <dt style="color: var(--text-secondary);">Weather</dt>
                        <dd class="font-medium" style="color: var(--text-primary);">
                            {{ meeting.weather_condition or meeting.weather or 'TBC' }}
                            {% if meeting.weather_temp %} &mdash; {{ meeting.weather_temp }}&deg;C{% endif %}
                        </dd>
                    </div>
                    {% if meeting.weather_wind_speed %}
                    <div>
                        <dt class="text-gray-500">Wind</dt>
                        <dd class="font-medium">{{ meeting.weather_wind_speed }} km/h {{ meeting.weather_wind_dir or '' }}</dd>
                    </div>
                    {% endif %}
                    {% if meeting.penetrometer %}
                    <div>
                        <dt class="text-gray-500">Penetrometer</dt>
                        <dd class="font-medium">{{ meeting.penetrometer }}</dd>
                    </div>
                    {% endif %}
                    {% if meeting.rail_position %}
                    <div>
                        <dt class="text-gray-500">Rail Position</dt>
                        <dd class="font-medium">{{ meeting.rail_position }}</dd>
                    </div>
                    {% endif %}
                    {% if meeting.rail_bias_comment %}
                    <div>
                        <dt class="text-gray-500">Rail/Track Bias</dt>
                        <dd class="font-medium text-xs">{{ meeting.rail_bias_comment }}</dd>
                    </div>
                    {% endif %}
                    <div>
                        <dt class="text-gray-500">Last Updated</dt>
                        <dd class="font-medium">{{ meeting.updated_at.strftime('%d %b %H:%M') if meeting.updated_at else '-' }}</dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Alpine.js for collapsible sections -->
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<script>
var activeStreams = {};
var btnDefaults = {
    scrape: {text: '\u{1F504} Scrape All Data', id: 'scrape-btn'},
    generate: {text: '\u{1F4E7} Generate Early Mail', id: 'generate-btn'},
    puntreview: {text: '\u{1F4CA} Generate Punt Review', id: 'puntreview-btn'},
    speedmap: {text: '\u{1F3C3} Fetch Speed Maps', id: 'speedmap-btn'}
};

function cancelProcess(name) {
    if (activeStreams[name]) {
        activeStreams[name].close();
        activeStreams[name] = null;
    }
    var def = btnDefaults[name];
    var btn = document.getElementById(def.id);
    btn.disabled = false;
    btn.textContent = def.text;
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    var panel = document.getElementById(name === 'scrape' ? 'scrape-progress' : name + '-progress');
    var bar = panel.querySelector('[id$="-bar"], #progress-bar');
    if (bar) { bar.className = bar.className.replace(/bg-punty-coral|bg-punty-gold/, 'bg-yellow-500'); }
    var logEl = panel.querySelector('[id$="-log"], #progress-log');
    var line = document.createElement('div');
    line.className = 'flex items-center gap-2 py-0.5';
    line.innerHTML = '<span class="text-yellow-400 font-bold">&#x26A0;</span><span class="text-yellow-400 font-medium">Cancelled by user</span>';
    logEl.appendChild(line);
    var cancelBtn = document.getElementById(name + '-cancel');
    if (cancelBtn) cancelBtn.classList.add('hidden');
    showToast('Process cancelled', 'warning');
}

function preRaceScrape() {
    const btn = document.getElementById('prerace-btn');
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Refreshing...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');

    fetch('/api/meets/{{ meeting.id }}/refresh-odds', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'ok') {
                btn.textContent = 'Refreshed!';
                btn.classList.remove('opacity-50');
                btn.classList.add('bg-green-100', 'text-green-700');
                setTimeout(() => {
                    btn.textContent = origText;
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed', 'bg-green-100', 'text-green-700');
                    location.reload();
                }, 1500);
            } else {
                btn.textContent = 'Error: ' + (data.error || 'unknown');
                btn.classList.add('bg-red-100', 'text-red-600');
                setTimeout(() => {
                    btn.textContent = origText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-100', 'text-red-600');
                }, 3000);
            }
        })
        .catch(err => {
            btn.textContent = 'Failed';
            setTimeout(() => {
                btn.textContent = origText;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }, 2000);
        });
}

function startScrape() {
    const btn = document.getElementById('scrape-btn');
    const panel = document.getElementById('scrape-progress');
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('progress-pct');
    const log = document.getElementById('progress-log');

    btn.disabled = true;
    btn.textContent = 'Scraping...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    panel.classList.remove('hidden');
    log.innerHTML = '';
    bar.style.width = '0%';
    pct.textContent = '0%';

    var evtSource = new EventSource('/api/meets/{{ meeting.id }}/scrape-stream');
    activeStreams.scrape = evtSource;

    evtSource.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const percent = Math.round((data.step / data.total) * 100);

        // Update bar
        bar.style.width = percent + '%';
        pct.textContent = percent + '%';

        // Add log line
        const line = document.createElement('div');
        line.className = 'flex items-center gap-2 py-0.5';

        let icon = '';
        let textClass = 'text-gray-700';
        if (data.status === 'running') {
            icon = '<span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin"></span>';
            textClass = 'text-gray-600';
        } else if (data.status === 'done') {
            icon = '<span class="text-green-600 font-bold">&#10003;</span>';
            textClass = 'text-green-700';
        } else if (data.status === 'error') {
            icon = '<span class="text-red-600 font-bold">&#10007;</span>';
            textClass = 'text-red-600';
        } else if (data.status === 'complete') {
            icon = '<span class="text-punty-coral font-bold">&#9679;</span>';
            textClass = 'font-semibold text-gray-900';
            bar.classList.remove('bg-punty-coral');
            bar.classList.add(data.errors && data.errors.length ? 'bg-yellow-500' : 'bg-green-500');
            evtSource.close();
            activeStreams.scrape = null;
            document.getElementById('scrape-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F504} Scrape All Data';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            // Reload page after a short delay to show updated data
            setTimeout(() => window.location.reload(), 1500);
        }

        line.innerHTML = icon + '<span class="' + textClass + '">' + data.label + '</span>';
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    };

    evtSource.onerror = function() {
        evtSource.close();
        btn.disabled = false;
        btn.textContent = '\u{1F504} Scrape All Data';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        bar.classList.remove('bg-punty-coral');
        bar.classList.add('bg-red-500');
        pct.textContent = 'Error';
    };
}

function startSpeedMaps() {
    var btn = document.getElementById('speedmap-btn');
    var panel = document.getElementById('speedmap-progress');
    var bar = document.getElementById('speedmap-bar');
    var pct = document.getElementById('speedmap-pct');
    var log = document.getElementById('speedmap-log');

    btn.disabled = true;
    btn.textContent = 'Fetching...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    panel.classList.remove('hidden');
    log.innerHTML = '';
    bar.style.width = '0%';
    pct.textContent = '0%';
    bar.className = 'bg-punty-coral h-3 rounded-full transition-all duration-500';

    var evtSource = new EventSource('/api/meets/{{ meeting.id }}/speed-maps-stream');
    activeStreams.speedmap = evtSource;

    evtSource.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var percent = Math.round((data.step / data.total) * 100);

        bar.style.width = percent + '%';
        pct.textContent = percent + '%';

        var line = document.createElement('div');
        line.className = 'flex items-center gap-2 py-0.5';

        var icon = '';
        var textClass = 'text-gray-700';
        if (data.status === 'running') {
            icon = '<span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin"></span>';
            textClass = 'text-gray-600';
        } else if (data.status === 'done') {
            icon = '<span class="text-green-600 font-bold">&#10003;</span>';
            textClass = 'text-green-700';
        } else if (data.status === 'error') {
            icon = '<span class="text-red-600 font-bold">&#10007;</span>';
            textClass = 'text-red-600';
        } else if (data.status === 'complete') {
            icon = '<span class="text-punty-coral font-bold">&#9679;</span>';
            textClass = 'font-semibold text-gray-900';
            bar.className = 'bg-green-500 h-3 rounded-full transition-all duration-500';
            evtSource.close();
            activeStreams.speedmap = null;
            document.getElementById('speedmap-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F3C3} Fetch Speed Maps';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            setTimeout(function() { window.location.reload(); }, 1500);
        }

        line.innerHTML = icon + '<span class="' + textClass + '">' + data.label + '</span>';
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    };

    evtSource.onerror = function() {
        evtSource.close();
        btn.disabled = false;
        btn.textContent = '\u{1F3C3} Fetch Speed Maps';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
        pct.textContent = 'Error';
    };
}

function startGenerate() {
    // Check for incomplete data
    {% if meeting.speed_map_complete == false %}
    var proceed = confirm(
        '⚠️ DATA WARNING\n\n' +
        'This meeting has incomplete or missing speed map data.\n\n' +
        'Generating Early Mail with incomplete data may result in:\n' +
        '• Missing pace analysis\n' +
        '• Incorrect race shape predictions\n' +
        '• Less accurate selections\n\n' +
        'Do you want to proceed anyway?'
    );
    if (!proceed) {
        showToast('Generation cancelled', 'warning');
        return;
    }
    {% endif %}

    var btn = document.getElementById('generate-btn');
    var panel = document.getElementById('generate-progress');
    var bar = document.getElementById('generate-bar');
    var pct = document.getElementById('generate-pct');
    var log = document.getElementById('generate-log');

    btn.disabled = true;
    btn.textContent = 'Generating...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    panel.classList.remove('hidden');
    log.innerHTML = '';
    bar.style.width = '0%';
    pct.textContent = '0%';
    bar.className = 'bg-punty-coral h-3 rounded-full transition-all duration-500';

    var evtSource = new EventSource('/api/content/generate-stream?meeting_id={{ meeting.id }}&content_type=early_mail');
    activeStreams.generate = evtSource;

    evtSource.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var percent = Math.round((data.step / data.total) * 100);

        bar.style.width = percent + '%';
        pct.textContent = percent + '%';

        var line = document.createElement('div');
        line.className = 'flex items-center gap-2 py-0.5';

        var icon = '';
        var textClass = 'text-gray-700';
        if (data.status === 'running') {
            icon = '<span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin"></span>';
            textClass = 'text-gray-600';
        } else if (data.status === 'done') {
            icon = '<span class="text-green-600 font-bold">&#10003;</span>';
            textClass = 'text-green-700';
        } else if (data.status === 'error') {
            icon = '<span class="text-red-600 font-bold">&#10007;</span>';
            textClass = 'text-red-600';
            evtSource.close();
            activeStreams.generate = null;
            document.getElementById('generate-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F4E7} Generate Early Mail';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
        } else if (data.status === 'complete' || data.status === 'generation_done') {
            icon = '<span class="text-punty-coral font-bold">&#9679;</span>';
            textClass = 'font-semibold text-gray-900';
            bar.className = 'bg-green-500 h-3 rounded-full transition-all duration-500';
            evtSource.close();
            activeStreams.generate = null;
            document.getElementById('generate-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F4E7} Generate Early Mail';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            showToast('Early Mail generated!', 'success');
            setTimeout(function() { window.location.reload(); }, 1500);
        }

        line.innerHTML = icon + '<span class="' + textClass + '">' + data.label + '</span>';
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    };

    evtSource.onerror = function() {
        evtSource.close();
        btn.disabled = false;
        btn.textContent = '\u{1F4E7} Generate Early Mail';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
        pct.textContent = 'Error';
    };
}

function startPuntReview() {
    var btn = document.getElementById('puntreview-btn');
    var panel = document.getElementById('puntreview-progress');
    var bar = document.getElementById('puntreview-bar');
    var pct = document.getElementById('puntreview-pct');
    var log = document.getElementById('puntreview-log');

    btn.disabled = true;
    btn.textContent = 'Generating...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    panel.classList.remove('hidden');
    log.innerHTML = '';
    bar.style.width = '0%';
    pct.textContent = '0%';
    bar.className = 'bg-punty-gold h-3 rounded-full transition-all duration-500';

    var evtSource = new EventSource('/api/content/generate-stream?meeting_id={{ meeting.id }}&content_type=meeting_wrapup');
    activeStreams.puntreview = evtSource;

    evtSource.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var percent = Math.round((data.step / data.total) * 100);

        bar.style.width = percent + '%';
        pct.textContent = percent + '%';

        var line = document.createElement('div');
        line.className = 'flex items-center gap-2 py-0.5';

        var icon = '';
        var textClass = 'text-gray-700';
        if (data.status === 'running') {
            icon = '<span class="inline-block w-4 h-4 border-2 border-punty-gold border-t-transparent rounded-full animate-spin"></span>';
            textClass = 'text-gray-600';
        } else if (data.status === 'done') {
            icon = '<span class="text-green-600 font-bold">&#10003;</span>';
            textClass = 'text-green-700';
        } else if (data.status === 'error') {
            icon = '<span class="text-red-600 font-bold">&#10007;</span>';
            textClass = 'text-red-600';
            evtSource.close();
            activeStreams.puntreview = null;
            document.getElementById('puntreview-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F4CA} Generate Punt Review';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
        } else if (data.status === 'complete' || data.status === 'generation_done') {
            icon = '<span class="text-punty-gold font-bold">&#9679;</span>';
            textClass = 'font-semibold text-gray-900';
            bar.className = 'bg-green-500 h-3 rounded-full transition-all duration-500';
            evtSource.close();
            activeStreams.puntreview = null;
            document.getElementById('puntreview-cancel').classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F4CA} Generate Punt Review';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            showToast('Punt Review generated!', 'success');
            setTimeout(function() { window.location.reload(); }, 1500);
        }

        line.innerHTML = icon + '<span class="' + textClass + '">' + data.label + '</span>';
        log.appendChild(line);
        log.scrollTop = log.scrollHeight;
    };

    evtSource.onerror = function() {
        evtSource.close();
        btn.disabled = false;
        btn.textContent = '\u{1F4CA} Generate Punt Review';
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
        pct.textContent = 'Error';
    };
}

var resultsAbort = null;

function checkResults() {
    var btn = document.getElementById('results-btn');
    var panel = document.getElementById('results-progress');
    var bar = document.getElementById('results-bar');
    var statusEl = document.getElementById('results-status');
    var logEl = document.getElementById('results-log');
    var cancelBtn = document.getElementById('results-cancel');

    btn.disabled = true;
    btn.textContent = 'Checking...';
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    panel.classList.remove('hidden');
    logEl.innerHTML = '';
    bar.className = 'bg-punty-coral h-3 rounded-full transition-all duration-500 animate-pulse';
    bar.style.width = '100%';
    statusEl.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin align-middle"></span> Checking...';
    cancelBtn.classList.remove('hidden');

    var line = document.createElement('div');
    line.className = 'flex items-center gap-2 py-0.5';
    line.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-punty-coral border-t-transparent rounded-full animate-spin"></span><span class="text-gray-600">Fetching results and settling picks...</span>';
    logEl.appendChild(line);

    resultsAbort = new AbortController();

    fetch('/api/results/{{ meeting.id }}/check', { method: 'POST', signal: resultsAbort.signal })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            resultsAbort = null;
            cancelBtn.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F3C6} Check Results';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            bar.classList.remove('animate-pulse');
            if (data.status === 'checked') {
                bar.className = 'bg-green-500 h-3 rounded-full transition-all duration-500';
                statusEl.innerHTML = '<span class="text-green-600 font-bold">&#10003;</span> Done';
                var done = document.createElement('div');
                done.className = 'flex items-center gap-2 py-0.5';
                done.innerHTML = '<span class="text-green-600 font-bold">&#10003;</span><span class="text-green-700 font-medium">Results checked and picks settled</span>';
                logEl.innerHTML = '';
                logEl.appendChild(done);
                showToast('Results checked', 'success');
                setTimeout(function() { window.location.reload(); }, 1500);
            } else {
                bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
                statusEl.innerHTML = '<span class="text-red-600 font-bold">&#10007;</span> Failed';
                var err = document.createElement('div');
                err.className = 'flex items-center gap-2 py-0.5';
                err.innerHTML = '<span class="text-red-600 font-bold">&#10007;</span><span class="text-red-600">' + (data.error || 'Check failed') + '</span>';
                logEl.innerHTML = '';
                logEl.appendChild(err);
                showToast(data.error || 'Check failed', 'error');
            }
        })
        .catch(function(e) {
            if (e.name === 'AbortError') return;
            resultsAbort = null;
            cancelBtn.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = '\u{1F3C6} Check Results';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            bar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500';
            statusEl.innerHTML = '<span class="text-red-600 font-bold">&#10007;</span> Error';
            var err = document.createElement('div');
            err.className = 'flex items-center gap-2 py-0.5';
            err.innerHTML = '<span class="text-red-600 font-bold">&#10007;</span><span class="text-red-600">Request failed</span>';
            logEl.innerHTML = '';
            logEl.appendChild(err);
            showToast('Request failed', 'error');
        });
}

function cancelResults() {
    if (resultsAbort) {
        resultsAbort.abort();
        resultsAbort = null;
    }
    var btn = document.getElementById('results-btn');
    var bar = document.getElementById('results-bar');
    var statusEl = document.getElementById('results-status');
    var logEl = document.getElementById('results-log');
    var cancelBtn = document.getElementById('results-cancel');
    btn.disabled = false;
    btn.textContent = '\u{1F3C6} Check Results';
    btn.classList.remove('opacity-50', 'cursor-not-allowed');
    bar.className = 'bg-yellow-500 h-3 rounded-full transition-all duration-500';
    bar.classList.remove('animate-pulse');
    statusEl.innerHTML = '<span class="text-yellow-400 font-bold">&#x26A0;</span> Cancelled';
    cancelBtn.classList.add('hidden');
    logEl.innerHTML = '';
    var line = document.createElement('div');
    line.className = 'flex items-center gap-2 py-0.5';
    line.innerHTML = '<span class="text-yellow-400 font-bold">&#x26A0;</span><span class="text-yellow-400 font-medium">Cancelled by user</span>';
    logEl.appendChild(line);
    showToast('Results check cancelled', 'warning');
}

var monitorRunning = false;
function toggleMonitor() {
    var btn = document.getElementById('monitor-btn');
    var action = monitorRunning ? 'stop' : 'start';
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    var origHTML = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span> ' + (action === 'start' ? 'Starting...' : 'Stopping...');
    fetch('/api/results/monitor/' + action, { method: 'POST' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            monitorRunning = !monitorRunning;
            btn.textContent = monitorRunning ? '\u{1F6D1} Stop Monitor' : '\u{1F50D} Start Monitor';
            btn.className = monitorRunning
                ? 'bg-red-100 text-red-700 px-4 py-2 rounded-lg border border-red-300 hover:bg-red-200'
                : 'bg-white text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-50';
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            showToast('Monitor ' + data.status, 'success');
        })
        .catch(function() {
            btn.innerHTML = origHTML;
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            showToast('Failed to toggle monitor', 'error');
        });
}

// Check initial monitor status
fetch('/api/results/monitor-status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.running) {
            monitorRunning = true;
            var btn = document.getElementById('monitor-btn');
            btn.textContent = '\u{1F6D1} Stop Monitor';
            btn.className = 'bg-red-100 text-red-700 px-4 py-2 rounded-lg border border-red-300 hover:bg-red-200';
        }
    })
    .catch(function() {});

// Meeting switcher
function switchMeeting(meetingId) {
    window.location.href = '/meets/' + meetingId;
}

// Race countdown timer
function updateCountdowns() {
    var countdowns = document.querySelectorAll('.race-countdown');
    var now = new Date();

    countdowns.forEach(function(el) {
        var startTime = el.dataset.startTime;
        if (!startTime) return;

        var raceTime = new Date(startTime);
        var diff = raceTime - now;

        if (diff <= 0) {
            el.textContent = 'Started';
            el.style.color = 'var(--text-muted)';
        } else {
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            var secs = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) {
                el.textContent = hours + 'h ' + mins + 'm';
            } else if (mins > 0) {
                el.textContent = mins + 'm ' + secs + 's';
            } else {
                el.textContent = secs + 's';
                el.style.color = 'var(--red, #ef4444)';
                el.classList.add('animate-pulse');
            }
        }
    });
}

// Update every second
updateCountdowns();
setInterval(updateCountdowns, 1000);
</script>
{% endblock %}
