{% extends "base.html" %}

{% block title %}Punty's Punts - Racing Tips Archive | PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="Browse Punty's horse racing tips archive. Expert AI analysis for Australian thoroughbred racing.">
<style>
    .tips-subnav {
        position: sticky; top: 0; z-index: 40;
        background: rgba(10, 10, 15, 0.92);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: 1.5rem;
    }
    .tips-subnav-inner {
        max-width: 72rem;
        margin: 0 auto;
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .tips-subnav-inner::-webkit-scrollbar { display: none; }
    .tips-subnav-item {
        display: inline-flex; align-items: center; gap: 0.375rem;
        padding: 0.375rem 0.75rem; border-radius: 9999px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.8rem;
        letter-spacing: 0.04em; text-transform: uppercase;
        color: var(--text-muted); white-space: nowrap;
        border: 1px solid transparent;
        transition: all 0.15s; text-decoration: none;
    }
    .tips-subnav-item:hover {
        color: var(--text-secondary); background: rgba(255, 255, 255, 0.05);
    }
    .tips-subnav-item.active {
        color: white; background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.12);
    }
    .tips-subnav-dot {
        width: 6px; height: 6px; border-radius: 50%;
        opacity: 0.6;
    }
    .tips-subnav-spacer { flex: 1; }
    @media (min-width: 640px) {
        .tips-subnav-inner { padding: 0.5rem 2rem; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Sticky Sub-navigation -->
<nav class="tips-subnav">
    <div class="tips-subnav-inner">
        <a href="#tips-search" class="tips-subnav-item" data-section="tips-search">
            <span class="tips-subnav-dot" style="background: var(--magenta);"></span>
            Search
        </a>
        <a href="#tips-calendar" class="tips-subnav-item" data-section="tips-calendar">
            <span class="tips-subnav-dot" style="background: var(--cyan);"></span>
            Calendar
        </a>
        <a href="#tips-stats-bar" class="tips-subnav-item" data-section="tips-stats-bar">
            <span class="tips-subnav-dot" style="background: var(--yellow);"></span>
            Quick Stats
        </a>
        <span class="tips-subnav-spacer"></span>
        <a href="/stats" class="tips-subnav-item" style="color: var(--cyan); border-color: rgba(0, 212, 255, 0.2);">
            <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Full Stats
        </a>
    </div>
</nav>

<section class="py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-display font-bold mb-4">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Punts</span>
            </h1>
            <p class="text-lg" style="color: var(--text-secondary);">
                Browse Punty's tips archive. Click on a meeting to read the full early mail and wrap-up.
            </p>
        </div>

        <!-- Quick Stats -->
        <div id="tips-stats-bar"></div>
        <div id="tips-stats" class="hidden flex flex-wrap items-center justify-center gap-6 mb-6 px-4 py-3 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-subtle);"></div>
        <script>
        fetch('/api/public/bet-type-stats').then(r=>r.json()).then(data=>{
            const sel = data.filter(s => s.category === 'Selections');
            if (!sel.length) return;
            const total = sel.reduce((a,s) => a + s.total, 0);
            const won = sel.reduce((a,s) => a + s.won, 0);
            const pnl = sel.reduce((a,s) => a + s.pnl, 0);
            const staked = sel.reduce((a,s) => a + (s.staked || 0), 0);
            const rate = total > 0 ? (won/total*100).toFixed(1) : '0';
            const roi = staked > 0 ? (pnl / staked * 100) : 0;
            const el = document.getElementById('tips-stats');
            el.innerHTML = '<span style="color:var(--text-muted)" class="text-xs font-heading font-semibold uppercase tracking-wider">All-time</span>' +
                '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--cyan)">' + rate + '%</span> <span class="text-xs" style="color:var(--text-muted)">strike rate</span></span>' +
                '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--text-secondary)">' + won + '/' + total + '</span> <span class="text-xs" style="color:var(--text-muted)">winners</span></span>' +
                '<span class="text-sm"><span class="font-heading font-bold ' + (roi >= 0 ? 'text-green-400' : 'text-red-400') + '">' + (roi >= 0 ? '+' : '') + roi.toFixed(1) + '%</span> <span class="text-xs" style="color:var(--text-muted)">ROI</span></span>';
            el.classList.remove('hidden');
        }).catch(()=>{});
        </script>

        <!-- Search Filters -->
        <div id="tips-search"></div>
        <form method="GET" action="/tips" class="card p-4 mb-8">
            <div class="flex flex-wrap gap-3 items-end">
                <div class="flex-1 min-w-[150px]" x-data="venueSearch()" x-init="init()">
                    <label class="block text-xs font-heading font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Venue</label>
                    <div class="relative">
                        <input type="text" name="venue" x-model="query" x-ref="input"
                               @input="filter()" @focus="open = query.length > 0 && filtered.length > 0"
                               @click.away="open = false" @keydown.escape="open = false"
                               @keydown.arrow-down.prevent="moveDown()" @keydown.arrow-up.prevent="moveUp()"
                               @keydown.enter="selectActive($event)"
                               placeholder="Start typing..." autocomplete="off"
                               class="w-full px-3 py-2 rounded-lg text-sm" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary);">
                        <div x-show="open" x-cloak
                             class="absolute z-50 left-0 right-0 mt-1 rounded-lg overflow-hidden shadow-xl"
                             style="background: var(--bg-card); border: 1px solid var(--border-subtle); max-height: 240px; overflow-y: auto;">
                            <template x-for="(v, i) in filtered" :key="v">
                                <div @click="select(v)" @mouseenter="active = i"
                                     :class="{'venue-item-active': active === i}"
                                     class="venue-item px-3 py-2 text-sm cursor-pointer"
                                     x-text="v"></div>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="min-w-[140px]">
                    <label class="block text-xs font-heading font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">From</label>
                    <input type="date" name="date_from" value="{{ date_from }}"
                           class="w-full px-3 py-2 rounded-lg text-sm" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary); color-scheme: dark;">
                </div>
                <div class="min-w-[140px]">
                    <label class="block text-xs font-heading font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">To</label>
                    <input type="date" name="date_to" value="{{ date_to }}"
                           class="w-full px-3 py-2 rounded-lg text-sm" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-primary); color-scheme: dark;">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="px-4 py-2 rounded-lg font-heading font-semibold text-sm" style="background: var(--magenta); color: white;">Search</button>
                    {% if venue or date_from or date_to %}
                    <a href="/tips" class="px-4 py-2 rounded-lg font-heading font-semibold text-sm" style="background: var(--bg-dark); border: 1px solid var(--border-subtle); color: var(--text-secondary);">Clear</a>
                    {% endif %}
                </div>
            </div>
        </form>
        <style>
        .venue-item {
            color: var(--text-secondary);
            transition: background 0.1s, color 0.1s;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }
        .venue-item:hover, .venue-item-active {
            background: rgba(233, 30, 140, 0.15);
            color: var(--text-primary);
        }
        .venue-item-active {
            background: rgba(233, 30, 140, 0.2);
        }
        [x-cloak] { display: none !important; }
        </style>
        <script>
        function venueSearch() {
            return {
                query: '{{ venue }}',
                venues: [],
                filtered: [],
                open: false,
                active: -1,
                init() {
                    fetch('/api/public/venues').then(r => r.json()).then(data => {
                        this.venues = data.venues || [];
                    }).catch(() => {});
                },
                filter() {
                    const q = this.query.toLowerCase().trim();
                    if (q.length === 0) { this.filtered = []; this.open = false; return; }
                    this.filtered = this.venues.filter(v => v.toLowerCase().includes(q)).slice(0, 15);
                    this.open = this.filtered.length > 0;
                    this.active = -1;
                },
                select(v) {
                    this.query = v;
                    this.open = false;
                    this.$refs.input.focus();
                },
                moveDown() {
                    if (!this.open) return;
                    this.active = Math.min(this.active + 1, this.filtered.length - 1);
                    this.scrollToActive();
                },
                moveUp() {
                    if (!this.open) return;
                    this.active = Math.max(this.active - 1, 0);
                    this.scrollToActive();
                },
                selectActive(e) {
                    if (this.open && this.active >= 0) {
                        e.preventDefault();
                        this.select(this.filtered[this.active]);
                    }
                },
                scrollToActive() {
                    this.$nextTick(() => {
                        const items = this.$refs.input.parentElement.querySelectorAll('.venue-item');
                        if (items[this.active]) items[this.active].scrollIntoView({ block: 'nearest' });
                    });
                }
            };
        }
        </script>

        {% if calendar %}
        <!-- Calendar View -->
        <div id="tips-calendar" class="space-y-8">
            {% for day in calendar %}
            <div>
                <!-- Date Header -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-xl flex flex-col items-center justify-center flex-shrink-0" style="background: var(--gradient-sunset);">
                        <span class="text-xs font-bold uppercase text-white/80">{{ day.meetings[0].date.strftime('%b') if day.meetings[0].date else '' }}</span>
                        <span class="text-2xl font-display font-black text-white">{{ day.meetings[0].date.strftime('%d') if day.meetings[0].date else '' }}</span>
                    </div>
                    <div>
                        <h2 class="font-heading font-bold text-xl text-white">{{ day.date_formatted }}</h2>
                        <p class="text-sm" style="color: var(--text-muted);">{{ day.meetings|length }} meeting{% if day.meetings|length != 1 %}s{% endif %}</p>
                    </div>
                </div>

                <!-- Meetings Grid -->
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 ml-0 sm:ml-20">
                    {% for meeting in day.meetings %}
                    <a href="/tips/{{ meeting.slug }}" class="card p-4 hover:border-punty-magenta transition-all hover:-translate-y-1 group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: rgba(233, 30, 140, 0.15);">
                                <svg class="w-5 h-5" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-heading font-bold text-white group-hover:text-punty-mbright transition-colors truncate">{{ meeting.venue }}</div>
                                {% if meeting.track_condition %}
                                <div class="text-xs" style="color: var(--cyan);">{{ meeting.track_condition }}</div>
                                {% endif %}
                            </div>
                            <svg class="w-5 h-5 opacity-0 group-hover:opacity-100 transition-opacity" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="flex items-center justify-center gap-2 mt-12">
            {% if has_prev %}
            <a href="/tips?page={{ page - 1 }}{{ filter_params }}" class="px-4 py-2 rounded-lg font-heading font-semibold transition-colors hover:bg-white/5" style="background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-secondary);">
                &larr; Newer
            </a>
            {% endif %}

            <span class="px-4 py-2 font-heading" style="color: var(--text-muted);">
                Page {{ page }} of {{ total_pages }}
            </span>

            {% if has_next %}
            <a href="/tips?page={{ page + 1 }}{{ filter_params }}" class="px-4 py-2 rounded-lg font-heading font-semibold transition-colors hover:bg-white/5" style="background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-secondary);">
                Older &rarr;
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!-- No tips found -->
        <div class="card p-12 text-center">
            <div class="text-6xl mb-4">&#x1F3C7;</div>
            {% if venue or date_from or date_to %}
            <h2 class="text-2xl font-heading font-bold mb-2">No Matches</h2>
            <p style="color: var(--text-secondary);">
                No tips found for that search. Try broadening your filters.
            </p>
            <a href="/tips" class="btn-secondary inline-flex items-center gap-2 mt-6">Clear Filters</a>
            {% else %}
            <h2 class="text-2xl font-heading font-bold mb-2">No Tips Yet</h2>
            <p style="color: var(--text-secondary);">
                Check back soon! Punty's tips will appear here once they're published.
            </p>
            <a href="/" class="btn-primary inline-flex items-center gap-2 mt-6">
                Back to Home
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Tips page subnav scroll spy
(function() {
    var navItems = document.querySelectorAll('.tips-subnav-item[data-section]');
    if (!navItems.length) return;

    navItems.forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            var target = document.getElementById(item.dataset.section);
            if (target) {
                var navH = document.querySelector('.tips-subnav').offsetHeight || 48;
                var y = target.getBoundingClientRect().top + window.pageYOffset - navH - 8;
                window.scrollTo({ top: y, behavior: 'smooth' });
            }
        });
    });

    var sectionIds = [];
    navItems.forEach(function(item) { sectionIds.push(item.dataset.section); });

    function updateActive() {
        var nav = document.querySelector('.tips-subnav');
        var navH = nav ? nav.offsetHeight : 48;
        var current = null;
        for (var i = sectionIds.length - 1; i >= 0; i--) {
            var el = document.getElementById(sectionIds[i]);
            if (el && el.getBoundingClientRect().top <= navH + 20) {
                current = sectionIds[i]; break;
            }
        }
        navItems.forEach(function(item) {
            item.classList.toggle('active', item.dataset.section === current);
        });
    }
    window.addEventListener('scroll', updateActive, { passive: true });
    updateActive();
})();
</script>
{% endblock %}
