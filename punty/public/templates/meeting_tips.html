{% extends "base.html" %}

{% block title %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endblock %}

{% block og_title %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endblock %}
{% block og_description %}Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, pace reads, and win celebrations for Australian thoroughbred racing.{% endblock %}
{% block og_url %}https://punty.ai/tips/{{ meeting.id }}{% endblock %}
{% block twitter_title %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endblock %}
{% block twitter_description %}Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, pace reads, and win celebrations for Australian thoroughbred racing.{% endblock %}

{% block head %}
<meta name="description" content="Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, live pace reads, and win celebrations for Australian thoroughbred racing.">
{% endblock %}

{% block content %}
<section class="py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-8">
        <!-- Back Link -->
        <a href="/tips" class="inline-flex items-center gap-2 mb-8 text-sm font-heading font-semibold transition-colors hover:text-punty-magenta" style="color: var(--text-secondary);">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Tips
        </a>

        <!-- Meeting Header -->
        <div class="card p-6 mb-8">
            <div class="flex items-start gap-4">
                <div class="w-16 h-16 rounded-xl flex flex-col items-center justify-center flex-shrink-0" style="background: var(--gradient-sunset);">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h1 class="text-3xl md:text-4xl font-heading font-bold mb-2">
                        <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{{ meeting.venue }}</span>
                    </h1>
                    <p class="text-lg" style="color: var(--text-secondary);">{{ meeting.date_formatted }}</p>

                    <!-- Meeting Details -->
                    <div class="flex flex-wrap gap-4 mt-4">
                        {% if meeting.track_condition %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Track</span>
                            <span class="px-2 py-1 rounded text-sm font-heading font-semibold" style="background: rgba(0, 212, 255, 0.15); color: var(--cyan);">{{ meeting.track_condition }}</span>
                        </div>
                        {% endif %}
                        {% if meeting.weather %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Weather</span>
                            <span class="px-2 py-1 rounded text-sm font-heading font-semibold" style="background: rgba(233, 30, 140, 0.15); color: var(--magenta);">{{ meeting.weather }}</span>
                        </div>
                        {% endif %}
                        {% if meeting.rail_position %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Rail</span>
                            <span class="text-sm" style="color: var(--text-secondary);">{{ meeting.rail_position }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Early Mail Section -->
        {% if early_mail %}
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(233, 30, 140, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-heading font-bold text-white">Early Mail</h2>
            </div>
            <div class="card p-6">
                <div class="prose prose-invert max-w-none tips-content">
                    {{ early_mail.content | safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Live Updates Section -->
        {% if live_updates %}
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center live-pulse" style="background: rgba(255, 107, 53, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--orange);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-heading font-bold">
                    <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Live Updates</span>
                </h2>
                <span class="live-badge">LIVE</span>
            </div>

            <div class="space-y-3">
                {% for update in live_updates %}
                <div class="live-update-card {% if update.type == 'celebration' %}live-celebration{% else %}live-pace{% endif %}">
                    <div class="flex items-start gap-3">
                        <!-- Icon -->
                        <div class="live-icon flex-shrink-0">
                            {% if update.type == 'celebration' %}
                            <span class="text-2xl">&#x1F3C7;</span>
                            {% else %}
                            <span class="text-2xl">&#x1F3C1;</span>
                            {% endif %}
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            {% if update.type == 'celebration' %}
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-heading font-bold text-sm uppercase tracking-wider" style="color: #4ade80;">Winner!</span>
                                {% if update.race_number %}
                                <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.08); color: var(--text-muted);">R{{ update.race_number }}</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-heading font-bold text-sm uppercase tracking-wider" style="color: var(--cyan);">Track Read</span>
                                <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.08); color: var(--text-muted);">After R{{ update.race_number }}</span>
                            </div>
                            {% endif %}

                            <p class="text-sm leading-relaxed" style="color: var(--text-secondary);">{{ update.content }}</p>

                            {% if update.created_at %}
                            <div class="mt-2 text-xs" style="color: var(--text-muted);">{{ update.created_at }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Wrap-up Section -->
        {% if wrapup %}
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(0, 212, 255, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-heading font-bold text-white">Wrap-up</h2>
            </div>
            <div class="card p-6">
                <div class="prose prose-invert max-w-none tips-content">
                    {{ wrapup.content | safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- No Content Message -->
        {% if not early_mail and not wrapup %}
        <div class="card p-12 text-center">
            <div class="text-6xl mb-4">&#x1F3C7;</div>
            <h2 class="text-2xl font-heading font-bold mb-2">No Tips Available</h2>
            <p style="color: var(--text-secondary);">
                Tips for this meeting haven't been published yet. Check back soon!
            </p>
        </div>
        {% endif %}

        <!-- CTA -->
        <div class="card p-6 text-center mt-8" style="background: linear-gradient(135deg, rgba(233, 30, 140, 0.1), rgba(255, 107, 53, 0.1));">
            <p class="font-heading font-semibold text-white mb-2">Want Punty's tips and live updates on race day?</p>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">Early mail before the races. Live pace analysis and win celebrations as they happen.</p>
            <a href="https://x.com/PuntyAI/" target="_blank" class="btn-primary inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                Follow @PuntyAI
            </a>
        </div>
    </div>
</section>

<style>
    .tips-content {
        font-family: 'Source Sans Pro', sans-serif;
        line-height: 1.8;
        color: #d0d0dc;
    }
    .tips-content p {
        margin-bottom: 1rem;
    }
    .tips-content strong, .tips-content b {
        color: white;
        font-weight: 600;
    }
    .tips-content .tips-heading {
        color: white;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    .tips-content h2.tips-heading {
        font-size: 1.5rem;
        background: var(--gradient-sunset);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .tips-content h3.tips-heading {
        font-size: 1.25rem;
        color: var(--cyan);
    }
    .tips-content h4.tips-heading {
        font-size: 1.1rem;
        color: var(--magenta);
    }
    .tips-content .tips-list {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }
    .tips-content .tips-list li {
        margin-bottom: 0.5rem;
    }
    .tips-content .tips-divider {
        border: none;
        border-top: 1px solid var(--border-subtle);
        margin: 1.5rem 0;
    }
    .tips-content em {
        font-style: italic;
        color: var(--text-muted);
    }
    .win-tick {
        color: #4ade80;
        font-weight: 700;
        font-size: 1.1em;
        margin-left: 4px;
    }

    /* Live Updates */
    .live-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 0.7rem;
        letter-spacing: 0.1em;
        padding: 2px 10px;
        border-radius: 9999px;
        background: rgba(255, 107, 53, 0.2);
        color: var(--orange);
        border: 1px solid rgba(255, 107, 53, 0.3);
    }
    .live-badge::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--orange);
        animation: live-dot 1.5s ease-in-out infinite;
    }
    @keyframes live-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    .live-pulse {
        animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.2); }
        50% { box-shadow: 0 0 12px 4px rgba(255, 107, 53, 0.15); }
    }
    .live-update-card {
        padding: 1rem 1.25rem;
        border-radius: 12px;
        border-left: 3px solid transparent;
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .live-update-card:hover {
        transform: translateX(4px);
    }
    .live-celebration {
        background: linear-gradient(135deg, rgba(74, 222, 128, 0.06), rgba(255, 107, 53, 0.06));
        border-left-color: #4ade80;
        border: 1px solid rgba(74, 222, 128, 0.12);
        border-left: 3px solid #4ade80;
    }
    .live-pace {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.06), rgba(157, 78, 221, 0.06));
        border-left-color: var(--cyan);
        border: 1px solid rgba(0, 212, 255, 0.12);
        border-left: 3px solid var(--cyan);
    }
    .live-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var winners = {{ winners | tojson }};
    if (!winners || !Object.keys(winners).length) return;

    var tipsContent = document.querySelector('.tips-content');
    if (!tipsContent) return;

    var currentRace = null;
    var elements = tipsContent.querySelectorAll('h2, h3, h4, p, li, strong');

    // First pass: detect all race context elements for debugging
    // (actual race context tracking happens in second pass)

    // Second pass: find elements with saddlecloth numbers and mark winners
    currentRace = null;
    var allP = tipsContent.querySelectorAll('h2, h3, h4, p, li, strong');
    allP.forEach(function(el) {
        var text = el.textContent || '';

        // Detect race headers from headings or bold text containing "Race N"
        var raceMatch = text.match(/Race\s+(\d+)/i);
        if (raceMatch && (/^H[2-4]$/.test(el.tagName) || (el.tagName === 'STRONG' && text.match(/^Race\s+\d+/)))) {
            currentRace = parseInt(raceMatch[1]);
            return;
        }

        if (!currentRace || !winners[String(currentRace)]) return;

        // Skip container elements that would double-match (only mark the innermost)
        if (el.tagName === 'P' && el.querySelector('li')) return;

        // Check for saddlecloth number
        var scMatch = text.match(/\((?:Race\s*\d+,\s*)?No\.?\s*(\d+)\)/);
        if (!scMatch) return;
        var sc = parseInt(scMatch[1]);

        if (winners[String(currentRace)].indexOf(sc) !== -1) {
            // Don't add duplicate ticks
            if (el.querySelector('.win-tick')) return;
            var tick = document.createElement('span');
            tick.className = 'win-tick';
            tick.innerHTML = ' &#10003;';
            tick.title = 'Winner!';
            el.appendChild(tick);
        }
    });
});
</script>
{% endblock %}
