{% extends "base.html" %}

{% block title %}{% if meta_title %}{{ meta_title }}{% else %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endif %}{% endblock %}

{% block og_title %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endblock %}
{% block og_description %}Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, pace reads, and win celebrations for Australian thoroughbred racing.{% endblock %}
{% block og_url %}https://punty.ai/tips/{{ meeting.id }}{% endblock %}
{% block twitter_title %}{{ meeting.venue }} Tips - {{ meeting.date_formatted }} | PuntyAI{% endblock %}
{% block twitter_description %}Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, pace reads, and win celebrations for Australian thoroughbred racing.{% endblock %}

{% block head %}
<meta name="description" content="{% if meta_description %}{{ meta_description }}{% else %}Punty's horse racing tips and live updates for {{ meeting.venue }} on {{ meeting.date_formatted }}. AI analysis, live pace reads, and win celebrations for Australian thoroughbred racing.{% endif %}">
<link rel="canonical" href="https://punty.ai/tips/{{ meeting.id }}">
{% endblock %}

{% block content %}
<section class="py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-8">
        <!-- Back Link -->
        <a href="/tips" class="inline-flex items-center gap-2 mb-8 text-sm font-heading font-semibold transition-colors hover:text-punty-magenta" style="color: var(--text-secondary);">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Tips
        </a>

        <!-- Meeting Header -->
        <div class="card p-6 mb-8">
            <div class="flex items-start gap-4">
                <div class="w-16 h-16 rounded-xl flex flex-col items-center justify-center flex-shrink-0" style="background: var(--gradient-sunset);">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h1 class="text-3xl md:text-4xl font-heading font-bold mb-2">
                        <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{{ meeting.venue }}</span>
                    </h1>
                    <p class="text-lg" style="color: var(--text-secondary);">{{ meeting.date_formatted }}</p>

                    <!-- Meeting Details -->
                    <div class="flex flex-wrap gap-4 mt-4">
                        {% if meeting.track_condition %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Track</span>
                            <span class="px-2 py-1 rounded text-sm font-heading font-semibold" style="background: rgba(0, 212, 255, 0.15); color: var(--cyan);">{{ meeting.track_condition }}</span>
                        </div>
                        {% endif %}
                        {% if meeting.weather %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Weather</span>
                            <span class="px-2 py-1 rounded text-sm font-heading font-semibold" style="background: rgba(233, 30, 140, 0.15); color: var(--magenta);">{{ meeting.weather }}</span>
                        </div>
                        {% endif %}
                        {% if meeting.rail_position %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-heading font-semibold uppercase" style="color: var(--text-muted);">Rail</span>
                            <span class="text-sm" style="color: var(--text-secondary);">{{ meeting.rail_position }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Venue Stats (subtle) -->
        {% if venue_stats %}
        <div class="flex flex-wrap items-center gap-4 mb-8 px-4 py-3 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-subtle);">
            <span class="text-xs font-heading font-semibold uppercase tracking-wider" style="color: var(--text-muted);">Punty at {{ meeting.venue }}</span>
            <div class="flex items-center gap-1.5">
                <span class="text-sm font-heading font-bold" style="color: var(--cyan);">{{ venue_stats.rate }}%</span>
                <span class="text-xs" style="color: var(--text-muted);">strike rate</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-sm font-heading font-bold" style="color: var(--text-secondary);">{{ venue_stats.hits }}/{{ venue_stats.total }}</span>
                <span class="text-xs" style="color: var(--text-muted);">winners</span>
            </div>
            <div class="flex items-center gap-1.5">
                {% set roi = (venue_stats.pnl / venue_stats.staked * 100) if venue_stats.staked else 0 %}<span class="text-sm font-heading font-bold {% if roi >= 0 %}text-green-400{% else %}text-red-400{% endif %}">{{ '%+.1f'|format(roi) }}%</span>
                <span class="text-xs" style="color: var(--text-muted);">ROI</span>
            </div>
            <span class="text-xs" style="color: var(--text-muted);">across {{ venue_stats.meetings }} meeting{{ 's' if venue_stats.meetings != 1 }}</span>
        </div>
        {% endif %}

        <!-- Section Nav -->
        <nav class="section-nav" id="section-nav">
            <div class="section-nav-inner">
                {% if early_mail %}
                <a href="#section-early-mail" class="section-nav-item" data-section="section-early-mail">
                    <span class="section-nav-dot" style="background: var(--magenta);"></span>
                    Early Mail
                </a>
                <a href="#section-tips" class="section-nav-item" data-section="section-tips">
                    <span class="section-nav-dot" style="background: var(--cyan);"></span>
                    Tips
                </a>
                {% endif %}
                {% if live_updates %}
                <a href="#section-live" class="section-nav-item" data-section="section-live">
                    <span class="section-nav-dot" style="background: var(--orange);"></span>
                    Live
                </a>
                {% endif %}
                {% if wrapup %}
                <a href="#section-wrapup" class="section-nav-item" data-section="section-wrapup">
                    <span class="section-nav-dot" style="background: var(--purple);"></span>
                    Wrap-Up
                </a>
                {% endif %}
            </div>
        </nav>

        <!-- Meeting Stats (expandable) -->
        {% if meeting_stats %}
        <div class="mb-8" id="meeting-stats-section">
            <div class="section-toggle" onclick="toggleSection('meeting-stats')">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(157, 78, 221, 0.15);">
                        <svg class="w-5 h-5" style="color: var(--purple);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-display font-bold">
                        <span style="background: linear-gradient(135deg, var(--purple), var(--magenta)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Meeting Stats</span>
                    </h2>
                </div>
                <svg class="section-chevron" id="meeting-stats-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
            <div class="section-body" id="meeting-stats-body">
                <div id="ms-grid" class="pt-4"></div>
            </div>
        </div>
        {% endif %}

        <!-- Early Mail Section -->
        {% if early_mail %}
        <div class="mb-8" id="section-early-mail">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(233, 30, 140, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-display font-bold">
                    <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Early Mail</span>
                </h2>
            </div>
            <div class="tips-content" id="early-mail-content">
                {{ early_mail.content | safe }}
            </div>
        </div>
        {% endif %}

        <!-- Nuggets & Final Word (extracted from early mail by JS, rendered here) -->
        <div id="extracted-sections"></div>

        <!-- Live Updates Section (after tips, max 4 visible with scroll) -->
        {% if live_updates %}
        <div class="mb-8" id="section-live">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center live-pulse" style="background: rgba(255, 107, 53, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--orange);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-display font-bold">
                    <span style="background: linear-gradient(135deg, var(--orange), var(--yellow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Live Updates</span>
                </h2>
                <span class="live-badge">LIVE</span>
            </div>

            <div class="live-updates-scroll space-y-3">
                {% for update in live_updates %}
                <div class="live-update-card {% if update.type == 'celebration' %}live-celebration{% else %}live-pace{% endif %}">
                    <div class="flex items-start gap-3">
                        <div class="live-icon flex-shrink-0">
                            {% if update.type == 'celebration' %}
                            <span class="text-2xl">&#x1F3C7;</span>
                            {% else %}
                            <span class="text-2xl">&#x1F3C1;</span>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            {% if update.type == 'celebration' %}
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-heading font-bold text-sm uppercase tracking-wider" style="color: #4ade80;">Winner!</span>
                                {% if update.race_number %}
                                <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.08); color: var(--text-muted);">R{{ update.race_number }}</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-heading font-bold text-sm uppercase tracking-wider" style="color: var(--cyan);">Track Read</span>
                                <span class="text-xs px-2 py-0.5 rounded" style="background: rgba(255,255,255,0.08); color: var(--text-muted);">After R{{ update.race_number }}</span>
                            </div>
                            {% endif %}
                            <p class="text-sm leading-relaxed" style="color: var(--text-secondary);">{{ update.content }}</p>
                            {% if update.created_at %}
                            <div class="mt-2 text-xs" style="color: var(--text-muted);">{{ update.created_at }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Wrap-up Section -->
        {% if wrapup %}
        <div class="mb-8" id="section-wrapup">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(0, 212, 255, 0.15);">
                    <svg class="w-5 h-5" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-display font-bold">
                    <span style="background: linear-gradient(135deg, var(--cyan), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Wrap-Up</span>
                </h2>
            </div>
            <div class="card p-6">
                <div class="prose prose-invert max-w-none tips-content">
                    {{ wrapup.content | safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- No Content Message -->
        {% if not early_mail and not wrapup %}
        <div class="card p-12 text-center">
            <div class="text-6xl mb-4">&#x1F3C7;</div>
            <h2 class="text-2xl font-heading font-bold mb-2">No Tips Available</h2>
            <p style="color: var(--text-secondary);">
                Tips for this meeting haven't been published yet. Check back soon!
            </p>
        </div>
        {% endif %}

        <!-- CTA -->
        <div class="card p-6 text-center mt-8" style="background: linear-gradient(135deg, rgba(233, 30, 140, 0.1), rgba(255, 107, 53, 0.1));">
            <p class="font-heading font-semibold text-white mb-2">Want more tips?</p>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">Browse all of Punty's past and present tips right here.</p>
            <a href="/tips" class="btn-primary inline-flex items-center gap-2">
                Browse All Tips
            </a>
        </div>
    </div>
</section>

<style>
    /* Section Nav */
    .section-nav {
        position: sticky; top: 0; z-index: 40;
        margin: 0 -1rem 1.5rem; padding: 0 1rem;
        background: rgba(10, 10, 15, 0.85);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-subtle);
    }
    .section-nav-inner {
        display: flex; gap: 0.25rem;
        overflow-x: auto; scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 0.5rem 0;
    }
    .section-nav-inner::-webkit-scrollbar { display: none; }
    .section-nav-item {
        display: inline-flex; align-items: center; gap: 0.375rem;
        padding: 0.375rem 0.875rem; border-radius: 9999px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.8rem;
        letter-spacing: 0.04em; text-transform: uppercase;
        color: var(--text-muted); white-space: nowrap;
        border: 1px solid transparent;
        transition: all 0.15s; text-decoration: none; cursor: pointer;
    }
    .section-nav-item:hover {
        color: var(--text-secondary);
        background: rgba(255, 255, 255, 0.05);
    }
    .section-nav-item.active {
        color: white;
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.12);
    }
    .section-nav-dot {
        width: 6px; height: 6px; border-radius: 50%;
        opacity: 0.5; transition: opacity 0.15s;
    }
    .section-nav-item.active .section-nav-dot { opacity: 1; }
    @media (min-width: 640px) {
        .section-nav { margin: 0 -2rem 1.5rem; padding: 0 2rem; }
    }

    /* Tips Content */
    .tips-content {
        font-family: 'Source Sans Pro', sans-serif;
        line-height: 1.8;
        color: #d0d0dc;
    }
    .tips-content p { margin-bottom: 1rem; }
    .tips-content strong, .tips-content b { color: white; font-weight: 600; }
    .tips-content .tips-heading {
        color: white;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    .tips-content h2.tips-heading {
        font-size: 1.5rem;
        background: var(--gradient-sunset);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .tips-content h3.tips-heading { font-size: 1.25rem; color: var(--cyan); }
    .tips-content h4.tips-heading { font-size: 1.1rem; color: var(--magenta); }
    .tips-content .tips-list { margin: 1rem 0; padding-left: 1.5rem; }
    .tips-content .tips-list li { margin-bottom: 0.5rem; }
    .tips-content .tips-divider { border: none; border-top: 1px solid var(--border-subtle); margin: 1.5rem 0; }
    .tips-content em { font-style: italic; color: var(--text-muted); }

    /* Win Badge */
    .win-tick {
        display: inline-flex; align-items: center; gap: 5px;
        font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 0.75em;
        letter-spacing: 0.15em; text-transform: uppercase;
        margin-left: 10px; padding: 4px 12px 4px 10px; border-radius: 6px;
        background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff;
        box-shadow: 0 0 12px rgba(34, 197, 94, 0.5), 0 0 24px rgba(34, 197, 94, 0.2);
        animation: win-glow 1.8s ease-in-out infinite;
        vertical-align: middle; line-height: 1.2;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .win-tick .win-emoji { font-size: 1.3em; line-height: 1; filter: drop-shadow(0 0 3px rgba(255, 215, 0, 0.6)); }
    @keyframes win-glow {
        0%, 100% { box-shadow: 0 0 12px rgba(34, 197, 94, 0.5), 0 0 24px rgba(34, 197, 94, 0.2); }
        50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.7), 0 0 40px rgba(34, 197, 94, 0.35); }
    }
    .puntys-pick {
        display: inline-block;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.15), rgba(233, 30, 140, 0.15));
        border: 1px solid rgba(255, 107, 53, 0.25);
        border-radius: 6px; padding: 2px 8px; margin-right: 4px;
    }
    .puntys-pick strong {
        background: var(--gradient-sunset);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* Live Updates */
    .live-badge {
        display: inline-flex; align-items: center; gap: 6px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.7rem;
        letter-spacing: 0.1em; padding: 2px 10px; border-radius: 9999px;
        background: rgba(255, 107, 53, 0.2); color: var(--orange);
        border: 1px solid rgba(255, 107, 53, 0.3);
    }
    .live-badge::before {
        content: ''; width: 6px; height: 6px; border-radius: 50%;
        background: var(--orange); animation: live-dot 1.5s ease-in-out infinite;
    }
    @keyframes live-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .live-pulse { animation: pulse-glow 2s ease-in-out infinite; }
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.2); }
        50% { box-shadow: 0 0 12px 4px rgba(255, 107, 53, 0.15); }
    }
    .live-update-card {
        padding: 1rem 1.25rem; border-radius: 12px;
        border-left: 3px solid transparent; transition: transform 0.15s, box-shadow 0.15s;
    }
    .live-update-card:hover { transform: translateX(4px); }
    .live-celebration {
        background: linear-gradient(135deg, rgba(74, 222, 128, 0.06), rgba(255, 107, 53, 0.06));
        border: 1px solid rgba(74, 222, 128, 0.12); border-left: 3px solid #4ade80;
    }
    .live-pace {
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.06), rgba(157, 78, 221, 0.06));
        border: 1px solid rgba(0, 212, 255, 0.12); border-left: 3px solid var(--cyan);
    }
    .live-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .live-updates-scroll {
        max-height: 420px; /* ~4 cards */
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 107, 53, 0.3) transparent;
    }
    .live-updates-scroll::-webkit-scrollbar { width: 6px; }
    .live-updates-scroll::-webkit-scrollbar-track { background: transparent; }
    .live-updates-scroll::-webkit-scrollbar-thumb {
        background: rgba(255, 107, 53, 0.3); border-radius: 3px;
    }
    .live-updates-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 107, 53, 0.5);
    }

    /* Section Toggle (expandable sections) */
    .section-toggle {
        display: flex; align-items: center; justify-content: space-between;
        padding: 1rem 1.25rem; cursor: pointer; user-select: none;
        border-radius: 12px; border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02); transition: background 0.15s;
    }
    .section-toggle:hover { background: rgba(255, 255, 255, 0.05); }
    .section-chevron {
        width: 1.25rem; height: 1.25rem; color: var(--text-muted);
        transition: transform 0.2s;
    }
    .section-body { display: none; }
    .section-open .section-toggle { border-radius: 12px 12px 0 0; border-bottom: 1px solid var(--border-subtle); }
    .section-open .section-body {
        display: block; padding: 0 1.25rem 1.25rem;
        border: 1px solid var(--border-subtle); border-top: none; border-radius: 0 0 12px 12px;
        background: rgba(255, 255, 255, 0.01);
    }
    .section-open .section-chevron { transform: rotate(180deg); }

    /* Race Accordion */
    .race-accordion {
        border: 1px solid var(--border-subtle);
        border-radius: 12px; margin-bottom: 0.75rem; overflow: hidden;
    }
    .race-accordion-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 0.875rem 1.25rem; cursor: pointer; user-select: none;
        background: rgba(255, 255, 255, 0.02); transition: background 0.15s;
    }
    .race-accordion-header:hover { background: rgba(255, 255, 255, 0.05); }
    .race-accordion-header .accordion-chevron {
        transition: transform 0.2s; color: var(--text-muted);
    }
    .race-accordion.open .accordion-chevron { transform: rotate(180deg); }
    .race-accordion-body { display: none; padding: 0 1.25rem 1.25rem; }
    .race-accordion.open .race-accordion-body { display: block; }
    .race-nav { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .race-nav-pill {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 2.5rem; padding: 0.25rem 0.75rem; border-radius: 9999px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.85rem;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
        color: var(--text-secondary); cursor: pointer; transition: all 0.15s;
    }
    .race-nav-pill:hover, .race-nav-pill.active {
        background: var(--gradient-sunset); color: white; border-color: transparent;
    }
    .race-pill {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 2.25rem; height: 2.25rem; border-radius: 8px;
        font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 0.75rem;
        background: var(--gradient-sunset); color: white; flex-shrink: 0;
    }

    /* Results badge on race header */
    .fg-results-badge {
        font-size: 0.6rem; font-family: 'Rajdhani', sans-serif; font-weight: 700;
        padding: 1px 6px; border-radius: 4px;
        background: rgba(74, 222, 128, 0.15); color: #4ade80;
        text-transform: uppercase; letter-spacing: 0.05em;
    }

    /* Punty's Pick Block (highlighted at bottom of race) */
    .puntys-pick-block {
        margin-top: 1rem; padding: 0.875rem 1rem; border-radius: 10px;
        border-left: 3px solid var(--magenta);
        background: linear-gradient(135deg, rgba(233, 30, 140, 0.06), rgba(255, 107, 53, 0.06));
    }
    .puntys-pick-block p { margin-bottom: 0.25rem; }

    /* Selection metadata labels */
    .sel-label {
        display: inline-block; font-family: 'Rajdhani', sans-serif; font-weight: 700;
        font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em;
        padding: 1px 5px; border-radius: 3px; margin-right: 3px;
        background: rgba(255, 255, 255, 0.06); color: var(--text-muted); vertical-align: baseline;
    }
    .sel-bet { color: var(--cyan); }
    .sel-bet .sel-label { color: var(--cyan); background: rgba(0, 212, 255, 0.1); }
    .sel-winpct { color: var(--text-secondary); }
    .sel-winpct .sel-label { background: rgba(157, 78, 221, 0.1); color: var(--purple); }
    .sel-conf .sel-label { background: rgba(255, 255, 255, 0.06); }
    .sel-conf-hig { color: #4ade80; font-weight: 700; }
    .sel-conf-med { color: var(--yellow); font-weight: 700; }
    .sel-conf-low { color: var(--text-muted); font-weight: 700; }
    .sel-why { color: var(--text-secondary); font-style: italic; }
    .sel-why .sel-label { color: var(--orange); background: rgba(255, 107, 53, 0.1); font-style: normal; }
    .sel-prob { color: var(--text-secondary); position: relative; }
    .sel-prob .sel-label { color: var(--magenta); background: rgba(233, 30, 140, 0.1); }
    .prob-help { display: inline-block; width: 14px; height: 14px; line-height: 14px; text-align: center;
        font-size: 9px; font-weight: 700; font-style: normal; border-radius: 50%; cursor: pointer;
        color: var(--magenta); border: 1px solid var(--magenta); vertical-align: middle; margin-left: 4px; opacity: 0.6; }
    .prob-help:hover { opacity: 1; }
    .prob-tooltip { display: none; position: absolute; top: 100%; left: 0; margin-top: 6px;
        background: #1a1a2e; border: 1px solid rgba(233, 30, 140, 0.3); border-radius: 8px;
        padding: 8px 12px; width: 260px; z-index: 50; font-size: 0.75rem; color: var(--text-secondary);
        line-height: 1.4; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .prob-tooltip.active { display: block; }

    /* Overview section (intro before Big 3) */
    .overview-section {
        margin-bottom: 1.25rem; padding: 1.5rem; border-radius: 12px;
        border: 1px solid rgba(233, 30, 140, 0.15);
        background: linear-gradient(135deg, rgba(233, 30, 140, 0.04), rgba(0, 212, 255, 0.03));
    }
    .overview-section > p:first-child { font-size: 1.05rem; line-height: 1.75; }
    .overview-section h3.tips-heading,
    .overview-section h4.tips-heading {
        margin-top: 1.25rem; margin-bottom: 0.5rem; padding-bottom: 0.35rem;
        border-bottom: 1px solid rgba(233, 30, 140, 0.15);
    }
    .overview-label strong {
        font-family: 'Rajdhani', sans-serif; font-size: 0.8rem;
        letter-spacing: 0.06em; text-transform: uppercase;
        color: var(--cyan) !important; -webkit-text-fill-color: var(--cyan) !important;
    }

    /* Mobile: shrink winner badges to prevent overflow */
    @media (max-width: 640px) {
        .win-tick {
            font-size: 0.6em; margin-left: 4px; padding: 2px 7px 2px 6px;
            letter-spacing: 0.08em; gap: 3px;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        .win-tick .win-emoji { font-size: 1.1em; }
        .race-accordion-body p { overflow-wrap: break-word; word-break: break-word; }
    }

    /* Sequence Lanes section divider */
    .sequence-divider {
        display: flex; align-items: center; gap: 1rem;
        margin: 1.5rem 0 0.75rem 0; padding: 0 0.25rem;
    }
    .sequence-divider-line {
        flex: 1; height: 1px;
        background: linear-gradient(90deg, transparent, var(--yellow), transparent);
        opacity: 0.4;
    }
    .sequence-divider-label {
        font-family: 'Orbitron', sans-serif; font-size: 0.7rem; font-weight: 700;
        letter-spacing: 0.15em; text-transform: uppercase;
        background: linear-gradient(135deg, var(--yellow), var(--orange));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        white-space: nowrap;
    }

    /* Open sections (Nuggets, Final Word) */
    .open-section {
        margin: 1.5rem 0;
    }
    .open-section-title {
        display: flex; align-items: center; gap: 1rem;
        margin-bottom: 1rem; padding: 0 0.25rem;
    }
    .open-section-line {
        flex: 1; height: 1px; opacity: 0.3;
    }
    .open-section-label {
        font-family: 'Rajdhani', sans-serif; font-size: 1.25rem; font-weight: 700;
        white-space: nowrap;
    }
    .nuggets-label {
        color: var(--cyan);
    }
    .final-word-label {
        color: var(--purple);
    }
    .open-section-body {
        padding: 0 0.5rem;
        font-family: 'Source Sans Pro', sans-serif;
        line-height: 1.8; color: #d0d0dc;
    }
    .open-section-body p { margin-bottom: 0.75rem; }
    .open-section-body strong, .open-section-body b { color: white; font-weight: 600; }

    /* Sequence results card */
    .seq-results-card {
        margin-top: 1rem; padding: 0.75rem 1rem; border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-subtle);
    }
    .seq-results-title {
        font-family: 'Orbitron', sans-serif; font-size: 0.6rem; font-weight: 700;
        letter-spacing: 0.15em; text-transform: uppercase;
        color: var(--text-muted); margin-bottom: 0.5rem;
    }
    .seq-result-row {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.4rem 0; font-family: 'Rajdhani', sans-serif; font-size: 0.85rem;
    }
    .seq-result-row + .seq-result-row {
        border-top: 1px solid rgba(255, 255, 255, 0.04);
    }
    .seq-result-label {
        flex: 1; color: var(--text-secondary); font-weight: 500;
    }
    .seq-result-status {
        font-weight: 700; font-size: 0.7rem; letter-spacing: 0.08em;
        padding: 2px 8px; border-radius: 4px;
    }
    .seq-result-win .seq-result-status {
        background: rgba(74, 222, 128, 0.15); color: #4ade80;
    }
    .seq-result-loss .seq-result-status {
        background: rgba(248, 113, 113, 0.15); color: #f87171;
    }
    .seq-result-push .seq-result-status {
        background: rgba(250, 204, 21, 0.15); color: #facc15;
    }
    .seq-result-pnl {
        font-weight: 700; min-width: 70px; text-align: right;
    }
    .seq-result-win .seq-result-pnl { color: #4ade80; }
    .seq-result-loss .seq-result-pnl { color: #f87171; }
    .seq-result-push .seq-result-pnl { color: #facc15; }

    /* Exotic title */
    .exotic-title {
        display: block;
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700; font-size: 0.85rem;
        text-transform: uppercase; letter-spacing: 0.08em;
        color: var(--yellow);
        margin-top: 0.75rem; margin-bottom: 0.25rem;
    }

    /* Sequence variant cards */
    .seq-variant-card {
        margin-bottom: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02);
    }
    .seq-variant-skinny {
        border-color: rgba(0, 212, 255, 0.25);
        background: linear-gradient(135deg, rgba(0, 212, 255, 0.06), rgba(0, 212, 255, 0.02));
    }
    .seq-variant-balanced {
        border-color: rgba(233, 30, 140, 0.25);
        background: linear-gradient(135deg, rgba(233, 30, 140, 0.06), rgba(233, 30, 140, 0.02));
    }
    .seq-variant-wide {
        border-color: rgba(255, 107, 53, 0.25);
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.06), rgba(255, 107, 53, 0.02));
    }
    .seq-variant-badge {
        display: inline-flex; align-items: center;
        font-family: 'Orbitron', sans-serif; font-weight: 800;
        font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase;
        padding: 3px 10px; border-radius: 6px; margin-right: 0.5rem;
    }
    .seq-variant-skinny .seq-variant-badge {
        background: rgba(0, 212, 255, 0.15); color: var(--cyan);
    }
    .seq-variant-balanced .seq-variant-badge {
        background: rgba(233, 30, 140, 0.15); color: var(--magenta);
    }
    .seq-variant-wide .seq-variant-badge {
        background: rgba(255, 107, 53, 0.15); color: var(--orange);
    }
    .seq-variant-cost {
        font-family: 'Orbitron', sans-serif; font-weight: 700;
        font-size: 0.8rem; color: white;
    }
    .seq-legs {
        display: flex; flex-wrap: wrap; align-items: center; gap: 0.25rem;
        margin-top: 0.5rem;
    }
    .seq-leg {
        display: inline-flex; align-items: center; gap: 0.25rem;
    }
    .seq-leg-pill {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 1.5rem; height: 1.5rem; padding: 0 0.35rem;
        border-radius: 4px; font-family: 'Rajdhani', sans-serif;
        font-weight: 700; font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.08); color: var(--text-secondary);
    }
    .seq-leg-sep {
        color: var(--text-muted); font-weight: 700; font-size: 0.9rem;
        margin: 0 0.125rem;
    }
    .seq-return {
        font-family: 'Rajdhani', sans-serif; font-weight: 700;
        font-size: 0.75rem; letter-spacing: 0.05em;
        padding: 2px 8px; border-radius: 4px;
        background: rgba(74, 222, 128, 0.1); color: #4ade80;
    }
    .seq-combos {
        font-family: 'Rajdhani', sans-serif; font-weight: 500;
        font-size: 0.75rem; color: var(--text-muted);
    }
    .seq-puntys-pick {
        margin-top: 0.75rem; padding: 0.625rem 0.875rem;
        border-radius: 8px; border-left: 3px solid var(--magenta);
        background: linear-gradient(135deg, rgba(233, 30, 140, 0.06), rgba(255, 107, 53, 0.06));
    }
    .seq-puntys-pick p { margin-bottom: 0; }
    @media (max-width: 640px) {
        .seq-variant-card { padding: 0.625rem 0.75rem; }
        .seq-legs { gap: 0.125rem; }
        .seq-leg-pill { min-width: 1.25rem; height: 1.25rem; font-size: 0.7rem; }
    }

    /* Race countdown timer */
    .race-countdown {
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.65rem;
        padding: 2px 8px; border-radius: 4px; white-space: nowrap; margin-right: 0.5rem;
        background: rgba(255, 107, 53, 0.15); color: var(--orange); letter-spacing: 0.03em;
    }
    .race-countdown-now {
        background: rgba(74, 222, 128, 0.15); color: #4ade80;
        animation: pulse-glow 1.5s ease-in-out infinite;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var racesData = {{ races | tojson }};
    var meetingStats = {{ meeting_stats | tojson }};
    var winners = {{ winners | tojson }};
    var winExotics = {{ winning_exotics | tojson }};
    var winSequences = {{ winning_sequences | tojson }};
    var seqResults = {{ sequence_results | tojson }};
    var meetingDate = '{{ meeting.date }}';

    // --- Section toggle ---
    window.toggleSection = function(id) {
        var section = document.getElementById(id + '-section');
        if (section) section.classList.toggle('section-open');
    };

    // --- Meeting Stats ---
    (function() {
        var container = document.getElementById('ms-grid');
        if (!container || !meetingStats || meetingStats.length === 0) return;

        var catColors = { Selections: 'var(--magenta)', Exotics: 'var(--cyan)', Sequences: 'var(--yellow)', Multi: 'var(--purple)' };
        var groups = { Selections: [], Exotics: [], Sequences: [], Multi: [] };
        meetingStats.forEach(function(s) { if (groups[s.category]) groups[s.category].push(s); });

        var html = '';
        ['Selections', 'Exotics', 'Sequences', 'Multi'].forEach(function(cat) {
            if (groups[cat].length === 0) return;
            var color = catColors[cat];
            html += '<div class="mb-4"><h3 class="font-heading font-bold text-xs uppercase tracking-wider mb-2" style="color: ' + color + ';">' + cat + '</h3>';
            html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-2">';
            groups[cat].forEach(function(s) {
                var roi = s.staked ? (s.pnl / s.staked * 100) : 0;
                var pnlColor = roi >= 0 ? '#4ade80' : '#f87171';
                html += '<div class="rounded-lg p-3 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">';
                html += '<div class="text-[10px] font-heading font-semibold uppercase tracking-wider mb-1" style="color: ' + color + ';">' + s.type + '</div>';
                html += '<div class="text-xl font-display font-bold" style="color: ' + color + ';">' + s.rate + '%</div>';
                html += '<div class="text-[9px] font-heading uppercase tracking-wider mt-0.5 mb-0.5" style="color: var(--text-muted);">strike rate</div>';
                html += '<div class="text-[10px]" style="color: var(--text-muted);">' + s.won + '/' + s.total + ' winners</div>';
                html += '<div class="text-xs font-heading font-semibold mt-0.5" style="color: ' + pnlColor + ';">' + (roi >= 0 ? '+' : '') + roi.toFixed(1) + '% ROI</div>';
                html += '</div>';
            });
            html += '</div></div>';
        });
        container.innerHTML = html;
    })();

    // --- Race data lookup ---
    function findRaceData(raceNum) {
        for (var i = 0; i < racesData.length; i++) {
            if (racesData[i].num === raceNum) return racesData[i];
        }
        return null;
    }

    // --- Build Race Accordion Header ---
    function buildRaceHeader(heading, raceData) {
        var headerHtml = '<div class="flex items-center gap-3 flex-1 min-w-0">';
        if (raceData) {
            headerHtml += '<span class="race-pill">R' + raceData.num + '</span>';
            headerHtml += '<div class="min-w-0">';
            headerHtml += '<div class="font-heading font-bold text-white text-sm truncate">' + (raceData.name || 'Race ' + raceData.num) + '</div>';
            var meta = [];
            if (raceData.dist) meta.push(raceData.dist + 'm');
            if (raceData.cls) meta.push(raceData.cls);
            if (raceData.prize) meta.push('$' + (raceData.prize >= 1000 ? Math.round(raceData.prize / 1000) + 'K' : raceData.prize));
            if (raceData.time) meta.push(raceData.time);
            if (meta.length) headerHtml += '<div class="text-xs" style="color: var(--text-muted);">' + meta.join(' · ') + '</div>';
            headerHtml += '</div>';
        } else {
            headerHtml += '<span>' + heading.outerHTML + '</span>';
        }
        headerHtml += '</div>';

        // Status badge or countdown
        if (raceData) {
            if (raceData.status && ['Paying', 'Closed', 'Final'].indexOf(raceData.status) !== -1) {
                headerHtml += '<span class="fg-results-badge mr-2">Final</span>';
            } else if (raceData.time && meetingDate) {
                // Countdown for upcoming races (AEDT = +11:00)
                var raceMs = Date.parse(meetingDate + 'T' + raceData.time + ':00+11:00');
                if (!isNaN(raceMs)) {
                    var diff = raceMs - Date.now();
                    if (diff > 0 && diff < 24 * 60 * 60 * 1000) {
                        var mins = Math.floor(diff / 60000);
                        var hrs = Math.floor(mins / 60);
                        mins = mins % 60;
                        var label = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm';
                        headerHtml += '<span class="race-countdown" data-race-time="' + raceMs + '">' + label + '</span>';
                    }
                }
            }
        }

        return headerHtml;
    }

    // --- Process Early Mail Content ---
    var tipsContent = document.getElementById('early-mail-content');
    if (!tipsContent) return;

    var headings = tipsContent.querySelectorAll('h2.tips-heading, h3.tips-heading');
    var raceHeadings = [];
    var seqHeadings = [];
    headings.forEach(function(h) {
        if (/Race\s+\d+/i.test(h.textContent)) {
            raceHeadings.push(h);
        } else if (/Quaddie|Big\s*6|Early\s+Quaddie|NUGGETS|FINAL\s+WORD|SEQUENCE\s+LANES/i.test(h.textContent)) {
            seqHeadings.push(h);
        }
    });

    if (raceHeadings.length < 2) return;

    // Collect all section headings in DOM order
    var allHeadings = raceHeadings.concat(seqHeadings);
    allHeadings.sort(function(a, b) {
        if (a === b) return 0;
        return a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1;
    });

    // Collect pre-race content (intro/Big 3)
    var preRaceNodes = [];
    var node = tipsContent.firstChild;
    while (node && node !== allHeadings[0]) {
        preRaceNodes.push(node);
        node = node.nextSibling;
    }

    // Collect sections (race + sequence)
    var sections = [];
    for (var i = 0; i < allHeadings.length; i++) {
        var sectionNodes = [];
        var current = allHeadings[i].nextSibling;
        var nextHeading = allHeadings[i + 1] || null;
        while (current && current !== nextHeading) {
            sectionNodes.push(current);
            current = current.nextSibling;
        }
        var isRace = /Race\s+\d+/i.test(allHeadings[i].textContent);
        var raceNum = null;
        if (isRace) {
            var rm = allHeadings[i].textContent.match(/Race\s+(\d+)/i);
            raceNum = rm ? parseInt(rm[1]) : null;
        }
        sections.push({ heading: allHeadings[i], nodes: sectionNodes, isRace: isRace, raceNum: raceNum });
    }

    // Rebuild content
    tipsContent.innerHTML = '';

    // Split intro: overview (visible) + Big 3 (expandable accordion)
    var hasIntro = false;
    for (var pi = 0; pi < preRaceNodes.length; pi++) {
        if (preRaceNodes[pi].textContent && preRaceNodes[pi].textContent.trim()) { hasIntro = true; break; }
    }
    if (hasIntro) {
        // Find the Big 3 heading to split overview from Big 3
        var big3Idx = -1;
        var big3Re = /BIG\s*3|BIG\s*THREE|PUNTY.S\s+BIG/i;
        for (var pi = 0; pi < preRaceNodes.length; pi++) {
            var n = preRaceNodes[pi];
            if (n.nodeType !== 1) continue;
            // Check h2-h4 headings
            if (/^H[2-4]$/.test(n.tagName) && big3Re.test(n.textContent)) {
                big3Idx = pi; break;
            }
            // Fallback: bold text in paragraph (AI may omit ### prefix)
            if (n.tagName === 'P') {
                var sEl = n.querySelector('strong');
                if (sEl && big3Re.test(sEl.textContent)) { big3Idx = pi; break; }
            }
        }

        if (big3Idx > 0) {
            // Overview section (shown directly, no accordion)
            var overviewDiv = document.createElement('div');
            overviewDiv.className = 'overview-section';
            for (var oi = 0; oi < big3Idx; oi++) {
                overviewDiv.appendChild(preRaceNodes[oi]);
            }
            // Style paragraphs that start with a bold label (e.g., "Punty's take:")
            overviewDiv.querySelectorAll('p').forEach(function(p) {
                var first = p.querySelector('strong:first-child');
                if (first && /:/.test(first.textContent)) {
                    p.classList.add('overview-label');
                }
            });
            tipsContent.appendChild(overviewDiv);

            // Big 3 + Multi accordion (collapsed by default)
            var big3Acc = document.createElement('div');
            big3Acc.className = 'race-accordion';
            big3Acc.id = 'big3-acc';
            var big3Header = document.createElement('div');
            big3Header.className = 'race-accordion-header';
            big3Header.innerHTML = '<div class="flex items-center gap-3"><span class="race-pill" style="background: linear-gradient(135deg, var(--purple), var(--magenta));">&#9733;</span><div><div class="font-heading font-bold text-white text-sm">Big 3 & Multi</div></div></div>' +
                '<svg class="accordion-chevron w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
            big3Header.onclick = function() { big3Acc.classList.toggle('open'); };
            var big3Body = document.createElement('div');
            big3Body.className = 'race-accordion-body';
            for (var bi = big3Idx; bi < preRaceNodes.length; bi++) {
                big3Body.appendChild(preRaceNodes[bi]);
            }
            big3Acc.appendChild(big3Header);
            big3Acc.appendChild(big3Body);
            tipsContent.appendChild(big3Acc);
        } else {
            // No Big 3 found — show everything directly
            var overviewDiv = document.createElement('div');
            overviewDiv.className = 'overview-section';
            preRaceNodes.forEach(function(n) { overviewDiv.appendChild(n); });
            tipsContent.appendChild(overviewDiv);
        }
    }

    // Nav pills
    var navContainer = document.createElement('div');
    navContainer.className = 'race-nav';
    navContainer.id = 'section-tips';
    sections.forEach(function(sec, idx) {
        if (!sec.isRace) return;
        var pill = document.createElement('button');
        pill.className = 'race-nav-pill';
        pill.textContent = 'R' + sec.raceNum;
        pill.setAttribute('data-idx', idx);
        pill.onclick = function() {
            var acc = document.getElementById('sec-acc-' + idx);
            if (acc) {
                acc.classList.add('open');
                acc.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };
        navContainer.appendChild(pill);
    });
    tipsContent.appendChild(navContainer);

    // Race and sequence sections
    sections.forEach(function(sec, idx) {
        // "SEQUENCE LANES" becomes a styled section divider, not an accordion
        if (!sec.isRace && /SEQUENCE\s+LANES/i.test(sec.heading.textContent)) {
            var divider = document.createElement('div');
            divider.className = 'sequence-divider';
            divider.innerHTML = '<div class="sequence-divider-line"></div>' +
                '<span class="sequence-divider-label">Sequence Lanes</span>' +
                '<div class="sequence-divider-line"></div>';
            tipsContent.appendChild(divider);
            return;
        }

        // NUGGETS and FINAL WORD render as open sections OUTSIDE the tips accordion
        // They get placed in the #extracted-sections container (between tips and live updates)
        if (!sec.isRace && /NUGGETS|FINAL\s+WORD/i.test(sec.heading.textContent)) {
            var extractedContainer = document.getElementById('extracted-sections');
            if (extractedContainer) {
                var isNuggets = /NUGGETS/i.test(sec.heading.textContent);
                var lineColor = isNuggets ? 'var(--cyan)' : 'var(--purple)';
                var lineGrad = 'linear-gradient(90deg, transparent, ' + lineColor + ', transparent)';
                var sectionDiv = document.createElement('div');
                sectionDiv.className = 'open-section';
                var titleDiv = document.createElement('div');
                titleDiv.className = 'open-section-title';
                titleDiv.innerHTML = '<div class="open-section-line" style="background:' + lineGrad + '"></div>' +
                    '<span class="open-section-label ' + (isNuggets ? 'nuggets-label' : 'final-word-label') + '">' +
                    sec.heading.textContent + '</span>' +
                    '<div class="open-section-line" style="background:' + lineGrad + '"></div>';
                sectionDiv.appendChild(titleDiv);
                var contentDiv = document.createElement('div');
                contentDiv.className = 'open-section-body';
                sec.nodes.forEach(function(n) { contentDiv.appendChild(n); });
                sectionDiv.appendChild(contentDiv);
                extractedContainer.appendChild(sectionDiv);
            }
            return;
        }

        var accordion = document.createElement('div');
        accordion.className = 'race-accordion';
        accordion.id = 'sec-acc-' + idx;

        var header = document.createElement('div');
        header.className = 'race-accordion-header';

        var raceData = sec.isRace ? findRaceData(sec.raceNum) : null;
        header.innerHTML = buildRaceHeader(sec.heading, raceData) +
            '<svg class="accordion-chevron w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
        header.onclick = function() { accordion.classList.toggle('open'); };

        var body = document.createElement('div');
        body.className = 'race-accordion-body';

        // Add the original content nodes
        sec.nodes.forEach(function(n) { body.appendChild(n); });

        // Reorder: move exotic after roughie, then move Punty's Pick to bottom
        if (sec.isRace) {
            // Find exotic and roughie paragraphs
            var allParas = body.querySelectorAll('p');
            var exoticP = null;
            var roughieP = null;
            for (var k = 0; k < allParas.length; k++) {
                var ptxt = allParas[k].textContent.trim();
                if (!exoticP && /^(Trifecta|Exacta|Quinella|First\s*(?:Four|4))\s*:/i.test(ptxt)) {
                    exoticP = allParas[k];
                }
                if (!roughieP && /Roughie\s*:/i.test(ptxt)) {
                    roughieP = allParas[k];
                }
            }
            // Move exotic after roughie if both exist and exotic is before roughie
            if (exoticP && roughieP && roughieP.compareDocumentPosition(exoticP) & Node.DOCUMENT_POSITION_PRECEDING) {
                if (roughieP.nextSibling) {
                    body.insertBefore(exoticP, roughieP.nextSibling);
                } else {
                    body.appendChild(exoticP);
                }
            }

            // Move Punty's Pick to bottom + highlight
            var pickEl = body.querySelector('.puntys-pick');
            if (pickEl) {
                var pickP = pickEl.closest('p') || pickEl.parentElement;
                var pickNodes = [pickP];
                // Grab explanation paragraph but exclude exotic lines
                var nextSib = pickP.nextElementSibling;
                if (nextSib && nextSib.tagName === 'P' &&
                    !nextSib.querySelector('strong:first-child') &&
                    !/^(Trifecta|Exacta|Quinella|First\s*(?:Four|4))\s*:/i.test(nextSib.textContent.trim())) {
                    pickNodes.push(nextSib);
                }
                var pickWrap = document.createElement('div');
                pickWrap.className = 'puntys-pick-block';
                pickNodes.forEach(function(n) { pickWrap.appendChild(n); });
                body.appendChild(pickWrap);
            }
        }

        // For race sections, move exotic title with exotic paragraph
        if (sec.isRace) {
            // Find and move exotic title (.exotic-title) together with exotic paragraph
            var allEls = body.querySelectorAll('p, .exotic-title');
            var exoticTitle = null;
            var exoticLine = null;
            for (var et = 0; et < allEls.length; et++) {
                var el = allEls[et];
                if (el.classList && el.classList.contains('exotic-title')) {
                    exoticTitle = el;
                }
                if (el.tagName === 'P' && /^(Trifecta|Exacta|Quinella|First\s*(?:Four|4))\s*:/i.test(el.textContent.trim())) {
                    exoticLine = el;
                }
            }
            if (exoticTitle && exoticLine && exoticTitle !== exoticLine) {
                // Move title immediately before exotic line
                exoticLine.parentNode.insertBefore(exoticTitle, exoticLine);
            }

            // Add probability help tooltips (click to toggle)
            var probSpans = body.querySelectorAll('.sel-prob');
            probSpans.forEach(function(sp) {
                if (sp.querySelector('.prob-help')) return;
                var help = document.createElement('span');
                help.className = 'prob-help';
                help.textContent = '?';
                var tip = document.createElement('span');
                tip.className = 'prob-tooltip';
                tip.innerHTML = 'Calculated by our 9-factor probability engine using market odds, form, pace, barriers, connections and more. <a href="/how-it-works#step-2" style="color:var(--magenta);text-decoration:underline;">How it works</a>';
                help.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Close any other open tooltips
                    document.querySelectorAll('.prob-tooltip.active').forEach(function(t) {
                        if (t !== tip) t.classList.remove('active');
                    });
                    tip.classList.toggle('active');
                });
                sp.appendChild(help);
                sp.appendChild(tip);
            });
            // Close tooltips when clicking elsewhere
            document.addEventListener('click', function() {
                document.querySelectorAll('.prob-tooltip.active').forEach(function(t) {
                    t.classList.remove('active');
                });
            });
        }

        // Non-race sections: style variant cards + different pill style + sequence results
        if (!sec.isRace) {
            // Style Skinny/Balanced/Wide as colored cards
            styleSequenceVariants(body);
            var seqPill = '<span class="race-pill" style="background: linear-gradient(135deg, var(--yellow), var(--orange));">&#9830;</span>';
            header.innerHTML = '<div class="flex items-center gap-3">' + seqPill +
                '<div class="font-heading font-bold text-white text-sm">' + sec.heading.textContent + '</div></div>' +
                '<svg class="accordion-chevron w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';

            // Add sequence results card if we have settled data
            if (seqResults && seqResults.length > 0) {
                var headingText = (sec.heading.textContent || '').toLowerCase();
                // Find matching results for this section
                var matchedResults = seqResults.filter(function(sr) {
                    var sType = (sr.type || '').toLowerCase();
                    if (/early\s*quaddie/i.test(headingText)) return sType === 'early_quaddie';
                    if (/quaddie/i.test(headingText) && !/early/i.test(headingText)) return sType === 'quaddie';
                    if (/big\s*6/i.test(headingText)) return sType === 'big6';
                    if (/multi/i.test(headingText) || /big\s*3/i.test(headingText)) return sType === 'big3_multi';
                    return false;
                });

                if (matchedResults.length > 0) {
                    var resultsHtml = '<div class="seq-results-card">';
                    resultsHtml += '<div class="seq-results-title">Results</div>';
                    matchedResults.forEach(function(sr) {
                        var isWin = sr.hit && sr.pnl > 0;
                        var pnlStr = sr.pnl >= 0 ? '+$' + sr.pnl.toFixed(2) : '-$' + Math.abs(sr.pnl).toFixed(2);
                        var statusClass = isWin ? 'seq-result-win' : (sr.hit ? 'seq-result-push' : 'seq-result-loss');
                        var statusLabel = isWin ? 'HIT' : 'MISS';
                        resultsHtml += '<div class="seq-result-row ' + statusClass + '">' +
                            '<span class="seq-result-label">' + sr.label + '</span>' +
                            '<span class="seq-result-status">' + statusLabel + '</span>' +
                            '<span class="seq-result-pnl">' + pnlStr + '</span>' +
                            '</div>';
                    });
                    resultsHtml += '</div>';
                    body.insertAdjacentHTML('beforeend', resultsHtml);
                }
            }
        }

        accordion.appendChild(header);
        accordion.appendChild(body);
        tipsContent.appendChild(accordion);
    });

    // --- Style Sequence Variant Cards ---
    function styleSequenceVariants(body) {
        var allParas = Array.from(body.querySelectorAll('p'));
        var variantRe = /^(Skinny|Balanced|Wide)\s*\(\$([\d.]+)\):\s*/i;
        var costingRe = /\((\d+)\s*combos?\s*[×x]\s*\$([\d.]+)\s*=\s*\$([\d.]+)\)/;
        var returnRe = /est\.\s*return:\s*(\d+(?:\.\d+)?)%/i;

        function buildVariantCard(text) {
            var vm = text.match(variantRe);
            if (!vm) return null;
            var variant = vm[1].toLowerCase();
            var totalCost = vm[2];
            var cm = text.match(costingRe);
            var combos = cm ? cm[1] : '';
            var unitPrice = cm ? cm[2] : '';
            var costDisplay = cm ? cm[3] : totalCost;
            var rm = text.match(returnRe);
            var returnPct = rm ? rm[1] : null;
            var afterColon = text.replace(variantRe, '');
            var legsStr = cm ? afterColon.substring(0, afterColon.indexOf('(' + cm[1])).trim() : afterColon.trim();

            var card = document.createElement('div');
            card.className = 'seq-variant-card seq-variant-' + variant;
            var headerHtml = '<div class="flex items-center justify-between flex-wrap gap-2">';
            headerHtml += '<div class="flex items-center">';
            headerHtml += '<span class="seq-variant-badge">' + variant.charAt(0).toUpperCase() + variant.slice(1) + '</span>';
            headerHtml += '<span class="seq-variant-cost">$' + costDisplay + '</span>';
            headerHtml += '</div>';
            headerHtml += '<div class="flex items-center gap-2">';
            if (combos) headerHtml += '<span class="seq-combos">' + combos + ' combos @ $' + unitPrice + '</span>';
            if (returnPct) headerHtml += '<span class="seq-return">' + returnPct + '%</span>';
            headerHtml += '</div></div>';
            var legsHtml = '<div class="seq-legs">';
            var legs = legsStr.split('/');
            legs.forEach(function(leg, idx) {
                if (idx > 0) legsHtml += '<span class="seq-leg-sep">/</span>';
                legsHtml += '<span class="seq-leg">';
                leg.trim().split(/,\s*/).forEach(function(r) {
                    r = r.trim();
                    if (r && /^\d+$/.test(r)) legsHtml += '<span class="seq-leg-pill">' + r + '</span>';
                });
                legsHtml += '</span>';
            });
            legsHtml += '</div>';
            card.innerHTML = headerHtml + legsHtml;
            return card;
        }

        allParas.forEach(function(p) {
            // Check if this <p> contains multiple variant lines (markdown <br> joins)
            var innerHtml = p.innerHTML;
            var lines = innerHtml.split(/<br\s*\/?>/i).map(function(l) {
                // Strip HTML tags to get plain text for matching
                var tmp = document.createElement('span');
                tmp.innerHTML = l;
                return tmp.textContent.trim();
            }).filter(function(l) { return l.length > 0; });

            // If multiple lines and at least one is a variant, process line by line
            var hasVariant = lines.some(function(l) { return variantRe.test(l); });
            if (!hasVariant) return;

            var fragment = document.createDocumentFragment();
            lines.forEach(function(line) {
                var card = buildVariantCard(line);
                if (card) {
                    fragment.appendChild(card);
                } else {
                    // Non-variant line (e.g. Punty's Pick) — keep as <p>
                    var newP = document.createElement('p');
                    newP.textContent = line;
                    fragment.appendChild(newP);
                }
            });
            p.parentNode.replaceChild(fragment, p);
        });

        // Style Punty's Pick line
        var remaining = body.querySelectorAll('p');
        remaining.forEach(function(p) {
            if (p.querySelector('.puntys-pick') || /Punty.s\s+Pick/i.test(p.textContent)) {
                var wrap = document.createElement('div');
                wrap.className = 'seq-puntys-pick';
                wrap.innerHTML = p.innerHTML;
                p.parentNode.replaceChild(wrap, p);
            }
        });
    }

    // --- Winner Badges ---
    function addBadge(el, label) {
        // Skip if this element already has a winner badge
        if (el.querySelector && el.querySelector('.win-tick')) return;
        if (el.getAttribute && el.getAttribute('data-badged')) return;
        var tick = document.createElement('span');
        tick.className = 'win-tick';
        tick.innerHTML = '<span class="win-emoji">&#x1F3C6;</span> ' + label;
        tick.title = label + '!';
        el.appendChild(tick);
        el.setAttribute('data-badged', '1');
    }

    // Add badge inline next to a <strong> tag inside a multi-selection paragraph
    function addBadgeAfterStrong(strongEl, label) {
        if (strongEl.getAttribute('data-badged')) return;
        var tick = document.createElement('span');
        tick.className = 'win-tick';
        tick.innerHTML = '<span class="win-emoji">&#x1F3C6;</span> ' + label;
        tick.title = label + '!';
        // Insert after the strong element's parent text run (after odds)
        var nextNode = strongEl.nextSibling;
        // Skip past the "(No.X) — $Y.YY" text node
        while (nextNode && nextNode.nodeType === 3) {
            var t = nextNode.textContent || '';
            if (/\(No\.?\s*\d+\)/.test(t)) { nextNode = nextNode.nextSibling; continue; }
            break;
        }
        if (nextNode) {
            strongEl.parentNode.insertBefore(tick, nextNode);
        } else {
            strongEl.parentNode.appendChild(tick);
        }
        strongEl.setAttribute('data-badged', '1');
    }

    var hasSelections = winners && Object.keys(winners).length;
    var hasExotics = winExotics && Object.keys(winExotics).length;
    var hasSequences = winSequences && winSequences.length;

    if (!hasSelections && !hasExotics && !hasSequences) return;

    // After accordion restructuring, headings are inside .race-accordion-header (not h2/h3).
    // Iterate per-accordion so we know which race each element belongs to.
    var accordions = tipsContent.querySelectorAll('.race-accordion');
    accordions.forEach(function(acc) {
        // Extract race number from the accordion header (R1, R2, etc.)
        var pill = acc.querySelector('.race-pill');
        if (!pill) return;
        var raceNum = parseInt((pill.textContent || '').replace(/\D/g, ''));
        if (!raceNum) return;

        var raceWinners = hasSelections ? winners[String(raceNum)] : null;
        var raceExotic = hasExotics ? winExotics[String(raceNum)] : null;

        // Selection winners: find <strong> tags with horse names, check adjacent (No.X) text
        if (raceWinners) {
            var strongs = acc.querySelectorAll('.race-accordion-body strong');
            strongs.forEach(function(s) {
                // Get the text after this strong element to find (No.X)
                var nextText = '';
                var sib = s.nextSibling;
                // Collect text until we hit <br>, another element, or end
                while (sib) {
                    if (sib.nodeType === 3) { nextText += sib.textContent; break; }
                    if (sib.nodeType === 1 && sib.tagName === 'BR') break;
                    if (sib.nodeType === 1) { nextText += sib.textContent; break; }
                    break;
                }
                var scMatch = nextText.match(/\((?:Race\s*\d+,\s*)?No\.?\s*(\d+)\)/);
                if (scMatch) {
                    var sc = parseInt(scMatch[1]);
                    if (raceWinners.indexOf(sc) !== -1) {
                        addBadgeAfterStrong(s, 'WINNER');
                    }
                }
            });
        }

        // Exotic winners: check <p> elements AND walk text nodes in accordion body
        if (raceExotic) {
            var exoticRe = /^(Trifecta|Exacta|Quinella|First\s*(?:Four|4))/i;
            var bodyEls = acc.querySelectorAll('.race-accordion-body p, .race-accordion-body .exotic-title');
            bodyEls.forEach(function(el) {
                var text = (el.textContent || '').trim();
                if (exoticRe.test(text)) addBadge(el, 'HIT');
            });
            // Also check bare text nodes (exotic lines not wrapped in <p>)
            var body = acc.querySelector('.race-accordion-body');
            if (body) {
                var childNodes = body.childNodes;
                for (var cn = 0; cn < childNodes.length; cn++) {
                    var node = childNodes[cn];
                    if (node.nodeType === 3 && exoticRe.test((node.textContent || '').trim())) {
                        // Wrap text node in a span and badge it
                        var wrapper = document.createElement('span');
                        wrapper.textContent = node.textContent;
                        node.parentNode.replaceChild(wrapper, node);
                        addBadge(wrapper, 'HIT');
                    }
                }
            }
        }
    });

    // Sequence winners (in their own sections, not inside race accordions)
    if (hasSequences) {
        var seqEls = tipsContent.querySelectorAll('.seq-variant-card, p, li, strong');
        seqEls.forEach(function(el) {
            var text = el.textContent || '';
            var variantMatch = text.match(/^(Skinny|Balanced|Wide)\s*\(/i);
            if (variantMatch) {
                var variant = variantMatch[1].toLowerCase();
                for (var si = 0; si < winSequences.length; si++) {
                    if (winSequences[si].variant === variant) { addBadge(el, 'HIT'); break; }
                }
            }
            if (/^Multi\b/i.test(text)) {
                for (var j = 0; j < winSequences.length; j++) {
                    if (winSequences[j].type === 'big3_multi') { addBadge(el, 'HIT'); break; }
                }
            }
        });
    }

    // --- Section Nav: smooth scroll + scroll spy ---
    (function() {
        var navItems = document.querySelectorAll('.section-nav-item');
        if (!navItems.length) return;

        // Smooth scroll on click
        navItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                var target = document.getElementById(item.dataset.section);
                if (target) {
                    var navH = document.getElementById('section-nav').offsetHeight || 48;
                    var y = target.getBoundingClientRect().top + window.pageYOffset - navH - 8;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                }
            });
        });

        // Scroll spy: highlight active section
        var sectionIds = [];
        navItems.forEach(function(item) { sectionIds.push(item.dataset.section); });

        function updateActive() {
            var navH = document.getElementById('section-nav').offsetHeight || 48;
            var current = null;
            for (var i = sectionIds.length - 1; i >= 0; i--) {
                var el = document.getElementById(sectionIds[i]);
                if (el && el.getBoundingClientRect().top <= navH + 20) {
                    current = sectionIds[i]; break;
                }
            }
            navItems.forEach(function(item) {
                item.classList.toggle('active', item.dataset.section === current);
            });
        }
        window.addEventListener('scroll', updateActive, { passive: true });
        updateActive();
    })();

    // Live countdown updater (every 30s)
    setInterval(function() {
        document.querySelectorAll('.race-countdown').forEach(function(el) {
            var raceMs = parseInt(el.dataset.raceTime);
            if (isNaN(raceMs)) return;
            var diff = raceMs - Date.now();
            if (diff <= 0) {
                el.textContent = 'JUMP';
                el.classList.add('race-countdown-now');
            } else {
                var mins = Math.floor(diff / 60000);
                var hrs = Math.floor(mins / 60);
                mins = mins % 60;
                el.textContent = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm';
            }
        });
    }, 30000);
});
</script>
{% endblock %}
