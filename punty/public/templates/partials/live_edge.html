{# Live Edge Zone — HTMX-pollable partial for dashboard #}
{% set race_offset = next_race.race_offset|default(0) if next_race else 0 %}
{% set total_upcoming = next_race.total_upcoming|default(0) if next_race else 0 %}

{% if next_race_picks and next_race and next_race.has_next %}
{% set selections = next_race_picks|selectattr("pick_type", "equalto", "selection")|list %}
{% if selections %}
<div class="le-card relative overflow-hidden"
     data-next-venue="{{ next_race.venue }}" data-race-offset="{{ race_offset }}">

    {# ── Glowing top border accent ── #}
    <div class="le-glow-bar"></div>

    {# ── Navigation controls + header ── #}
    <div class="le-header">
        <div class="le-nav-row">
            {# Prev button #}
            <button class="le-nav-btn {% if race_offset <= 0 %}le-nav-disabled{% endif %}"
                    {% if race_offset > 0 %}onclick="leNavigate({{ race_offset - 1 }})"{% endif %}
                    title="Previous race">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>

            {# Center: venue + race info #}
            <div class="le-title-block">
                <div class="le-live-tag">
                    <span class="le-dot"></span>
                    {% if race_offset == 0 %}NEXT UP{% else %}UPCOMING{% endif %}
                </div>
                <div class="le-venue">
                    {{ next_race.venue }} &mdash; R{{ next_race.race_number }}
                    {% if next_race.distance %}<span class="le-distance">{{ next_race.distance }}m</span>{% endif %}
                </div>
                {% if total_upcoming > 1 %}
                <div class="le-race-dots">
                    {% for i in range(total_upcoming if total_upcoming <= 8 else 8) %}
                    <span class="le-race-dot {% if i == race_offset %}le-race-dot-active{% endif %}"
                          onclick="leNavigate({{ i }})" title="Race {{ i + 1 }} of {{ total_upcoming }}"></span>
                    {% endfor %}
                    {% if total_upcoming > 8 %}<span class="le-race-dot-more">+{{ total_upcoming - 8 }}</span>{% endif %}
                </div>
                {% endif %}
            </div>

            {# Next button #}
            <button class="le-nav-btn {% if race_offset >= total_upcoming - 1 %}le-nav-disabled{% endif %}"
                    {% if race_offset < total_upcoming - 1 %}onclick="leNavigate({{ race_offset + 1 }})"{% endif %}
                    title="Next race">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
        </div>

        {# Countdown + Full Card row #}
        <div class="le-meta-row">
            <div class="le-countdown-block">
                <div class="le-countdown countdown-fixed font-display font-bold" data-start="{{ next_race.start_time_iso }}">--:--</div>
                <div class="le-until">until jump</div>
            </div>
            <a href="/tips/{{ selections[0].meeting_id }}#race-{{ next_race.race_number }}" class="le-fullcard">
                Full Card <span>&rarr;</span>
            </a>
        </div>
    </div>

    {# ── Selections table ── #}
    <div class="le-selections">
        {% for p in selections %}
        {% set odds = p.odds or 0 %}
        {% set market_pct = (100 / odds)|round(1) if odds > 0 else 0 %}
        {% set model_pct = p.show_prob or p.win_prob or 0 %}
        {% set edge = (model_pct - market_pct)|round(1) %}
        {% set is_bet = p.bet_type and 'no bet' not in p.bet_type|lower %}
        {% set is_pp = p.is_puntys_pick %}

        <div class="le-row {% if is_pp %}le-row-pp{% endif %}">
            {# Saddlecloth pill #}
            {% set rank_colors = {1: 'var(--gradient-sunset)', 2: 'linear-gradient(135deg, #00d4ff, #0ea5e9)', 3: 'linear-gradient(135deg, #facc15, #f59e0b)', 4: 'linear-gradient(135deg, #a855f7, #7c3aed)'} %}
            <span class="le-sc" style="background: {{ rank_colors.get(p.tip_rank, 'rgba(255,255,255,0.1)') }};">{{ p.saddlecloth or '?' }}</span>

            {# Horse name + bet type #}
            <div class="le-horse">
                <div class="le-horse-name">
                    <span class="font-heading font-bold text-white truncate">{{ p.name }}</span>
                    {% if is_pp %}<span class="le-pp-badge">PP</span>{% endif %}
                </div>
                <div class="le-horse-meta">
                    {% if is_bet %}
                    <span style="color: var(--cyan);">{{ p.bet_type }}</span>
                    {% else %}
                    <span style="color: var(--text-muted); opacity: 0.5;">Tracked</span>
                    {% endif %}
                    {% if p.stake and is_bet %}<span>&middot; ${{ '%.0f'|format(p.stake) }}</span>{% endif %}
                </div>
            </div>

            {# Odds #}
            <div class="le-col-odds">
                <div class="font-display font-bold text-white">${{ '%.2f'|format(odds) if odds else '?' }}</div>
            </div>

            {# Model prob — hidden on mobile #}
            <div class="le-col-model">
                <div class="font-heading font-bold" style="color: var(--text-secondary);">{{ '%.0f'|format(model_pct) }}%</div>
                <div class="le-col-sublabel">model</div>
            </div>

            {# Edge — hidden on mobile #}
            <div class="le-col-edge">
                {% if edge > 5 %}
                <div class="font-heading font-bold" style="color: #4ade80;">+{{ '%.0f'|format(edge) }}%</div>
                {% elif edge > 0 %}
                <div class="font-heading font-bold" style="color: var(--yellow);">+{{ '%.0f'|format(edge) }}%</div>
                {% else %}
                <div class="font-heading font-bold" style="color: var(--text-muted);">{{ '%.0f'|format(edge) }}%</div>
                {% endif %}
                <div class="le-col-sublabel">edge</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% else %}
{# Picks exist but no selections (only exotics) #}
<div class="le-card le-card-minimal" data-next-venue="{{ next_race.venue }}" data-race-offset="{{ race_offset }}">
    <div class="le-glow-bar"></div>
    <div class="le-nav-row" style="margin-bottom: 0.5rem;">
        <button class="le-nav-btn {% if race_offset <= 0 %}le-nav-disabled{% endif %}"
                {% if race_offset > 0 %}onclick="leNavigate({{ race_offset - 1 }})"{% endif %}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="le-title-block">
            <div class="le-live-tag"><span class="le-dot"></span> {% if race_offset == 0 %}NEXT UP{% else %}UPCOMING{% endif %}</div>
            <div class="le-venue">{{ next_race.venue }} R{{ next_race.race_number }}</div>
        </div>
        <button class="le-nav-btn {% if race_offset >= total_upcoming - 1 %}le-nav-disabled{% endif %}"
                {% if race_offset < total_upcoming - 1 %}onclick="leNavigate({{ race_offset + 1 }})"{% endif %}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>
    <div class="le-countdown countdown-fixed font-display font-bold" data-start="{{ next_race.start_time_iso }}" style="font-size: 1.5rem; text-align: center;">--:--</div>
    <div class="le-until" style="text-align: center;">until jump</div>
</div>
{% endif %}

{% elif next_race and next_race.has_next %}
{# No picks but racing coming #}
<div class="le-card le-card-minimal" data-next-venue="{{ next_race.venue }}" data-race-offset="{{ race_offset }}">
    <div class="le-glow-bar"></div>
    <div class="le-nav-row" style="margin-bottom: 0.5rem;">
        <button class="le-nav-btn {% if race_offset <= 0 %}le-nav-disabled{% endif %}"
                {% if race_offset > 0 %}onclick="leNavigate({{ race_offset - 1 }})"{% endif %}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div class="le-title-block">
            <div class="le-live-tag"><span class="le-dot"></span> {% if race_offset == 0 %}NEXT UP{% else %}UPCOMING{% endif %}</div>
            <div class="le-venue">{{ next_race.venue }} R{{ next_race.race_number }}</div>
        </div>
        <button class="le-nav-btn {% if race_offset >= total_upcoming - 1 %}le-nav-disabled{% endif %}"
                {% if race_offset < total_upcoming - 1 %}onclick="leNavigate({{ race_offset + 1 }})"{% endif %}>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>
    <div class="le-countdown countdown-fixed font-display font-bold" data-start="{{ next_race.start_time_iso }}" style="font-size: 1.5rem; text-align: center;">--:--</div>
    <div class="le-until" style="text-align: center;">until jump</div>
</div>

{% else %}
{# No racing / all done #}
<div class="le-card le-card-minimal">
    <div class="le-glow-bar" style="background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));"></div>
    <div class="le-live-tag" style="justify-content: center; margin-bottom: 0.5rem; opacity: 0.5;"><span class="le-dot" style="animation: none; opacity: 0.3;"></span> NEXT UP</div>
    <div style="text-align: center;">
        <div class="text-2xl mb-1">&#x1F3C7;</div>
        <p class="font-heading font-semibold text-white mb-1">All Done For Today</p>
        <p class="text-sm" style="color: var(--text-secondary);">Check back tomorrow for Punty's next plays.</p>
    </div>
</div>
{% endif %}

<script>
function leNavigate(offset) {
    var el = document.getElementById('live-edge');
    if (!el) return;
    var url = '/tips/_live-edge?offset=' + offset;
    // Preserve venue filter exclusions
    if (window.Alpine) {
        var data = Alpine.$data(el.closest('[x-data]'));
        if (data && data.hiddenVenues && data.hiddenVenues.length) {
            url += '&exclude=' + encodeURIComponent(data.hiddenVenues.join(','));
        }
    }
    htmx.ajax('GET', url, {target: '#live-edge', swap: 'innerHTML'});
    // Store offset so auto-refresh preserves position
    el.dataset.raceOffset = offset;
}
</script>

<style>
@keyframes live-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
@keyframes le-shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* ── Hero card ── */
.le-card {
    padding: 1.25rem;
    border-radius: 12px;
    background: linear-gradient(145deg, rgba(233, 30, 140, 0.08) 0%, rgba(255, 107, 53, 0.04) 40%, rgba(0, 212, 255, 0.03) 100%);
    border: 1px solid rgba(233, 30, 140, 0.25);
    box-shadow:
        0 0 20px rgba(233, 30, 140, 0.08),
        0 0 60px rgba(233, 30, 140, 0.03),
        inset 0 1px 0 rgba(255, 255, 255, 0.04);
    position: relative;
}
.le-card-minimal {
    padding: 1rem;
}

/* ── Animated top glow bar ── */
.le-glow-bar {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg,
        transparent 0%,
        var(--magenta) 20%,
        var(--orange) 40%,
        var(--cyan) 60%,
        var(--magenta) 80%,
        transparent 100%);
    background-size: 200% 100%;
    animation: le-shimmer 4s linear infinite;
    border-radius: 12px 12px 0 0;
}

/* ── Navigation row ── */
.le-nav-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}
.le-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px; height: 32px;
    border-radius: 8px;
    border: 1px solid rgba(233, 30, 140, 0.3);
    background: rgba(233, 30, 140, 0.08);
    color: var(--magenta);
    cursor: pointer;
    transition: all 0.15s;
    flex-shrink: 0;
}
.le-nav-btn:hover:not(.le-nav-disabled) {
    background: rgba(233, 30, 140, 0.2);
    border-color: rgba(233, 30, 140, 0.5);
    box-shadow: 0 0 12px rgba(233, 30, 140, 0.15);
}
.le-nav-disabled {
    opacity: 0.2;
    cursor: default;
    pointer-events: none;
}

/* ── Title block ── */
.le-title-block {
    flex: 1;
    min-width: 0;
    text-align: center;
}
.le-live-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    color: var(--magenta);
    text-transform: uppercase;
    margin-bottom: 0.15rem;
}
.le-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--magenta);
    box-shadow: 0 0 6px rgba(233, 30, 140, 0.6);
    animation: live-dot 1.5s ease-in-out infinite;
    flex-shrink: 0;
}
.le-venue {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 1.1rem;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.le-distance {
    color: var(--text-muted);
    font-weight: 500;
    font-size: 0.85rem;
    margin-left: 0.25rem;
}

/* ── Race position dots ── */
.le-race-dots {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-top: 0.35rem;
}
.le-race-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    cursor: pointer;
    transition: all 0.15s;
}
.le-race-dot:hover {
    background: rgba(233, 30, 140, 0.4);
}
.le-race-dot-active {
    background: var(--magenta);
    box-shadow: 0 0 6px rgba(233, 30, 140, 0.5);
    width: 8px; height: 8px;
}
.le-race-dot-more {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.55rem;
    font-weight: 700;
    color: var(--text-muted);
}

/* ── Meta row: countdown + full card ── */
.le-meta-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.75rem;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.04);
}
.le-countdown-block { display: flex; align-items: baseline; gap: 0.5rem; }
.le-countdown {
    font-size: 1.4rem;
    color: var(--magenta);
    text-shadow: 0 0 12px rgba(233, 30, 140, 0.3);
}
.le-until {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.le-fullcard {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--cyan);
    text-decoration: none;
    transition: all 0.15s;
    white-space: nowrap;
}
.le-fullcard:hover { color: white; text-shadow: 0 0 8px rgba(0, 212, 255, 0.4); }
.le-fullcard span { display: inline-block; transition: transform 0.15s; }
.le-fullcard:hover span { transform: translateX(3px); }

/* ── Selection rows ── */
.le-selections { display: flex; flex-direction: column; gap: 0.375rem; }
.le-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.625rem;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.025);
    transition: background 0.15s;
}
.le-row:hover { background: rgba(255, 255, 255, 0.05); }
.le-row-pp {
    border: 1px solid rgba(233, 30, 140, 0.3);
    background: rgba(233, 30, 140, 0.04);
}
.le-sc {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px; height: 28px;
    border-radius: 6px;
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    font-size: 0.7rem;
    color: white;
    flex-shrink: 0;
}
.le-horse { flex: 1; min-width: 0; }
.le-horse-name {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
}
.le-horse-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
}
.le-pp-badge {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.55rem;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 3px;
    background: rgba(233, 30, 140, 0.15);
    color: var(--magenta);
}
.le-col-odds {
    text-align: right;
    flex-shrink: 0;
    min-width: 3.5rem;
    font-size: 0.85rem;
}
.le-col-model, .le-col-edge {
    text-align: right;
    flex-shrink: 0;
    min-width: 3rem;
    font-size: 0.7rem;
}
.le-col-sublabel {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.55rem;
    font-weight: 600;
    color: var(--text-muted);
}

/* ── Mobile ── */
@media (max-width: 639px) {
    .le-card { padding: 0.75rem; }
    .le-nav-row { gap: 0.375rem; margin-bottom: 0.5rem; }
    .le-nav-btn { width: 28px; height: 28px; }
    .le-venue { font-size: 0.9rem; }
    .le-live-tag { font-size: 0.6rem; }
    .le-meta-row { padding: 0.375rem 0.5rem; margin-bottom: 0.5rem; }
    .le-countdown { font-size: 1rem; }
    .le-until { font-size: 0.55rem; }
    .le-fullcard { font-size: 0.6rem; }
    .le-col-model, .le-col-edge { display: none !important; }
    .le-col-odds { min-width: 0; font-size: 0.8rem; }
    .le-row { gap: 0.5rem; padding: 0.35rem 0.4rem; }
    .le-sc { width: 24px; height: 24px; font-size: 0.6rem; }
    .le-horse-name { font-size: 0.8rem; }
    .le-race-dots { gap: 4px; }
}
</style>
