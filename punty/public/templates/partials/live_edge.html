{# Live Edge Zone — HTMX-pollable partial for dashboard #}
{% if next_race_picks and next_race and next_race.has_next %}
{% set selections = next_race_picks|selectattr("pick_type", "equalto", "selection")|list %}
{% if selections %}
<div class="card le-card relative overflow-hidden"
     style="border-color: rgba(233, 30, 140, 0.3); background: linear-gradient(135deg, rgba(233, 30, 140, 0.05), rgba(255, 107, 53, 0.03));"
     data-next-venue="{{ next_race.venue }}">
    {# Header: badge + venue + countdown #}
    <div class="le-header flex items-center gap-3 mb-4">
        <span class="le-badge inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-heading font-bold uppercase tracking-wider flex-shrink-0"
              style="background: linear-gradient(135deg, rgba(233, 30, 140, 0.2), rgba(255, 107, 53, 0.15)); color: var(--magenta); border: 1px solid rgba(233, 30, 140, 0.35);">
            <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--magenta); display: inline-block; animation: live-dot 1.5s ease-in-out infinite;"></span>
            Next Up
        </span>
        <div class="flex-1 min-w-0">
            <div class="font-heading font-bold text-white text-sm truncate">
                {{ next_race.venue }} R{{ next_race.race_number }}
                {% if next_race.distance %} &middot; {{ next_race.distance }}m{% endif %}
            </div>
        </div>
        <div class="text-right flex-shrink-0">
            <div class="le-countdown countdown-fixed font-display font-bold" style="color: var(--magenta);" data-start="{{ next_race.start_time_iso }}">--:--</div>
            <div class="le-until text-xs" style="color: var(--text-muted);">until jump</div>
        </div>
    </div>

    {# Full Card link #}
    <div class="flex items-center justify-end mb-3" style="margin-top: -0.5rem;">
        <a href="/tips/{{ selections[0].meeting_id }}#race-{{ next_race.race_number }}" class="text-xs font-heading font-semibold uppercase tracking-wider transition-colors" style="color: var(--cyan);">
            Full Card &rarr;
        </a>
    </div>

    {# Selections table #}
    <div class="space-y-2">
        {% for p in selections %}
        {% set odds = p.odds or 0 %}
        {% set market_pct = (100 / odds)|round(1) if odds > 0 else 0 %}
        {% set model_pct = p.show_prob or p.win_prob or 0 %}
        {% set edge = (model_pct - market_pct)|round(1) %}
        {% set is_bet = p.bet_type and 'no bet' not in p.bet_type|lower %}
        {% set is_pp = p.is_puntys_pick %}

        <div class="le-row flex items-center gap-3 p-2.5 rounded-lg {% if is_pp %}ring-1{% endif %}"
             style="background: rgba(255,255,255,0.03); {% if is_pp %}--tw-ring-color: var(--magenta); --tw-ring-opacity: 0.4;{% endif %}">

            {# Saddlecloth pill #}
            {% set rank_colors = {1: 'var(--gradient-sunset)', 2: 'linear-gradient(135deg, #00d4ff, #0ea5e9)', 3: 'linear-gradient(135deg, #facc15, #f59e0b)', 4: 'linear-gradient(135deg, #a855f7, #7c3aed)'} %}
            <span class="inline-flex items-center justify-center w-7 h-7 rounded-md font-display font-bold text-xs text-white flex-shrink-0"
                  style="background: {{ rank_colors.get(p.tip_rank, 'rgba(255,255,255,0.1)') }};">{{ p.saddlecloth or '?' }}</span>

            {# Horse name + bet type #}
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-1.5">
                    <span class="font-heading font-bold text-white text-sm truncate">{{ p.name }}</span>
                    {% if is_pp %}
                    <span class="text-xs px-1.5 py-0.5 rounded font-heading font-bold" style="background: rgba(233,30,140,0.15); color: var(--magenta); font-size: 0.6rem;">PP</span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-1.5 text-xs" style="color: var(--text-muted);">
                    {% if is_bet %}
                    <span class="font-heading font-semibold" style="color: var(--cyan);">{{ p.bet_type }}</span>
                    {% else %}
                    <span class="font-heading font-semibold" style="color: var(--text-muted); opacity: 0.5;">Tracked</span>
                    {% endif %}
                    {% if p.stake and is_bet %}<span>&middot; ${{ '%.0f'|format(p.stake) }}</span>{% endif %}
                </div>
            </div>

            {# Odds #}
            <div class="le-col-odds text-right flex-shrink-0">
                <div class="font-display font-bold text-sm text-white">${{ '%.2f'|format(odds) if odds else '?' }}</div>
            </div>

            {# Model prob — hidden on mobile via le-col-model #}
            <div class="le-col-model text-right flex-shrink-0">
                <div class="font-heading font-bold text-xs" style="color: var(--text-secondary);">{{ '%.0f'|format(model_pct) }}%</div>
                <div class="text-xs" style="color: var(--text-muted); font-size: 0.6rem;">model</div>
            </div>

            {# Edge — hidden on mobile via le-col-edge #}
            <div class="le-col-edge text-right flex-shrink-0">
                {% if edge > 5 %}
                <div class="font-heading font-bold text-xs" style="color: #4ade80;">+{{ '%.0f'|format(edge) }}%</div>
                {% elif edge > 0 %}
                <div class="font-heading font-bold text-xs" style="color: var(--yellow);">+{{ '%.0f'|format(edge) }}%</div>
                {% else %}
                <div class="font-heading font-bold text-xs" style="color: var(--text-muted);">{{ '%.0f'|format(edge) }}%</div>
                {% endif %}
                <div class="text-xs" style="color: var(--text-muted); font-size: 0.6rem;">edge</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% else %}
{# Picks exist but no selections (only exotics) #}
<div class="card p-4 text-center" style="border-color: var(--border-subtle);" data-next-venue="{{ next_race.venue }}">
    <div class="text-xs font-heading font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Next Up</div>
    <p class="font-heading font-semibold text-white mb-1">{{ next_race.venue }} R{{ next_race.race_number }}</p>
    <p class="text-sm" style="color: var(--text-secondary);">
        <span class="countdown-fixed font-heading font-bold" style="color: var(--magenta);" data-start="{{ next_race.start_time_iso }}">--:--</span>
        until jump
    </p>
</div>
{% endif %}

{% elif next_race and next_race.has_next %}
{# No picks but racing coming #}
<div class="card p-4 text-center" style="border-color: var(--border-subtle);" data-next-venue="{{ next_race.venue }}">
    <div class="text-xs font-heading font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Next Up</div>
    <p class="font-heading font-semibold text-white mb-1">{{ next_race.venue }} R{{ next_race.race_number }}</p>
    <p class="text-sm" style="color: var(--text-secondary);">
        Jumping in
        <span class="countdown-fixed font-heading font-bold" style="color: var(--magenta);" data-start="{{ next_race.start_time_iso }}">--:--</span>
    </p>
</div>

{% else %}
{# No racing / all done #}
<div class="card p-4 text-center" style="border-color: var(--border-subtle);">
    <div class="text-xs font-heading font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Next Up</div>
    <div class="text-2xl mb-1">&#x1F3C7;</div>
    <p class="font-heading font-semibold text-white mb-1">All Done For Today</p>
    <p class="text-sm" style="color: var(--text-secondary);">Check back tomorrow for Punty's next plays.</p>
</div>
{% endif %}

<style>
@keyframes live-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
/* Live edge layout */
.le-card { padding: 1rem; }
.le-countdown { font-size: 1.125rem; }
.le-col-odds { min-width: 3.5rem; }
.le-col-model { min-width: 3rem; }
.le-col-edge { min-width: 3.5rem; }
@media (max-width: 639px) {
    .le-card { padding: 0.625rem; }
    .le-header { gap: 0.375rem; }
    .le-badge { font-size: 0.6rem; padding: 0.2rem 0.5rem; }
    .le-countdown { font-size: 0.85rem; }
    .le-until { font-size: 0.55rem; }
    .le-col-model, .le-col-edge { display: none !important; }
    .le-col-odds { min-width: 0; }
    .le-row { gap: 0.5rem; padding: 0.3rem 0.4rem; }
}
</style>
