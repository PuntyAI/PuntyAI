{% extends "base.html" %}

{% block title %}Today's Scorecard - PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="Today's racing scoreboard. Every bet tracked, every winner celebrated. Live P&L, upcoming bets, and edge picks.">
<style>
    /* ── Cards & Components ── */
    .win-card {
        background: var(--bg-card-alt);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 1.25rem;
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .win-card:hover { transform: translateY(-2px); }
    .win-card-hero {
        border-color: rgba(233, 30, 140, 0.4);
        box-shadow: 0 0 30px rgba(233, 30, 140, 0.15), inset 0 0 30px rgba(233, 30, 140, 0.03);
    }
    .rank-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 22px; height: 22px; border-radius: 6px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.7rem;
    }
    .rank-1 { background: rgba(233, 30, 140, 0.2); color: var(--magenta); }
    .rank-2 { background: rgba(0, 212, 255, 0.2); color: var(--cyan); }
    .rank-3 { background: rgba(255, 193, 7, 0.2); color: var(--yellow); }
    .rank-4 { background: rgba(157, 78, 221, 0.2); color: var(--purple); }
    .type-badge {
        display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem;
        font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .type-selection { background: rgba(233, 30, 140, 0.12); color: var(--magenta); }
    .type-exotic { background: rgba(0, 212, 255, 0.12); color: var(--cyan); }
    .type-sequence { background: rgba(255, 193, 7, 0.12); color: var(--yellow); }
    .type-big3_multi { background: rgba(157, 78, 221, 0.12); color: var(--purple); }
    .insight-chip {
        display: inline-flex; align-items: center; gap: 0.5rem;
        padding: 0.6rem 1rem; border-radius: 12px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
        white-space: nowrap; flex-shrink: 0;
    }
    .insight-scroll {
        display: flex; gap: 0.75rem; animation: insight-marquee 20s linear infinite;
        width: max-content;
    }
    .insight-scroll:hover { animation-play-state: paused; }
    @keyframes insight-marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    .insight-icon {
        width: 28px; height: 28px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
    }
    .product-bar {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.75rem 1rem; border-radius: 12px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
    }
    .venue-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .venue-row:last-child { border-bottom: none; }

    /* ── Chart ── */
    .chart-container {
        position: relative; height: 180px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
        border-radius: 16px; padding: 1rem; overflow: hidden;
    }
    .chart-canvas { width: 100%; height: 100%; }

    /* ── Upcoming/Edge tables ── */
    .upcoming-row {
        display: grid; grid-template-columns: 1fr auto auto auto;
        gap: 0.5rem; align-items: center;
        padding: 0.6rem 0.75rem; border-radius: 10px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
        transition: border-color 0.15s;
    }
    .upcoming-row:hover { border-color: rgba(255,255,255,0.1); }
    .edge-glow {
        border-color: rgba(74, 222, 128, 0.25);
        box-shadow: 0 0 12px rgba(74, 222, 128, 0.06);
    }

    /* ── Bet type bars ── */
    .bt-row {
        display: grid; grid-template-columns: 100px 1fr 60px 60px 70px;
        gap: 0.5rem; align-items: center; padding: 0.6rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .bt-row:last-child { border-bottom: none; }

    /* ── Section nav tabs ── */
    .dash-tabs {
        display: flex; gap: 0.25rem; overflow-x: auto;
        scrollbar-width: none; padding-bottom: 0.5rem;
    }
    .dash-tab {
        padding: 0.4rem 0.75rem; border-radius: 8px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.75rem;
        font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
        color: var(--text-muted); background: transparent;
        border: 1px solid transparent; cursor: pointer;
        white-space: nowrap; transition: all 0.15s;
    }
    .dash-tab:hover { color: var(--text-secondary); border-color: var(--border-subtle); }
    .dash-tab.active {
        color: var(--magenta); border-color: rgba(233, 30, 140, 0.3);
        background: rgba(233, 30, 140, 0.06);
    }

    /* ── Animations ── */
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: slideUp 0.4s ease forwards; }
    .stagger-1 { animation-delay: 0.05s; }
    .stagger-2 { animation-delay: 0.1s; }
    .stagger-3 { animation-delay: 0.15s; }
    .stagger-4 { animation-delay: 0.2s; }
    .stagger-5 { animation-delay: 0.25s; }

    /* ── Tooltip ── */
    .vr-pill {
        display: inline-block; padding: 0.1rem 0.4rem; border-radius: 6px;
        font-size: 0.65rem; font-weight: 700; font-family: 'Rajdhani', sans-serif;
    }
    .vr-good { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
    .vr-great { background: rgba(74, 222, 128, 0.25); color: #22c55e; }
    .vr-meh { background: rgba(255, 255, 255, 0.08); color: var(--text-muted); }
</style>
{% endblock %}

{% block content %}
<section class="py-8 sm:py-10" x-data="dashboard()">
    <div class="max-w-5xl mx-auto px-4 sm:px-8">

        <!-- Header -->
        <div class="text-center mb-6">
            <p class="text-xs font-heading font-semibold uppercase tracking-widest mb-2" style="color: var(--text-muted);">{{ date }}</p>
            <h1 class="text-4xl md:text-5xl font-heading font-bold mb-2">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Today's Scorecard</span>
            </h1>
            {% if has_data %}
            <p class="text-sm" style="color: var(--text-secondary);">
                {{ total_settled }} settled &middot; {{ total_upcoming }} upcoming &middot; {{ total_picks }} total bets
            </p>
            {% endif %}
        </div>

        {% if has_data %}
        {% set perf = performance %}
        {% set roi = (perf.total_pnl / perf.total_staked * 100) if perf.total_staked else 0 %}

        <!-- ═══ A. Hero Stats Strip ═══ -->
        <div class="grid grid-cols-3 sm:grid-cols-5 gap-3 mb-6">
            <div class="text-center rounded-xl py-3 px-2" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">Bets</div>
                <div class="text-2xl sm:text-3xl font-display font-bold" style="color: var(--text-primary);">{{ perf.total_bets }}</div>
            </div>
            <div class="text-center rounded-xl py-3 px-2" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">Winners</div>
                <div class="text-2xl sm:text-3xl font-display font-bold" style="color: var(--cyan);">{{ perf.total_winners }}</div>
            </div>
            <div class="text-center rounded-xl py-3 px-2" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">Staked</div>
                <div class="text-2xl sm:text-3xl font-display font-bold" style="color: var(--text-primary);">${{ '%.0f'|format(perf.total_staked) }}</div>
            </div>
            <div class="text-center rounded-xl py-3 px-2" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">Returned</div>
                <div class="text-2xl sm:text-3xl font-display font-bold" style="color: var(--text-primary);">${{ '%.0f'|format(perf.total_returned) }}</div>
            </div>
            <div class="text-center rounded-xl py-3 px-2 col-span-3 sm:col-span-1" style="background: var(--bg-card-alt); border: 1px solid {% if roi >= 0 %}rgba(74, 222, 128, 0.3){% else %}rgba(248, 113, 113, 0.3){% endif %};">
                <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">P&amp;L</div>
                <div class="text-2xl sm:text-3xl font-display font-bold" style="color: {% if roi >= 0 %}#4ade80{% else %}#f87171{% endif %};">
                    {{ '%+.0f'|format(perf.total_pnl) }}<span class="text-sm" style="color: var(--text-muted);">U</span>
                </div>
                <div class="text-[10px] font-heading" style="color: {% if roi >= 0 %}#4ade80{% else %}#f87171{% endif %};">{{ '%+.1f'|format(roi) }}% ROI</div>
            </div>
        </div>

        <!-- ═══ Section Nav Tabs ═══ -->
        <div class="dash-tabs mb-6">
            <button class="dash-tab" :class="{ active: tab === 'results' }" @click="tab = 'results'">Results</button>
            <button class="dash-tab" :class="{ active: tab === 'upcoming' }" @click="tab = 'upcoming'">
                Upcoming <span class="ml-1 text-[10px] opacity-60">{{ total_upcoming }}</span>
            </button>
            {% if edge_picks %}
            <button class="dash-tab" :class="{ active: tab === 'edge' }" @click="tab = 'edge'">
                Edge Picks <span class="ml-1 text-[10px] opacity-60">{{ edge_picks|length }}</span>
            </button>
            {% endif %}
            <button class="dash-tab" :class="{ active: tab === 'breakdown' }" @click="tab = 'breakdown'">Breakdown</button>
            <button class="dash-tab" :class="{ active: tab === 'venues' }" @click="tab = 'venues'">Venues</button>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB: Results -->
        <!-- ═══════════════════════════════════════════ -->
        <div x-show="tab === 'results'" x-transition.opacity>

            {% if has_settled and timeline|length > 2 %}
            <!-- P&L Chart -->
            <div class="mb-6">
                <h2 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted);">Running P&amp;L</h2>
                <div class="chart-container">
                    <canvas id="pnlChart" class="chart-canvas"></canvas>
                </div>
            </div>
            {% endif %}

            {% if big_wins %}
            <!-- Big Wins -->
            <div class="mb-6">
                <h2 class="font-heading font-bold text-lg uppercase tracking-wider mb-4" style="color: var(--magenta);">
                    Today's Best
                </h2>
                <div class="space-y-3">
                    {% for win in big_wins %}
                    <a href="/tips/{{ win.meeting_id }}" class="block win-card {{ 'win-card-hero' if loop.first }} animate-in stagger-{{ loop.index }}" style="opacity:0; text-decoration:none; color:inherit;">
                        <div class="flex flex-wrap items-start justify-between gap-2">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    {% if win.tip_rank %}
                                    <span class="rank-badge rank-{{ win.tip_rank }}">#{{ win.tip_rank }}</span>
                                    {% endif %}
                                    <span class="type-badge type-{{ win.pick_type }}">{{ win.pick_type }}</span>
                                    {% if win.is_puntys_pick %}
                                    <span class="type-badge" style="background: linear-gradient(135deg, rgba(233,30,140,0.15), rgba(255,107,53,0.15)); color: var(--orange);">PP</span>
                                    {% endif %}
                                </div>
                                <h3 class="text-lg sm:text-xl font-heading font-bold truncate" style="color: var(--text-primary);">
                                    {{ win.display_name }}
                                </h3>
                                <div class="flex flex-wrap items-center gap-x-3 gap-y-0.5 text-xs" style="color: var(--text-muted);">
                                    <span>{{ win.venue }} R{{ win.race_number }}</span>
                                    {% if win.jockey %}<span>{{ win.jockey }}</span>{% endif %}
                                    {% if win.trainer %}<span>{{ win.trainer }}</span>{% endif %}
                                </div>
                                {% if win.running_style or win.margin_text %}
                                <div class="flex flex-wrap gap-2 mt-1.5 text-xs" style="color: var(--text-secondary);">
                                    {% if win.running_style %}<span style="color: var(--cyan);">{{ win.running_style }}</span>{% endif %}
                                    {% if win.margin_text %}<span>{{ win.margin_text }}</span>{% endif %}
                                </div>
                                {% endif %}
                                <p class="text-sm mt-2 italic" style="color: var(--orange);">{{ win.celebration }}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                {% if win.odds %}
                                <div class="text-xs" style="color: var(--text-muted);">{{ win.bet_type }}</div>
                                <div class="text-lg font-display font-bold" style="color: var(--text-primary);">${{ '%.2f'|format(win.odds) }}</div>
                                {% endif %}
                                <div class="mt-1 px-3 py-1 rounded-lg inline-block" style="background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.2);">
                                    <span class="text-xs" style="color: var(--text-muted);">${{ '%.0f'|format(win.stake) }}</span>
                                    <span class="text-xs" style="color: var(--text-muted);">&rarr;</span>
                                    <span class="text-sm font-heading font-bold" style="color: #4ade80;">${{ '%.2f'|format(win.returned) }}</span>
                                </div>
                                <div class="text-lg font-display font-bold mt-0.5" style="color: #4ade80;">+${{ '%.2f'|format(win.pnl) }}</div>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if insights %}
            <!-- Insights (auto-scrolling marquee, pause on hover) -->
            <div class="mb-6">
                <h2 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted);">Insights</h2>
                <div style="overflow: hidden;">
                    <div class="insight-scroll">
                        {% for ins in insights %}
                        <div class="insight-chip">
                            <div class="insight-icon" style="background: {% if ins.icon == 'fire' %}rgba(255, 107, 53, 0.15){% elif ins.icon == 'trophy' %}rgba(255, 193, 7, 0.15){% elif ins.icon == 'zap' %}rgba(233, 30, 140, 0.15){% elif ins.icon == 'horse' %}rgba(0, 212, 255, 0.15){% elif ins.icon == 'pin' %}rgba(157, 78, 221, 0.15){% else %}rgba(0, 212, 255, 0.15){% endif %};">
                                {% if ins.icon == 'fire' %}&#x1F525;{% elif ins.icon == 'trophy' %}&#x1F3C6;{% elif ins.icon == 'zap' %}&#x26A1;{% elif ins.icon == 'horse' %}&#x1F3C7;{% elif ins.icon == 'pin' %}&#x1F4CD;{% elif ins.icon == 'chart' %}&#x1F4C8;{% endif %}
                            </div>
                            <div>
                                <div class="text-[10px] font-heading font-bold uppercase tracking-wider" style="color: var(--text-muted);">{{ ins.label }}</div>
                                <div class="text-sm font-heading font-semibold" style="color: var(--text-primary);">{{ ins.text }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        <!-- Duplicate for seamless loop -->
                        {% for ins in insights %}
                        <div class="insight-chip">
                            <div class="insight-icon" style="background: {% if ins.icon == 'fire' %}rgba(255, 107, 53, 0.15){% elif ins.icon == 'trophy' %}rgba(255, 193, 7, 0.15){% elif ins.icon == 'zap' %}rgba(233, 30, 140, 0.15){% elif ins.icon == 'horse' %}rgba(0, 212, 255, 0.15){% elif ins.icon == 'pin' %}rgba(157, 78, 221, 0.15){% else %}rgba(0, 212, 255, 0.15){% endif %};">
                                {% if ins.icon == 'fire' %}&#x1F525;{% elif ins.icon == 'trophy' %}&#x1F3C6;{% elif ins.icon == 'zap' %}&#x26A1;{% elif ins.icon == 'horse' %}&#x1F3C7;{% elif ins.icon == 'pin' %}&#x1F4CD;{% elif ins.icon == 'chart' %}&#x1F4C8;{% endif %}
                            </div>
                            <div>
                                <div class="text-[10px] font-heading font-bold uppercase tracking-wider" style="color: var(--text-muted);">{{ ins.label }}</div>
                                <div class="text-sm font-heading font-semibold" style="color: var(--text-primary);">{{ ins.text }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if not has_settled %}
            <div class="text-center py-10 rounded-xl" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-3xl mb-2">&#x23F3;</div>
                <p class="font-heading font-semibold" style="color: var(--text-secondary);">No results yet. Races still running.</p>
            </div>
            {% endif %}
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB: Upcoming -->
        <!-- ═══════════════════════════════════════════ -->
        <div x-show="tab === 'upcoming'" x-transition.opacity>
            {% if upcoming %}
            <div class="space-y-2">
                {% for u in upcoming %}
                <a href="/tips/{{ u.meeting_id }}" class="upcoming-row {{ 'edge-glow' if u.is_edge }}" style="text-decoration:none; color:inherit;">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            {% if u.tip_rank %}
                            <span class="rank-badge rank-{{ u.tip_rank }}">#{{ u.tip_rank }}</span>
                            {% endif %}
                            <span class="type-badge type-{{ u.pick_type }}">{{ u.pick_type }}</span>
                            {% if u.is_puntys_pick %}
                            <span class="type-badge" style="background: linear-gradient(135deg, rgba(233,30,140,0.15), rgba(255,107,53,0.15)); color: var(--orange);">PP</span>
                            {% endif %}
                            {% if u.value_rating and u.value_rating >= 1.1 %}
                            <span class="vr-pill {{ 'vr-great' if u.value_rating >= 1.3 else 'vr-good' }}">VR {{ u.value_rating }}</span>
                            {% endif %}
                        </div>
                        <div class="font-heading font-semibold text-sm truncate" style="color: var(--text-primary);">{{ u.name }}</div>
                        <div class="text-xs" style="color: var(--text-muted);">{{ u.venue }} R{{ u.race_number }}</div>
                    </div>
                    <div class="text-right">
                        {% if u.odds %}
                        <div class="font-display font-bold text-sm" style="color: var(--text-primary);">${{ '%.2f'|format(u.odds) }}</div>
                        {% endif %}
                        <div class="text-[10px]" style="color: var(--text-muted);">{{ u.bet_type }}</div>
                    </div>
                    <div class="text-right">
                        {% if u.stake %}
                        <div class="text-xs font-heading" style="color: var(--text-secondary);">${{ '%.0f'|format(u.stake) }}</div>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        {% if u.start_time %}
                        <div class="text-xs font-heading font-semibold" style="color: var(--cyan);">{{ u.start_time }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10 rounded-xl" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-3xl mb-2">&#x2705;</div>
                <p class="font-heading font-semibold" style="color: var(--text-secondary);">All bets settled for today.</p>
            </div>
            {% endif %}
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB: Edge Picks -->
        <!-- ═══════════════════════════════════════════ -->
        {% if edge_picks %}
        <div x-show="tab === 'edge'" x-transition.opacity>
            <p class="text-xs mb-3" style="color: var(--text-muted);">Upcoming selections where our model sees overlay value (VR &ge; 1.1).</p>
            <div class="space-y-2">
                {% for e in edge_picks %}
                <a href="/tips/{{ e.meeting_id }}" class="upcoming-row edge-glow" style="text-decoration:none; color:inherit;">
                    <div class="min-w-0">
                        <div class="flex items-center gap-2 mb-0.5">
                            {% if e.tip_rank %}
                            <span class="rank-badge rank-{{ e.tip_rank }}">#{{ e.tip_rank }}</span>
                            {% endif %}
                            {% if e.is_puntys_pick %}
                            <span class="type-badge" style="background: linear-gradient(135deg, rgba(233,30,140,0.15), rgba(255,107,53,0.15)); color: var(--orange);">PP</span>
                            {% endif %}
                            <span class="vr-pill {{ 'vr-great' if e.value_rating >= 1.3 else 'vr-good' }}">VR {{ e.value_rating }}</span>
                            {% if e.confidence %}
                            <span class="text-[10px] font-heading font-bold uppercase" style="color: {% if e.confidence == 'HIGH' %}#4ade80{% elif e.confidence == 'MED' %}var(--yellow){% else %}var(--text-muted){% endif %};">{{ e.confidence }}</span>
                            {% endif %}
                        </div>
                        <div class="font-heading font-bold text-base truncate" style="color: var(--text-primary);">{{ e.name }}</div>
                        <div class="text-xs" style="color: var(--text-muted);">
                            {{ e.venue }} R{{ e.race_number }}
                            {% if e.win_prob %}&middot; {{ e.win_prob }}% win prob{% endif %}
                        </div>
                    </div>
                    <div class="text-right">
                        {% if e.odds %}
                        <div class="font-display font-bold text-base" style="color: var(--text-primary);">${{ '%.2f'|format(e.odds) }}</div>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-xs" style="color: var(--text-muted);">{{ e.bet_type }}</div>
                        <div class="text-xs font-heading" style="color: var(--text-secondary);">${{ '%.0f'|format(e.stake) }}</div>
                    </div>
                    <div class="text-right">
                        {% if e.start_time %}
                        <div class="text-sm font-heading font-bold" style="color: var(--cyan);">{{ e.start_time }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB: Breakdown -->
        <!-- ═══════════════════════════════════════════ -->
        <div x-show="tab === 'breakdown'" x-transition.opacity>

            <!-- Product Breakdown -->
            <div class="mb-6">
                <h2 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted);">By Product</h2>
                <div class="space-y-2">
                    {% set product_labels = {'selection': 'Selections', 'big3_multi': 'Big 3 Multi', 'exotic': 'Exotics', 'sequence': 'Sequences'} %}
                    {% set product_colors = {'selection': 'var(--magenta)', 'exotic': 'var(--cyan)', 'sequence': 'var(--yellow)', 'big3_multi': 'var(--purple)'} %}
                    {% for ptype, data in perf.by_product.items() %}
                    {% if ptype != 'big3' and data.bets > 0 %}
                    {% set prod_roi = (data.pnl / data.staked * 100) if data.staked else 0 %}
                    <div class="product-bar">
                        <div class="w-24 sm:w-28 font-heading font-semibold text-sm" style="color: {{ product_colors.get(ptype, 'var(--text-secondary)') }};">{{ product_labels.get(ptype, ptype|title) }}</div>
                        <div class="flex-1 mx-1">
                            <div class="w-full rounded-full h-2" style="background: rgba(255,255,255,0.06);">
                                <div class="h-2 rounded-full" style="width: {{ [data.strike_rate, 100]|min }}%; background: {{ product_colors.get(ptype, 'var(--text-secondary)') }};"></div>
                            </div>
                        </div>
                        <div class="w-16 text-right text-sm" style="color: var(--text-muted);">{{ data.winners }}/{{ data.bets }}</div>
                        <div class="w-20 text-right text-sm font-heading font-semibold" style="color: {% if prod_roi >= 0 %}#4ade80{% else %}#f87171{% endif %};">{{ '%+.1f'|format(prod_roi) }}%</div>
                    </div>
                    {% endif %}
                    {% endfor %}

                </div>
            </div>

            {% if bet_types %}
            <!-- Bet Type Breakdown -->
            <div class="mb-6">
                <h2 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--text-muted);">By Bet Type</h2>
                <div class="rounded-xl p-4" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                    <div class="bt-row" style="border-bottom: 1px solid rgba(255,255,255,0.08);">
                        <div class="text-[10px] font-heading font-bold uppercase" style="color: var(--text-muted);">Type</div>
                        <div></div>
                        <div class="text-[10px] font-heading font-bold uppercase text-right" style="color: var(--text-muted);">SR%</div>
                        <div class="text-[10px] font-heading font-bold uppercase text-right" style="color: var(--text-muted);">ROI</div>
                        <div class="text-[10px] font-heading font-bold uppercase text-right" style="color: var(--text-muted);">P&amp;L</div>
                    </div>
                    {% for bt in bet_types %}
                    <div class="bt-row">
                        <div class="font-heading font-semibold text-sm" style="color: var(--text-primary);">{{ bt.name }}</div>
                        <div>
                            <div class="w-full rounded-full h-1.5" style="background: rgba(255,255,255,0.06);">
                                <div class="h-1.5 rounded-full" style="width: {{ [bt.strike_rate, 100]|min }}%; background: var(--magenta);"></div>
                            </div>
                        </div>
                        <div class="text-sm text-right" style="color: var(--text-secondary);">{{ bt.strike_rate }}%</div>
                        <div class="text-sm text-right font-heading font-semibold" style="color: {% if bt.roi >= 0 %}#4ade80{% else %}#f87171{% endif %};">{{ '%+.0f'|format(bt.roi) }}%</div>
                        <div class="text-sm text-right font-heading font-bold" style="color: {% if bt.pnl >= 0 %}#4ade80{% else %}#f87171{% endif %};">{{ '%+.0f'|format(bt.pnl) }}U</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB: Venues -->
        <!-- ═══════════════════════════════════════════ -->
        <div x-show="tab === 'venues'" x-transition.opacity>
            {% if venues %}
            <div class="rounded-xl p-4" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                {% for v in venues %}
                <a href="/tips/{{ v.meeting_id }}" class="venue-row" style="text-decoration:none; color:inherit;">
                    <div class="flex items-center gap-3">
                        <span class="font-heading font-semibold text-sm" style="color: var(--text-primary);">{{ v.name }}</span>
                        <span class="text-xs" style="color: var(--text-muted);">
                            {{ v.winners }}/{{ v.bets }} settled
                            {% if v.upcoming %}&middot; {{ v.upcoming }} upcoming{% endif %}
                        </span>
                    </div>
                    <span class="font-heading font-bold text-sm" style="color: {% if v.pnl >= 0 %}#4ade80{% elif v.pnl < 0 %}#f87171{% else %}var(--text-muted){% endif %};">
                        {% if v.bets > 0 %}{{ '%+.0f'|format(v.pnl) }}U{% else %}&mdash;{% endif %}
                    </span>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10 rounded-xl" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <p class="font-heading font-semibold" style="color: var(--text-secondary);">No venue data yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- ═══ CTA ═══ -->
        <div class="text-center py-6">
            <a href="/tips" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-heading font-bold text-sm uppercase tracking-wider transition-all hover:shadow-lg" style="background: var(--gradient-sunset); color: white; box-shadow: 0 0 20px rgba(233, 30, 140, 0.2);">
                View Today's Tips
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
            </a>
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16 rounded-xl" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
            <div class="text-5xl mb-4">&#x1F3C7;</div>
            <h2 class="text-2xl font-heading font-bold mb-2" style="color: var(--text-primary);">No Bets Today</h2>
            <p class="mb-6" style="color: var(--text-secondary);">
                Tips haven't been generated yet. Check back once the early mail drops.
            </p>
            <a href="/tips" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-heading font-bold text-sm uppercase tracking-wider transition-all" style="background: var(--gradient-sunset); color: white;">
                View Tips
            </a>
        </div>
        {% endif %}

    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    return {
        tab: '{{ "results" if has_settled else "upcoming" }}',
    };
}

{% if has_settled and timeline|length > 2 %}
// ── P&L Chart (lightweight canvas, no library needed) ──
document.addEventListener('DOMContentLoaded', function() {
    var canvas = document.getElementById('pnlChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');

    // Timeline data from server
    var data = {{ timeline | tojson }};
    if (data.length < 2) return;

    // Sizing
    var rect = canvas.parentElement.getBoundingClientRect();
    var dpr = window.devicePixelRatio || 1;
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    var W = rect.width, H = rect.height;

    var padL = 50, padR = 16, padT = 16, padB = 28;
    var chartW = W - padL - padR;
    var chartH = H - padT - padB;

    // Data range
    var vals = data.map(function(d) { return d.cumulative; });
    var minV = Math.min(0, Math.min.apply(null, vals));
    var maxV = Math.max(0, Math.max.apply(null, vals));
    var range = maxV - minV || 1;
    // Add 10% padding
    minV -= range * 0.1;
    maxV += range * 0.1;
    range = maxV - minV;

    function x(i) { return padL + (i / (data.length - 1)) * chartW; }
    function y(v) { return padT + (1 - (v - minV) / range) * chartH; }

    // Zero line
    var zeroY = y(0);
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(padL, zeroY);
    ctx.lineTo(W - padR, zeroY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Area fill
    ctx.beginPath();
    ctx.moveTo(x(0), zeroY);
    for (var i = 0; i < data.length; i++) {
        ctx.lineTo(x(i), y(data[i].cumulative));
    }
    ctx.lineTo(x(data.length - 1), zeroY);
    ctx.closePath();
    var lastVal = data[data.length - 1].cumulative;
    var grad = ctx.createLinearGradient(0, padT, 0, H - padB);
    if (lastVal >= 0) {
        grad.addColorStop(0, 'rgba(74, 222, 128, 0.2)');
        grad.addColorStop(1, 'rgba(74, 222, 128, 0.0)');
    } else {
        grad.addColorStop(0, 'rgba(248, 113, 113, 0.0)');
        grad.addColorStop(1, 'rgba(248, 113, 113, 0.2)');
    }
    ctx.fillStyle = grad;
    ctx.fill();

    // Line
    ctx.beginPath();
    for (var i = 0; i < data.length; i++) {
        if (i === 0) ctx.moveTo(x(i), y(data[i].cumulative));
        else ctx.lineTo(x(i), y(data[i].cumulative));
    }
    ctx.strokeStyle = lastVal >= 0 ? '#4ade80' : '#f87171';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Dots for wins
    for (var i = 0; i < data.length; i++) {
        if (data[i].hit) {
            ctx.beginPath();
            ctx.arc(x(i), y(data[i].cumulative), 3, 0, Math.PI * 2);
            ctx.fillStyle = '#4ade80';
            ctx.fill();
        }
    }

    // End value label
    ctx.font = 'bold 13px Rajdhani, sans-serif';
    ctx.fillStyle = lastVal >= 0 ? '#4ade80' : '#f87171';
    ctx.textAlign = 'right';
    ctx.fillText((lastVal >= 0 ? '+' : '') + lastVal.toFixed(0) + 'U', W - padR, y(lastVal) - 6);

    // Y-axis labels
    ctx.font = '10px Rajdhani, sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.textAlign = 'right';
    ctx.fillText('0', padL - 6, zeroY + 3);
    if (maxV > 0) ctx.fillText('+' + Math.round(maxV - range * 0.1), padL - 6, padT + 10);
    if (minV < 0) ctx.fillText(Math.round(minV + range * 0.1), padL - 6, H - padB);

    // X-axis time labels (first, middle, last)
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.textAlign = 'center';
    ctx.fillText(data[0].time, x(0), H - 4);
    if (data.length > 4) {
        var mid = Math.floor(data.length / 2);
        ctx.fillText(data[mid].time, x(mid), H - 4);
    }
    ctx.fillText(data[data.length - 1].time, x(data.length - 1), H - 4);
});
{% endif %}

// Auto-refresh every 2 minutes
setTimeout(function() { location.reload(); }, 120000);
</script>
{% endblock %}
