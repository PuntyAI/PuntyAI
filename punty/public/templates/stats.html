{% extends "base.html" %}

{% block title %}Punty's Stats - PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="See exactly how Punty performs. Filter by venue, distance, track condition, jockey, trainer and more. Full transparency, no hiding.">
<style>
    .sf-label {
        display: block;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 0.3rem;
    }
    .sf-input {
        width: 100%;
        padding: 0.45rem 0.65rem;
        font-size: 0.8rem;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        outline: none;
    }
    .sf-input:focus {
        border-color: var(--magenta);
        box-shadow: 0 0 0 2px rgba(233, 30, 140, 0.15);
    }
    .sf-input::placeholder { color: var(--text-muted); opacity: 0.5; }
    .sf-input option { background: var(--bg-card); }
    .sf-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        background: rgba(233, 30, 140, 0.12);
        color: var(--magenta);
        border: 1px solid rgba(233, 30, 140, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<section class="py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-heading font-bold mb-4">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Stats</span>
            </h1>
            <p class="text-lg max-w-2xl mx-auto" style="color: var(--text-secondary);">
                No bullshit, no curated highlight reels. Every bet Punty makes is tracked and settled automatically.
                Filter the numbers yourself and decide what's worth following.
            </p>
        </div>

        <!-- Today / All Time Toggle -->
        <div class="flex items-center justify-center gap-3 mb-6">
            <button id="btn-today" onclick="setTimeRange('today')"
                    class="px-5 py-2 rounded-lg font-heading font-semibold text-sm uppercase tracking-wider transition-all"
                    style="background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-muted);">
                Today
            </button>
            <button id="btn-alltime" onclick="setTimeRange('alltime')"
                    class="px-5 py-2 rounded-lg font-heading font-semibold text-sm uppercase tracking-wider transition-all"
                    style="background: var(--magenta); border: 1px solid var(--magenta); color: white;">
                All Time
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-8 overflow-hidden" id="filters-card">
            <!-- Filter Header â€” click to expand/collapse -->
            <button id="filters-toggle" onclick="toggleFilters()" class="w-full flex items-center justify-between px-5 py-3.5 text-left transition-colors hover:bg-white/[0.02]">
                <div class="flex items-center gap-3">
                    <svg class="w-4 h-4" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span class="text-sm font-heading font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Filters</span>
                    <span id="filter-count" class="hidden text-[10px] font-heading font-bold px-2 py-0.5 rounded-full" style="background: var(--magenta); color: white;"></span>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-clear" onclick="event.stopPropagation(); clearFilters()" class="hidden text-xs font-heading font-semibold uppercase tracking-wider px-3 py-1 rounded-md transition-colors hover:bg-white/5" style="color: var(--text-muted);">
                        Clear
                    </button>
                    <svg id="filters-chevron" class="w-5 h-5 transition-transform duration-200" style="color: var(--text-muted); transform: rotate(0deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </button>

            <!-- Active Filter Chips (shown when collapsed) -->
            <div id="filter-chips" class="hidden px-5 pb-3 flex flex-wrap gap-1.5"></div>

            <!-- Filter Body -->
            <div id="filters-body" class="hidden" style="border-top: 1px solid var(--border-subtle);">
                <div class="p-5 space-y-5">

                    <!-- Row 1: Meeting -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 rounded-full" style="background: var(--magenta);"></div>
                            <span class="text-[11px] font-heading font-bold uppercase tracking-widest" style="color: var(--magenta);">Meeting</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="sf-label">Venue</label>
                                <input type="text" id="f-venue" list="dl-venues" autocomplete="off" placeholder="Any venue" class="sf-input">
                                <datalist id="dl-venues"></datalist>
                            </div>
                            <div>
                                <label class="sf-label">State</label>
                                <select id="f-state" class="sf-input">
                                    <option value="">Any</option>
                                    <option value="VIC">VIC</option>
                                    <option value="NSW">NSW</option>
                                    <option value="QLD">QLD</option>
                                    <option value="SA">SA</option>
                                    <option value="WA">WA</option>
                                    <option value="TAS">TAS</option>
                                    <option value="ACT">ACT</option>
                                    <option value="NT">NT</option>
                                </select>
                            </div>
                            <div>
                                <label class="sf-label">Track Condition</label>
                                <select id="f-track" class="sf-input">
                                    <option value="">Any</option>
                                </select>
                            </div>
                            <div>
                                <label class="sf-label">Weather</label>
                                <select id="f-weather" class="sf-input">
                                    <option value="">Any</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Race -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 rounded-full" style="background: var(--cyan);"></div>
                            <span class="text-[11px] font-heading font-bold uppercase tracking-widest" style="color: var(--cyan);">Race</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="sf-label">Distance</label>
                                <div class="flex gap-1.5">
                                    <input type="number" id="f-dist-min" placeholder="Min" min="800" max="4000" step="100" class="sf-input">
                                    <input type="number" id="f-dist-max" placeholder="Max" min="800" max="4000" step="100" class="sf-input">
                                </div>
                            </div>
                            <div>
                                <label class="sf-label">Class</label>
                                <input type="text" id="f-class" list="dl-classes" autocomplete="off" placeholder="Any class" class="sf-input">
                                <datalist id="dl-classes"></datalist>
                            </div>
                            <div>
                                <label class="sf-label">Field Size</label>
                                <div class="flex gap-1.5">
                                    <input type="number" id="f-field-min" placeholder="Min" min="1" max="24" class="sf-input">
                                    <input type="number" id="f-field-max" placeholder="Max" min="1" max="24" class="sf-input">
                                </div>
                            </div>
                            <div>
                                <label class="sf-label">Date Range</label>
                                <div class="flex gap-1.5">
                                    <input type="date" id="f-date-from" class="sf-input" style="color-scheme: dark;">
                                    <input type="date" id="f-date-to" class="sf-input" style="color-scheme: dark;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Runner (selections only) -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 rounded-full" style="background: var(--yellow);"></div>
                            <span class="text-[11px] font-heading font-bold uppercase tracking-widest" style="color: var(--yellow);">Runner</span>
                            <span class="text-[10px] font-heading" style="color: var(--text-muted);">(selections only)</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="sf-label">Jockey</label>
                                <input type="text" id="f-jockey" list="dl-jockeys" autocomplete="off" placeholder="Any jockey" class="sf-input">
                                <datalist id="dl-jockeys"></datalist>
                            </div>
                            <div>
                                <label class="sf-label">Trainer</label>
                                <input type="text" id="f-trainer" list="dl-trainers" autocomplete="off" placeholder="Any trainer" class="sf-input">
                                <datalist id="dl-trainers"></datalist>
                            </div>
                            <div>
                                <label class="sf-label">Sex</label>
                                <select id="f-sex" class="sf-input">
                                    <option value="">Any</option>
                                    <option value="M">Mare</option>
                                    <option value="G">Gelding</option>
                                    <option value="C">Colt</option>
                                    <option value="F">Filly</option>
                                    <option value="H">Horse</option>
                                    <option value="R">Rig</option>
                                </select>
                            </div>
                            <div>
                                <label class="sf-label">Barrier</label>
                                <input type="number" id="f-barrier-min" placeholder="Min" min="1" max="24" class="sf-input">
                            </div>
                        </div>
                    </div>

                    <!-- Row 4: Bet -->
                    <div>
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-1 h-4 rounded-full" style="background: var(--purple);"></div>
                            <span class="text-[11px] font-heading font-bold uppercase tracking-widest" style="color: var(--purple);">Bet</span>
                            <span class="text-[10px] font-heading" style="color: var(--text-muted);">(selections only)</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                                <label class="sf-label">Tip Rank</label>
                                <select id="f-rank" class="sf-input">
                                    <option value="">Any</option>
                                    <option value="1">Top Pick</option>
                                    <option value="2">2nd Pick</option>
                                    <option value="3">3rd Pick</option>
                                    <option value="4">Roughie</option>
                                </select>
                            </div>
                            <div>
                                <label class="sf-label">Odds Range</label>
                                <div class="flex gap-1.5">
                                    <input type="number" id="f-odds-min" placeholder="Min" min="1" step="0.5" class="sf-input">
                                    <input type="number" id="f-odds-max" placeholder="Max" min="1" step="0.5" class="sf-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Apply Bar -->
                <div class="flex items-center justify-end gap-3 px-5 py-3" style="background: rgba(255,255,255,0.02); border-top: 1px solid var(--border-subtle);">
                    <button onclick="applyFilters()" class="px-6 py-2 rounded-lg font-heading font-semibold text-sm uppercase tracking-wider transition-all hover:shadow-lg" style="background: var(--magenta); color: white; box-shadow: 0 0 20px rgba(233, 30, 140, 0.2);">
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <!-- Runner Filter Notice -->
        <div id="runner-notice" class="hidden mb-6 px-4 py-2.5 rounded-lg text-sm" style="background: rgba(0, 212, 255, 0.08); border: 1px solid rgba(0, 212, 255, 0.2); color: var(--cyan);">
            Showing selection stats only &mdash; jockey, trainer, sex, barrier, rank, and odds filters apply to individual picks, not multi-runner bets.
        </div>

        <!-- Loading -->
        <div id="stats-loading" class="text-center py-12">
            <div class="inline-block w-8 h-8 border-2 rounded-full animate-spin" style="border-color: var(--magenta) transparent var(--magenta) transparent;"></div>
            <p class="mt-3 text-sm" style="color: var(--text-muted);">Crunching the numbers...</p>
        </div>

        <!-- Stats Grid -->
        <div id="stats-grid" class="hidden">
            <!-- Summary bar -->
            <div id="stats-summary" class="flex flex-wrap items-center justify-center gap-6 mb-6 px-4 py-3 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-subtle);"></div>

            <!-- Category sections -->
            <div id="stats-selections" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--magenta);">Selections</h3>
                <div id="grid-selections" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>

            <div id="stats-exotics" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--cyan);">Exotics</h3>
                <div id="grid-exotics" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>

            <div id="stats-sequences" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--yellow);">Sequences</h3>
                <div id="grid-sequences" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>

            <div id="stats-multi" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--purple);">Multi</h3>
                <div id="grid-multi" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="stats-empty" class="hidden card p-12 text-center">
            <div class="text-5xl mb-4">&#x1F4CA;</div>
            <h2 class="text-2xl font-heading font-bold mb-2">No Data</h2>
            <p style="color: var(--text-secondary);">
                No settled bets match those filters. Try broadening your search.
            </p>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var timeRange = 'alltime'; // 'today' or 'alltime'

    // Filter field IDs and their API param names
    var FILTERS = {
        'f-venue': 'venue',
        'f-state': 'state',
        'f-track': 'track_condition',
        'f-weather': 'weather',
        'f-dist-min': 'distance_min',
        'f-dist-max': 'distance_max',
        'f-class': 'race_class',
        'f-field-min': 'field_size_min',
        'f-field-max': 'field_size_max',
        'f-jockey': 'jockey',
        'f-trainer': 'trainer',
        'f-sex': 'horse_sex',
        'f-barrier-min': 'barrier_min',
        'f-rank': 'tip_rank',
        'f-odds-min': 'odds_min',
        'f-odds-max': 'odds_max',
        'f-date-from': 'date_from',
        'f-date-to': 'date_to'
    };

    // Runner-level filter IDs (these hide exotics/sequences)
    var RUNNER_FILTERS = ['f-jockey', 'f-trainer', 'f-sex', 'f-barrier-min', 'f-rank', 'f-odds-min', 'f-odds-max'];

    function getFilterParams() {
        var params = new URLSearchParams();
        var count = 0;
        var hasRunnerFilter = false;

        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el && el.value) {
                params.set(FILTERS[id], el.value);
                count++;
                if (RUNNER_FILTERS.indexOf(id) !== -1) hasRunnerFilter = true;
            }
        }

        if (timeRange === 'today') {
            params.set('today', 'true');
        }

        return { params: params, count: count, hasRunnerFilter: hasRunnerFilter };
    }

    function renderCard(s) {
        var categoryColors = {
            'Selections': 'var(--magenta)',
            'Exotics': 'var(--cyan)',
            'Sequences': 'var(--yellow)',
            'Multi': 'var(--purple)'
        };
        var color = categoryColors[s.category] || 'var(--text-secondary)';
        var pnlColor = s.pnl >= 0 ? '#4ade80' : '#f87171';
        var pnlSign = s.pnl >= 0 ? '+' : '-';

        return '<div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">' +
            '<div class="text-xs font-heading font-semibold uppercase tracking-wider mb-2" style="color: ' + color + ';">' + s.type + '</div>' +
            '<div class="text-2xl font-display font-bold" style="color: ' + color + ';">' + s.rate + '%</div>' +
            '<div class="text-[10px] font-heading uppercase tracking-wider mt-0.5 mb-1" style="color: var(--text-muted);">strike rate</div>' +
            '<div class="text-xs" style="color: var(--text-muted);">' + s.won + '/' + s.total + ' winners</div>' +
            '<div class="text-sm font-heading font-semibold mt-1" style="color: ' + pnlColor + ';">' + pnlSign + '$' + Math.abs(s.pnl).toFixed(0) + '</div>' +
        '</div>';
    }

    function renderStats(stats, hasRunnerFilter) {
        var loading = document.getElementById('stats-loading');
        var grid = document.getElementById('stats-grid');
        var empty = document.getElementById('stats-empty');
        var notice = document.getElementById('runner-notice');

        loading.classList.add('hidden');

        if (!stats || stats.length === 0) {
            grid.classList.add('hidden');
            empty.classList.remove('hidden');
            notice.classList.add('hidden');
            return;
        }

        empty.classList.add('hidden');
        grid.classList.remove('hidden');
        notice.classList.toggle('hidden', !hasRunnerFilter);

        // Group by category
        var groups = { Selections: [], Exotics: [], Sequences: [], Multi: [] };
        var totalBets = 0, totalWon = 0, totalPnl = 0;

        stats.forEach(function(s) {
            var cat = s.category;
            if (groups[cat]) groups[cat].push(s);
            totalBets += s.total;
            totalWon += s.won;
            totalPnl += s.pnl;
        });

        // Summary bar
        var overallRate = totalBets > 0 ? (totalWon / totalBets * 100).toFixed(1) : '0';
        var pnlColor = totalPnl >= 0 ? '#4ade80' : '#f87171';
        var pnlSign = totalPnl >= 0 ? '+' : '-';
        document.getElementById('stats-summary').innerHTML =
            '<span style="color:var(--text-muted)" class="text-xs font-heading font-semibold uppercase tracking-wider">' + (timeRange === 'today' ? 'Today' : 'All Time') + '</span>' +
            '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--cyan)">' + overallRate + '%</span> <span class="text-xs" style="color:var(--text-muted)">strike rate</span></span>' +
            '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--text-secondary)">' + totalWon + '/' + totalBets + '</span> <span class="text-xs" style="color:var(--text-muted)">winners</span></span>';

        // Render each category
        ['Selections', 'Exotics', 'Sequences', 'Multi'].forEach(function(cat) {
            var section = document.getElementById('stats-' + cat.toLowerCase());
            var gridEl = document.getElementById('grid-' + cat.toLowerCase());
            if (groups[cat].length > 0) {
                section.classList.remove('hidden');
                gridEl.innerHTML = groups[cat].map(renderCard).join('');
            } else {
                section.classList.add('hidden');
            }
        });
    }

    function fetchStats() {
        var loading = document.getElementById('stats-loading');
        var grid = document.getElementById('stats-grid');
        var empty = document.getElementById('stats-empty');

        loading.classList.remove('hidden');
        grid.classList.add('hidden');
        empty.classList.add('hidden');

        var fp = getFilterParams();
        var url = '/api/public/bet-type-stats';
        if (fp.params.toString()) url += '?' + fp.params.toString();

        // Update filter count badge
        var countEl = document.getElementById('filter-count');
        var clearEl = document.getElementById('btn-clear');
        if (fp.count > 0) {
            countEl.textContent = fp.count;
            countEl.classList.remove('hidden');
            clearEl.classList.remove('hidden');
        } else {
            countEl.classList.add('hidden');
            clearEl.classList.add('hidden');
        }

        updateChips();

        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) { renderStats(data, fp.hasRunnerFilter); })
            .catch(function() {
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            });
    }

    // Expose functions to global scope for onclick handlers
    window.applyFilters = function() {
        // Update URL without reload
        var fp = getFilterParams();
        var newUrl = '/stats';
        if (fp.params.toString()) newUrl += '?' + fp.params.toString();
        history.replaceState(null, '', newUrl);
        // Collapse filters after applying
        if (filtersOpen) { window.toggleFilters(); }
        fetchStats();
    };

    window.clearFilters = function() {
        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el) el.value = '';
        }
        timeRange = 'alltime';
        updateToggleUI();
        updateChips();
        history.replaceState(null, '', '/stats');
        fetchStats();
    };

    window.setTimeRange = function(range) {
        timeRange = range;
        updateToggleUI();
        // Clear date filters when switching to today
        if (range === 'today') {
            document.getElementById('f-date-from').value = '';
            document.getElementById('f-date-to').value = '';
        }
        fetchStats();
    };

    function updateToggleUI() {
        var btnToday = document.getElementById('btn-today');
        var btnAll = document.getElementById('btn-alltime');
        if (timeRange === 'today') {
            btnToday.style.background = 'var(--magenta)';
            btnToday.style.borderColor = 'var(--magenta)';
            btnToday.style.color = 'white';
            btnAll.style.background = 'var(--bg-card)';
            btnAll.style.borderColor = 'var(--border-subtle)';
            btnAll.style.color = 'var(--text-muted)';
        } else {
            btnAll.style.background = 'var(--magenta)';
            btnAll.style.borderColor = 'var(--magenta)';
            btnAll.style.color = 'white';
            btnToday.style.background = 'var(--bg-card)';
            btnToday.style.borderColor = 'var(--border-subtle)';
            btnToday.style.color = 'var(--text-muted)';
        }
    }

    // Load filter options for autocomplete
    function loadFilterOptions() {
        fetch('/api/public/filter-options')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                function fill(dlId, items) {
                    var dl = document.getElementById(dlId);
                    if (!dl) return;
                    items.forEach(function(v) {
                        var o = document.createElement('option');
                        o.value = v;
                        dl.appendChild(o);
                    });
                }
                fill('dl-venues', data.venues || []);
                fill('dl-jockeys', data.jockeys || []);
                fill('dl-trainers', data.trainers || []);
                fill('dl-classes', data.classes || []);

                // Populate track condition select
                var tcSelect = document.getElementById('f-track');
                (data.track_conditions || []).forEach(function(v) {
                    var o = document.createElement('option');
                    o.value = v;
                    o.textContent = v;
                    tcSelect.appendChild(o);
                });

                // Populate weather select
                var wSelect = document.getElementById('f-weather');
                (data.weather || []).forEach(function(v) {
                    var o = document.createElement('option');
                    o.value = v;
                    o.textContent = v;
                    wSelect.appendChild(o);
                });
            })
            .catch(function() {});
    }

    // Read initial filters from URL params
    function initFromUrl() {
        var params = new URLSearchParams(window.location.search);
        for (var id in FILTERS) {
            var val = params.get(FILTERS[id]);
            if (val) {
                var el = document.getElementById(id);
                if (el) el.value = val;
            }
        }
        if (params.get('today') === 'true') {
            timeRange = 'today';
            updateToggleUI();
        }
    }

    // Filter panel toggle
    var filtersOpen = false;
    window.toggleFilters = function() {
        filtersOpen = !filtersOpen;
        document.getElementById('filters-body').classList.toggle('hidden', !filtersOpen);
        document.getElementById('filters-chevron').style.transform = filtersOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        // Hide chips when open, show when closed + has filters
        updateChips();
    };

    // Filter chips (shown when filters panel is collapsed)
    var FILTER_LABELS = {
        'f-venue': 'Venue', 'f-state': 'State', 'f-track': 'Track',
        'f-weather': 'Weather', 'f-dist-min': 'Dist Min', 'f-dist-max': 'Dist Max',
        'f-class': 'Class', 'f-field-min': 'Field Min', 'f-field-max': 'Field Max',
        'f-jockey': 'Jockey', 'f-trainer': 'Trainer', 'f-sex': 'Sex',
        'f-barrier-min': 'Barrier', 'f-rank': 'Rank', 'f-odds-min': 'Odds Min',
        'f-odds-max': 'Odds Max', 'f-date-from': 'From', 'f-date-to': 'To'
    };

    function updateChips() {
        var chipsEl = document.getElementById('filter-chips');
        if (filtersOpen) { chipsEl.classList.add('hidden'); return; }

        var chips = [];
        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el && el.value) {
                var displayVal = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                chips.push('<span class="sf-chip">' + (FILTER_LABELS[id] || id) + ': ' + displayVal + '</span>');
            }
        }
        if (chips.length > 0) {
            chipsEl.innerHTML = chips.join('');
            chipsEl.classList.remove('hidden');
        } else {
            chipsEl.classList.add('hidden');
        }
    }

    // Allow Enter key to apply filters
    document.getElementById('filters-card').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            window.applyFilters();
        }
    });

    // Init
    initFromUrl();
    loadFilterOptions();
    fetchStats();

    // If URL has filters, open the panel
    var initParams = new URLSearchParams(window.location.search);
    var hasInitFilters = false;
    for (var _id in FILTERS) {
        if (initParams.get(FILTERS[_id])) { hasInitFilters = true; break; }
    }
    if (hasInitFilters) { window.toggleFilters(); }
})();
</script>
{% endblock %}
