{% extends "base.html" %}

{% block title %}Punty's Stats - PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="See exactly how Punty performs. Filter by venue, distance, track condition, jockey, trainer and more. Full transparency, no hiding.">
<style>
    .sf-label {
        display: block;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
    }
    .sf-input {
        width: 100%;
        padding: 0.45rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 8px;
        background: var(--bg-dark);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        color-scheme: dark;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        outline: none;
        min-width: 0;
    }
    .sf-input:focus {
        border-color: var(--magenta);
        box-shadow: 0 0 0 2px rgba(233, 30, 140, 0.15);
    }
    .sf-input::placeholder { color: var(--text-muted); opacity: 0.5; }
    .sf-input option { background: var(--bg-card); color: var(--text-primary); }
    .sf-input[type="date"] {
        padding: 0.45rem 0.4rem;
        font-size: 0.75rem;
        min-width: 0;
    }
    .sf-input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(0.7);
        cursor: pointer;
        padding: 0;
        margin: 0;
    }
    .sf-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        background: rgba(233, 30, 140, 0.12);
        color: var(--magenta);
        border: 1px solid rgba(233, 30, 140, 0.2);
    }
    .sf-group {
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.015);
    }
    .sf-group-header {
        display: flex; align-items: center; gap: 0.5rem;
        margin-bottom: 0.625rem; padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-subtle);
    }
    .sf-group-icon {
        width: 24px; height: 24px; border-radius: 6px;
        display: flex; align-items: center; justify-content: center;
    }
    .sf-group-title {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .sf-group-note {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.65rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<section class="py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-heading font-bold mb-4">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Punty's Stats</span>
            </h1>
            <p class="text-lg max-w-2xl mx-auto" style="color: var(--text-secondary);">
                No bullshit, no curated highlight reels. Every bet Punty makes is tracked and settled automatically.
                Filter the numbers yourself and decide what's worth following.
            </p>
        </div>

        <!-- Punty's Pick + Tip Ranks -->
        <div class="max-w-2xl mx-auto mb-8">
            <!-- Punty's Pick -->
            <div class="rounded-xl mb-3 py-4" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="flex items-center justify-center gap-5">
                    <img src="/static/punty-character.jpg" alt="Punty" class="w-12 h-12 rounded-full object-cover flex-shrink-0" style="border: 2px solid rgba(233, 30, 140, 0.4);">
                    <div>
                        <div class="text-[10px] font-heading font-bold uppercase tracking-widest" style="color: var(--text-muted);">Punty's Pick</div>
                        <div class="flex items-baseline gap-3">
                            <div class="text-3xl font-display font-bold leading-none" id="tr-rate-0" style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">—</div>
                            <div class="text-xs whitespace-nowrap" style="color: var(--text-muted);" id="tr-count-0"></div>
                            <div class="text-xs font-heading font-semibold whitespace-nowrap" id="tr-roi-0"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Tip Rank Strike Rates -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-2xl font-display font-bold" style="color: var(--magenta);" id="tr-rate-1">—</div>
                <div class="text-[10px] font-heading font-semibold uppercase tracking-wider mt-1" style="color: var(--text-muted);">Top Pick</div>
                <div class="text-[10px] mt-0.5" style="color: var(--text-muted);" id="tr-count-1"></div>
                <div class="text-[10px] font-heading font-semibold mt-0.5" id="tr-roi-1"></div>
            </div>
            <div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-2xl font-display font-bold" style="color: var(--cyan);" id="tr-rate-2">—</div>
                <div class="text-[10px] font-heading font-semibold uppercase tracking-wider mt-1" style="color: var(--text-muted);">2nd Pick</div>
                <div class="text-[10px] mt-0.5" style="color: var(--text-muted);" id="tr-count-2"></div>
                <div class="text-[10px] font-heading font-semibold mt-0.5" id="tr-roi-2"></div>
            </div>
            <div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-2xl font-display font-bold" style="color: var(--yellow);" id="tr-rate-3">—</div>
                <div class="text-[10px] font-heading font-semibold uppercase tracking-wider mt-1" style="color: var(--text-muted);">3rd Pick</div>
                <div class="text-[10px] mt-0.5" style="color: var(--text-muted);" id="tr-count-3"></div>
                <div class="text-[10px] font-heading font-semibold mt-0.5" id="tr-roi-3"></div>
            </div>
            <div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-2xl font-display font-bold" style="color: var(--purple);" id="tr-rate-4">—</div>
                <div class="text-[10px] font-heading font-semibold uppercase tracking-wider mt-1" style="color: var(--text-muted);">Roughie</div>
                <div class="text-[10px] mt-0.5" style="color: var(--text-muted);" id="tr-count-4"></div>
                <div class="text-[10px] font-heading font-semibold mt-0.5" id="tr-roi-4"></div>
            </div>
            <p class="text-center text-[10px] mt-2 font-heading uppercase tracking-wider" style="color: var(--text-muted);">Strike Rate &amp; ROI &mdash; All Time</p>
        </div>

        <!-- Today / All Time Toggle -->
        <div class="flex items-center justify-center gap-3 mb-6">
            <button id="btn-today" onclick="setTimeRange('today')"
                    class="px-5 py-2 rounded-lg font-heading font-semibold text-sm uppercase tracking-wider transition-all"
                    style="background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-muted);">
                Today
            </button>
            <button id="btn-alltime" onclick="setTimeRange('alltime')"
                    class="px-5 py-2 rounded-lg font-heading font-semibold text-sm uppercase tracking-wider transition-all"
                    style="background: var(--magenta); border: 1px solid var(--magenta); color: white;">
                All Time
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-8 overflow-hidden" id="filters-card">
            <!-- Filter Header — click to expand/collapse -->
            <div id="filters-toggle" onclick="toggleFilters()" role="button" tabindex="0"
                 style="display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 1.25rem; cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg style="width: 1rem; height: 1rem; color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span class="text-sm font-heading font-semibold uppercase tracking-wider" style="color: var(--text-secondary);">Filters</span>
                    <span id="filter-count" class="text-[10px] font-heading font-bold px-2 py-0.5 rounded-full" style="background: var(--magenta); color: white; display: none;"></span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span id="btn-clear" onclick="event.stopPropagation(); clearFilters()" role="button"
                          class="text-xs font-heading font-semibold uppercase tracking-wider px-3 py-1 rounded-md hover:bg-white/5"
                          style="color: var(--text-muted); cursor: pointer; display: none;">
                        Clear
                    </span>
                    <svg id="filters-chevron" style="width: 1.25rem; height: 1.25rem; color: var(--text-muted); transform: rotate(0deg); transition: transform 0.2s;" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </div>

            <!-- Active Filter Chips (shown when collapsed) -->
            <div id="filter-chips" class="hidden px-5 pb-3 flex-wrap gap-1.5" style="display: none;"></div>

            <!-- Filter Body -->
            <div id="filters-body" class="hidden" style="border-top: 1px solid var(--border-subtle);">
                <div class="p-4 space-y-3">

                    <!-- Meeting + Race row (side by side on desktop) -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Meeting -->
                        <div class="sf-group">
                            <div class="sf-group-header">
                                <div class="sf-group-icon" style="background: rgba(233, 30, 140, 0.15);">
                                    <svg class="w-3.5 h-3.5" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>
                                </div>
                                <span class="sf-group-title" style="color: var(--magenta);">Meeting</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2.5">
                                <div>
                                    <label class="sf-label">Venue</label>
                                    <input type="text" id="f-venue" list="dl-venues" autocomplete="off" placeholder="Any venue" class="sf-input">
                                    <datalist id="dl-venues"></datalist>
                                </div>
                                <div>
                                    <label class="sf-label">State</label>
                                    <select id="f-state" class="sf-input">
                                        <option value="">Any</option>
                                        <option value="VIC">VIC</option>
                                        <option value="NSW">NSW</option>
                                        <option value="QLD">QLD</option>
                                        <option value="SA">SA</option>
                                        <option value="WA">WA</option>
                                        <option value="TAS">TAS</option>
                                        <option value="ACT">ACT</option>
                                        <option value="NT">NT</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="sf-label">Track</label>
                                    <select id="f-track" class="sf-input">
                                        <option value="">Any</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="sf-label">Weather</label>
                                    <select id="f-weather" class="sf-input">
                                        <option value="">Any</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Race -->
                        <div class="sf-group">
                            <div class="sf-group-header">
                                <div class="sf-group-icon" style="background: rgba(0, 212, 255, 0.15);">
                                    <svg class="w-3.5 h-3.5" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                </div>
                                <span class="sf-group-title" style="color: var(--cyan);">Race</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2.5">
                                <div>
                                    <label class="sf-label">Distance</label>
                                    <div class="flex gap-1.5">
                                        <input type="number" id="f-dist-min" placeholder="Min" min="800" max="4000" step="100" class="sf-input">
                                        <input type="number" id="f-dist-max" placeholder="Max" min="800" max="4000" step="100" class="sf-input">
                                    </div>
                                </div>
                                <div>
                                    <label class="sf-label">Field Size</label>
                                    <div class="flex gap-1.5">
                                        <input type="number" id="f-field-min" placeholder="Min" min="1" max="24" class="sf-input">
                                        <input type="number" id="f-field-max" placeholder="Max" min="1" max="24" class="sf-input">
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <label class="sf-label">Class</label>
                                    <input type="text" id="f-class" list="dl-classes" autocomplete="off" placeholder="Any class" class="sf-input">
                                    <datalist id="dl-classes"></datalist>
                                </div>
                                <div>
                                    <label class="sf-label">From</label>
                                    <input type="date" id="f-date-from" class="sf-input" title="From date">
                                </div>
                                <div>
                                    <label class="sf-label">To</label>
                                    <input type="date" id="f-date-to" class="sf-input" title="To date">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Runner + Bet row (side by side on desktop) -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Runner -->
                        <div class="sf-group">
                            <div class="sf-group-header">
                                <div class="sf-group-icon" style="background: rgba(255, 193, 7, 0.15);">
                                    <svg class="w-3.5 h-3.5" style="color: var(--yellow);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                </div>
                                <span class="sf-group-title" style="color: var(--yellow);">Runner</span>
                                <span class="sf-group-note">selections only</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2.5">
                                <div>
                                    <label class="sf-label">Jockey</label>
                                    <input type="text" id="f-jockey" list="dl-jockeys" autocomplete="off" placeholder="Any jockey" class="sf-input">
                                    <datalist id="dl-jockeys"></datalist>
                                </div>
                                <div>
                                    <label class="sf-label">Trainer</label>
                                    <input type="text" id="f-trainer" list="dl-trainers" autocomplete="off" placeholder="Any trainer" class="sf-input">
                                    <datalist id="dl-trainers"></datalist>
                                </div>
                                <div>
                                    <label class="sf-label">Sex</label>
                                    <select id="f-sex" class="sf-input">
                                        <option value="">Any</option>
                                        <option value="Mare">Mare</option>
                                        <option value="Gelding">Gelding</option>
                                        <option value="Colt">Colt</option>
                                        <option value="Filly">Filly</option>
                                        <option value="Horse">Horse</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="sf-label">Barrier</label>
                                    <input type="number" id="f-barrier-min" placeholder="Min" min="1" max="24" class="sf-input">
                                </div>
                            </div>
                        </div>

                        <!-- Bet -->
                        <div class="sf-group">
                            <div class="sf-group-header">
                                <div class="sf-group-icon" style="background: rgba(157, 78, 221, 0.15);">
                                    <svg class="w-3.5 h-3.5" style="color: var(--purple);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <span class="sf-group-title" style="color: var(--purple);">Bet</span>
                                <span class="sf-group-note">selections only</span>
                            </div>
                            <div class="grid grid-cols-2 gap-x-3 gap-y-2.5">
                                <div>
                                    <label class="sf-label">Tip Rank</label>
                                    <select id="f-rank" class="sf-input">
                                        <option value="">Any</option>
                                        <option value="1">Top Pick</option>
                                        <option value="2">2nd Pick</option>
                                        <option value="3">3rd Pick</option>
                                        <option value="4">Roughie</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="sf-label">Odds Range</label>
                                    <div class="flex gap-1.5">
                                        <input type="number" id="f-odds-min" placeholder="Min" min="1" step="0.5" class="sf-input">
                                        <input type="number" id="f-odds-max" placeholder="Max" min="1" step="0.5" class="sf-input">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Apply Bar -->
                <div class="flex items-center justify-between gap-3 px-4 py-2.5" style="background: rgba(255,255,255,0.02); border-top: 1px solid var(--border-subtle);">
                    <span onclick="event.stopPropagation(); clearFilters()" role="button"
                          class="text-xs font-heading font-semibold uppercase tracking-wider px-3 py-1.5 rounded-md hover:bg-white/5"
                          style="color: var(--text-muted); cursor: pointer;">
                        Reset All
                    </span>
                    <button onclick="applyFilters()" class="px-6 py-2 rounded-lg font-heading font-bold text-sm uppercase tracking-wider transition-all hover:shadow-lg" style="background: var(--gradient-sunset); color: white; box-shadow: 0 0 20px rgba(233, 30, 140, 0.2);">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Runner Filter Notice -->
        <div id="runner-notice" class="hidden mb-6 px-4 py-2.5 rounded-lg text-sm" style="background: rgba(0, 212, 255, 0.08); border: 1px solid rgba(0, 212, 255, 0.2); color: var(--cyan);">
            Heads up &mdash; you've got runner-specific filters on, so Punty's hidden the exotics, sequences, and multis. Can't exactly filter a quaddie by jockey unless you want Punty to have a meltdown. Clear those filters to see the full picture.
        </div>

        <!-- Loading -->
        <div id="stats-loading" class="text-center py-12">
            <div class="inline-block w-8 h-8 border-2 rounded-full animate-spin" style="border-color: var(--magenta) transparent var(--magenta) transparent;"></div>
            <p class="mt-3 text-sm" style="color: var(--text-muted);">Crunching the numbers...</p>
        </div>

        <!-- Stats Grid -->
        <div id="stats-grid" class="hidden">
            <!-- Summary bar -->
            <div id="stats-summary" class="flex flex-wrap items-center justify-center gap-6 mb-6 px-4 py-3 rounded-lg" style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border-subtle);"></div>

            <!-- Category sections -->
            <div id="stats-selections" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--magenta);">Selections</h3>
                <div id="grid-selections" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>

            <div id="stats-exotics" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--cyan);">Exotics</h3>
                <div id="grid-exotics" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>

            <div id="stats-sequences" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--yellow);">Sequences</h3>
                <div id="grid-sequences" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>

            <div id="stats-multi" class="mb-6">
                <h3 class="font-heading font-bold text-sm uppercase tracking-wider mb-3" style="color: var(--purple);">Multi</h3>
                <div id="grid-multi" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="stats-empty" class="hidden card p-12 text-center">
            <div class="text-5xl mb-4">&#x1F4CA;</div>
            <h2 class="text-2xl font-heading font-bold mb-2">No Data</h2>
            <p style="color: var(--text-secondary);">
                No settled bets match those filters. Try broadening your search.
            </p>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var timeRange = 'alltime'; // 'today' or 'alltime'

    // Filter field IDs and their API param names
    var FILTERS = {
        'f-venue': 'venue',
        'f-state': 'state',
        'f-track': 'track_condition',
        'f-weather': 'weather',
        'f-dist-min': 'distance_min',
        'f-dist-max': 'distance_max',
        'f-class': 'race_class',
        'f-field-min': 'field_size_min',
        'f-field-max': 'field_size_max',
        'f-jockey': 'jockey',
        'f-trainer': 'trainer',
        'f-sex': 'horse_sex',
        'f-barrier-min': 'barrier_min',
        'f-rank': 'tip_rank',
        'f-odds-min': 'odds_min',
        'f-odds-max': 'odds_max',
        'f-date-from': 'date_from',
        'f-date-to': 'date_to'
    };

    // Runner-level filter IDs (these hide exotics/sequences)
    var RUNNER_FILTERS = ['f-jockey', 'f-trainer', 'f-sex', 'f-barrier-min', 'f-rank', 'f-odds-min', 'f-odds-max'];

    function getFilterParams() {
        var params = new URLSearchParams();
        var count = 0;
        var hasRunnerFilter = false;

        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el && el.value) {
                params.set(FILTERS[id], el.value);
                count++;
                if (RUNNER_FILTERS.indexOf(id) !== -1) hasRunnerFilter = true;
            }
        }

        if (timeRange === 'today') {
            params.set('today', 'true');
        }

        return { params: params, count: count, hasRunnerFilter: hasRunnerFilter };
    }

    function renderCard(s) {
        var categoryColors = {
            'Selections': 'var(--magenta)',
            'Exotics': 'var(--cyan)',
            'Sequences': 'var(--yellow)',
            'Multi': 'var(--purple)'
        };
        var color = categoryColors[s.category] || 'var(--text-secondary)';
        var roi = s.staked ? (s.pnl / s.staked * 100) : 0;
        var pnlColor = roi >= 0 ? '#4ade80' : '#f87171';

        return '<div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">' +
            '<div class="text-xs font-heading font-semibold uppercase tracking-wider mb-2" style="color: ' + color + ';">' + s.type + '</div>' +
            '<div class="text-2xl font-display font-bold" style="color: ' + color + ';">' + s.rate + '%</div>' +
            '<div class="text-[10px] font-heading uppercase tracking-wider mt-0.5 mb-1" style="color: var(--text-muted);">strike rate</div>' +
            '<div class="text-xs" style="color: var(--text-muted);">' + s.won + '/' + s.total + ' winners</div>' +
            '<div class="text-sm font-heading font-semibold mt-1" style="color: ' + pnlColor + ';">' + (roi >= 0 ? '+' : '') + roi.toFixed(1) + '% ROI</div>' +
        '</div>';
    }

    function renderStats(stats, hasRunnerFilter) {
        var loading = document.getElementById('stats-loading');
        var grid = document.getElementById('stats-grid');
        var empty = document.getElementById('stats-empty');
        var notice = document.getElementById('runner-notice');

        loading.classList.add('hidden');

        if (!stats || stats.length === 0) {
            grid.classList.add('hidden');
            empty.classList.remove('hidden');
            notice.classList.add('hidden');
            return;
        }

        empty.classList.add('hidden');
        grid.classList.remove('hidden');
        notice.classList.toggle('hidden', !hasRunnerFilter);

        // Group by category
        var groups = { Selections: [], Exotics: [], Sequences: [], Multi: [] };
        var totalBets = 0, totalWon = 0, totalPnl = 0;

        stats.forEach(function(s) {
            var cat = s.category;
            if (groups[cat]) groups[cat].push(s);
            totalBets += s.total;
            totalWon += s.won;
            totalPnl += s.pnl;
        });

        // Summary bar
        var overallRate = totalBets > 0 ? (totalWon / totalBets * 100).toFixed(1) : '0';
        var pnlColor = totalPnl >= 0 ? '#4ade80' : '#f87171';
        var pnlSign = totalPnl >= 0 ? '+' : '-';
        document.getElementById('stats-summary').innerHTML =
            '<span style="color:var(--text-muted)" class="text-xs font-heading font-semibold uppercase tracking-wider">' + (timeRange === 'today' ? 'Today' : 'All Time') + '</span>' +
            '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--cyan)">' + overallRate + '%</span> <span class="text-xs" style="color:var(--text-muted)">strike rate</span></span>' +
            '<span class="text-sm"><span class="font-heading font-bold" style="color:var(--text-secondary)">' + totalWon + '/' + totalBets + '</span> <span class="text-xs" style="color:var(--text-muted)">winners</span></span>';

        // Render each category
        ['Selections', 'Exotics', 'Sequences', 'Multi'].forEach(function(cat) {
            var section = document.getElementById('stats-' + cat.toLowerCase());
            var gridEl = document.getElementById('grid-' + cat.toLowerCase());
            if (groups[cat].length > 0) {
                section.classList.remove('hidden');
                gridEl.innerHTML = groups[cat].map(renderCard).join('');
            } else {
                section.classList.add('hidden');
            }
        });
    }

    function fetchStats() {
        var loading = document.getElementById('stats-loading');
        var grid = document.getElementById('stats-grid');
        var empty = document.getElementById('stats-empty');

        loading.classList.remove('hidden');
        grid.classList.add('hidden');
        empty.classList.add('hidden');

        var fp = getFilterParams();
        var url = '/api/public/bet-type-stats';
        if (fp.params.toString()) url += '?' + fp.params.toString();

        // Update filter count badge
        var countEl = document.getElementById('filter-count');
        var clearEl = document.getElementById('btn-clear');
        if (fp.count > 0) {
            countEl.textContent = fp.count;
            countEl.style.display = '';
            clearEl.style.display = '';
        } else {
            countEl.style.display = 'none';
            clearEl.style.display = 'none';
        }

        updateChips();

        fetch(url)
            .then(function(r) { return r.json(); })
            .then(function(data) { renderStats(data, fp.hasRunnerFilter); })
            .catch(function() {
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            });
    }

    // Expose functions to global scope for onclick handlers
    window.applyFilters = function() {
        // Update URL without reload
        var fp = getFilterParams();
        var newUrl = '/stats';
        if (fp.params.toString()) newUrl += '?' + fp.params.toString();
        history.replaceState(null, '', newUrl);
        // Collapse filters after applying
        if (filtersOpen) { window.toggleFilters(); }
        fetchStats();
    };

    window.clearFilters = function() {
        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el) el.value = '';
        }
        timeRange = 'alltime';
        updateToggleUI();
        updateChips();
        history.replaceState(null, '', '/stats');
        fetchStats();
    };

    window.setTimeRange = function(range) {
        timeRange = range;
        updateToggleUI();
        // Clear date filters when switching to today
        if (range === 'today') {
            document.getElementById('f-date-from').value = '';
            document.getElementById('f-date-to').value = '';
        }
        fetchStats();
    };

    function updateToggleUI() {
        var btnToday = document.getElementById('btn-today');
        var btnAll = document.getElementById('btn-alltime');
        if (timeRange === 'today') {
            btnToday.style.background = 'var(--magenta)';
            btnToday.style.borderColor = 'var(--magenta)';
            btnToday.style.color = 'white';
            btnAll.style.background = 'var(--bg-card)';
            btnAll.style.borderColor = 'var(--border-subtle)';
            btnAll.style.color = 'var(--text-muted)';
        } else {
            btnAll.style.background = 'var(--magenta)';
            btnAll.style.borderColor = 'var(--magenta)';
            btnAll.style.color = 'white';
            btnToday.style.background = 'var(--bg-card)';
            btnToday.style.borderColor = 'var(--border-subtle)';
            btnToday.style.color = 'var(--text-muted)';
        }
    }

    // Load filter options for autocomplete
    function loadFilterOptions() {
        fetch('/api/public/filter-options')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                function fill(dlId, items) {
                    var dl = document.getElementById(dlId);
                    if (!dl) return;
                    items.forEach(function(v) {
                        var o = document.createElement('option');
                        o.value = v;
                        dl.appendChild(o);
                    });
                }
                fill('dl-venues', data.venues || []);
                fill('dl-jockeys', data.jockeys || []);
                fill('dl-trainers', data.trainers || []);
                fill('dl-classes', data.classes || []);

                // Populate track condition select
                var tcSelect = document.getElementById('f-track');
                (data.track_conditions || []).forEach(function(v) {
                    var o = document.createElement('option');
                    o.value = v;
                    o.textContent = v;
                    tcSelect.appendChild(o);
                });

                // Populate weather select
                var wSelect = document.getElementById('f-weather');
                (data.weather || []).forEach(function(v) {
                    var o = document.createElement('option');
                    o.value = v;
                    o.textContent = v;
                    wSelect.appendChild(o);
                });
            })
            .catch(function() {});
    }

    // Read initial filters from URL params
    function initFromUrl() {
        var params = new URLSearchParams(window.location.search);
        for (var id in FILTERS) {
            var val = params.get(FILTERS[id]);
            if (val) {
                var el = document.getElementById(id);
                if (el) el.value = val;
            }
        }
        if (params.get('today') === 'true') {
            timeRange = 'today';
            updateToggleUI();
        }
    }

    // Filter panel toggle
    var filtersOpen = false;
    window.toggleFilters = function() {
        filtersOpen = !filtersOpen;
        document.getElementById('filters-body').classList.toggle('hidden', !filtersOpen);
        document.getElementById('filters-chevron').style.transform = filtersOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        // Hide chips when open, show when closed + has filters
        updateChips();
    };

    // Filter chips (shown when filters panel is collapsed)
    var FILTER_LABELS = {
        'f-venue': 'Venue', 'f-state': 'State', 'f-track': 'Track',
        'f-weather': 'Weather', 'f-dist-min': 'Dist Min', 'f-dist-max': 'Dist Max',
        'f-class': 'Class', 'f-field-min': 'Field Min', 'f-field-max': 'Field Max',
        'f-jockey': 'Jockey', 'f-trainer': 'Trainer', 'f-sex': 'Sex',
        'f-barrier-min': 'Barrier', 'f-rank': 'Rank', 'f-odds-min': 'Odds Min',
        'f-odds-max': 'Odds Max', 'f-date-from': 'From', 'f-date-to': 'To'
    };

    function updateChips() {
        var chipsEl = document.getElementById('filter-chips');
        if (filtersOpen) { chipsEl.style.display = 'none'; return; }

        var chips = [];
        for (var id in FILTERS) {
            var el = document.getElementById(id);
            if (el && el.value) {
                var displayVal = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                chips.push('<span class="sf-chip">' + (FILTER_LABELS[id] || id) + ': ' + displayVal + '</span>');
            }
        }
        if (chips.length > 0) {
            chipsEl.innerHTML = chips.join('');
            chipsEl.style.display = 'flex';
        } else {
            chipsEl.style.display = 'none';
        }
    }

    // Allow Enter key to apply filters
    document.getElementById('filters-card').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            window.applyFilters();
        }
    });

    // Load tip rank strike rates (same data as homepage)
    function loadTipRankStats() {
        fetch('/api/public/stats')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                (data.pick_ranks || []).forEach(function(pr) {
                    var rateEl = document.getElementById('tr-rate-' + pr.rank);
                    var countEl = document.getElementById('tr-count-' + pr.rank);
                    var roiEl = document.getElementById('tr-roi-' + pr.rank);
                    if (rateEl) rateEl.textContent = pr.rate + '%';
                    if (countEl) countEl.textContent = pr.hits + '/' + pr.total;
                    if (roiEl && pr.roi !== undefined) {
                        var roiVal = pr.roi;
                        var roiColor = roiVal >= 0 ? '#4ade80' : '#f87171';
                        roiEl.style.color = roiColor;
                        roiEl.textContent = (roiVal >= 0 ? '+' : '') + roiVal.toFixed(1) + '% ROI';
                    }
                });
            })
            .catch(function() {});
    }

    // Init
    initFromUrl();
    loadFilterOptions();
    loadTipRankStats();
    fetchStats();

    // If URL has filters, open the panel
    var initParams = new URLSearchParams(window.location.search);
    var hasInitFilters = false;
    for (var _id in FILTERS) {
        if (initParams.get(FILTERS[_id])) { hasInitFilters = true; break; }
    }
    if (hasInitFilters) { window.toggleFilters(); }
})();
</script>
{% endblock %}
