{% extends "base.html" %}

{% block title %}PuntyAI - AI Horse Racing Tips That Don't Suck{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative overflow-hidden py-16 md:py-24">
    <!-- Background glow effects -->
    <div class="absolute top-1/2 left-1/4 w-96 h-96 bg-punty-magenta/20 rounded-full blur-3xl -translate-y-1/2"></div>
    <div class="absolute top-1/2 right-1/4 w-96 h-96 bg-punty-cyan/10 rounded-full blur-3xl -translate-y-1/2"></div>

    <div class="max-w-6xl mx-auto px-4 sm:px-8 relative">
        <div class="grid md:grid-cols-2 gap-12 items-center">
            <!-- Left: Content -->
            <div>
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-bold mb-6 leading-tight">
                    AI Racing Tips That
                    <span class="block" style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Don't Fuck Around</span>
                </h1>

                <div class="punty-quote mb-8">
                    <p class="text-lg italic" style="color: var(--text-secondary);">
                        "I'm Punty. I crunch the form, read the track, and find the bloody winners.
                        No tipster bullshit, no 'best bets' that cost you your rent money.
                        Just honest picks backed by AI smarts."
                    </p>
                </div>

                <div class="flex flex-wrap gap-4">
                    <a href="/tips" class="btn-primary inline-flex items-center gap-2">
                        See Today's Tips
                    </a>
                    <a href="/how-it-works" class="btn-secondary">
                        How It Works
                    </a>
                </div>
            </div>

            <!-- Right: Punty Character -->
            <div class="relative flex justify-center">
                <img src="/static/punty-character.jpg" alt="Punty the Racing Analyst"
                     class="w-72 md:w-96 rounded-2xl glow-magenta animate-pulse-glow">
            </div>
        </div>
    </div>
</section>

<!-- Today's Best Bet -->
<style>
    .bb-card {
        display: block; position: relative; overflow: hidden;
        border-radius: 16px; text-decoration: none; color: inherit;
        background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0a1628 100%);
        border: 2px solid rgba(255,0,128,0.35);
        transition: transform 0.2s, border-color 0.2s;
    }
    .bb-card:hover { transform: translateY(-2px); border-color: rgba(255,0,128,0.6); }
    .bb-glow-l { position: absolute; top: -80px; left: -80px; width: 240px; height: 240px; border-radius: 50%; filter: blur(60px); background: radial-gradient(circle, rgba(255,0,128,0.3), transparent 70%); pointer-events: none; }
    .bb-glow-r { position: absolute; bottom: -80px; right: -80px; width: 240px; height: 240px; border-radius: 50%; filter: blur(60px); background: radial-gradient(circle, rgba(0,212,255,0.2), transparent 70%); pointer-events: none; }
    .bb-inner { position: relative; padding: 24px 28px; display: flex; align-items: center; justify-content: space-between; gap: 24px; flex-wrap: wrap; }
    .bb-left { display: flex; align-items: center; gap: 16px; }
    .bb-trophy { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: var(--gradient-sunset); box-shadow: 0 0 24px rgba(255,0,128,0.4); flex-shrink: 0; }
    .bb-label { font-family: 'Orbitron', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 3px; color: var(--magenta); }
    .bb-horse { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 28px; line-height: 1.1; color: #fff; }
    .bb-meta { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
    .bb-meta-sep { margin: 0 6px; color: rgba(255,255,255,0.15); }
    .bb-right { display: flex; align-items: center; gap: 16px; }
    .bb-stat { text-align: center; padding: 0 12px; }
    .bb-stat-label { font-family: 'Rajdhani', sans-serif; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
    .bb-stat-val { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 24px; color: #fff; }
    .bb-arrow { font-size: 22px; color: var(--magenta); }
    .bb-returned .bb-stat-val { color: #4ade80; }
    .bb-roi-box { text-align: center; padding: 12px 20px; border-radius: 14px; background: linear-gradient(135deg, rgba(74,222,128,0.18), rgba(74,222,128,0.05)); border: 1px solid rgba(74,222,128,0.35); box-shadow: 0 0 20px rgba(74,222,128,0.12); }
    .bb-roi-label { font-family: 'Rajdhani', sans-serif; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #4ade80; }
    .bb-roi-val { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 30px; color: #4ade80; line-height: 1.1; }
    @media (max-width: 768px) {
        .bb-inner { padding: 20px; gap: 16px; }
        .bb-horse { font-size: 22px; }
        .bb-stat-val { font-size: 20px; }
        .bb-roi-val { font-size: 24px; }
        .bb-right { width: 100%; justify-content: space-between; }
    }
</style>
<section id="best-bet-section" {% if not stats.best_bet %}style="display: none;"{% endif %}>
    <div style="max-width: 72rem; margin: 0 auto; padding: 40px 16px 8px;">
        <a id="bb-venue-link" href="{% if stats.best_bet %}/tips/{{ stats.best_bet.meeting_id }}{% else %}#{% endif %}" class="bb-card">
            <div class="bb-glow-l"></div>
            <div class="bb-glow-r"></div>
            <div class="bb-inner">
                <div class="bb-left">
                    <div class="bb-trophy">&#x1F3C6;</div>
                    <div>
                        <div class="bb-label">Today's Best Bet</div>
                        <div class="bb-horse" id="bb-name">{% if stats.best_bet %}{{ stats.best_bet.display_name }}{% endif %}</div>
                        <div class="bb-meta">
                            <span id="bb-venue">{% if stats.best_bet %}{{ stats.best_bet.venue }}{% if stats.best_bet.race_number %} R{{ stats.best_bet.race_number }}{% endif %}{% endif %}</span>
                            <span class="bb-meta-sep">|</span>
                            <span id="bb-type">{% if stats.best_bet %}{{ stats.best_bet.bet_type }}{% endif %}</span>
                            <span id="bb-odds-inline">{% if stats.best_bet and stats.best_bet.odds %}<span class="bb-meta-sep">|</span>${{ "%.2f"|format(stats.best_bet.odds) }}{% endif %}</span>
                        </div>
                    </div>
                </div>
                <div class="bb-right">
                    <div class="bb-stat">
                        <div class="bb-stat-label">Staked</div>
                        <div class="bb-stat-val" id="bb-stake">{% if stats.best_bet %}${{ "%.0f"|format(stats.best_bet.stake) }}{% endif %}</div>
                    </div>
                    <div class="bb-arrow">&#x2192;</div>
                    <div class="bb-stat bb-returned">
                        <div class="bb-stat-label">Returned</div>
                        <div class="bb-stat-val" id="bb-returned">{% if stats.best_bet %}${{ "%.0f"|format(stats.best_bet.returned) }}{% endif %}</div>
                    </div>
                    <div class="bb-roi-box">
                        <div class="bb-roi-label">ROI</div>
                        <div class="bb-roi-val" id="bb-roi">{% if stats.best_bet %}+{{ stats.best_bet.roi }}%{% endif %}</div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</section>

<!-- Stats Section -->
<section class="py-16 border-y" style="border-color: var(--border-subtle); background: var(--bg-card);">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">
        <div class="grid md:grid-cols-3 gap-6 text-center">
            <!-- Meetings Today -->
            <div class="card p-6">
                <div class="stat-number" id="meetings-today">{{ stats.meetings_today }}</div>
                <div class="text-base font-heading font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Meetings Today</div>
                <!-- Next Race Countdown -->
                <div id="next-race-container" class="mt-3 pt-3" style="border-top: 1px solid var(--border-subtle); display: none;">
                    <div class="text-xs uppercase tracking-wider mb-1" style="color: var(--text-muted);">Next Up</div>
                    <div id="next-race-venue" class="text-sm font-semibold" style="color: var(--cyan);"></div>
                    <div id="next-race-countdown" class="text-lg font-display font-bold" style="color: var(--magenta);"></div>
                </div>
            </div>

            <!-- Today's Winners -->
            <div class="card p-6">
                <div class="stat-number" id="today-winners">{{ stats.today_winners }}</div>
                <div class="text-base font-heading font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);" id="today-winners-label">
                    {% if stats.all_races_complete %}Today's Winners{% else %}Today So Far{% endif %}
                </div>
            </div>

            <!-- All-Time Winners -->
            <div class="card p-6">
                <div class="stat-number" id="alltime-winners">{{ stats.alltime_winners }}</div>
                <div class="text-base font-heading font-semibold uppercase tracking-wider mt-2" style="color: var(--text-secondary);">Total Winners</div>
            </div>
        </div>

        <!-- Strike Rates by Pick -->
        {% if stats.pick_ranks and stats.pick_ranks[0].total > 0 %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6" id="strike-rates">
            {% for pr in stats.pick_ranks %}
            {% if pr.rank >= 1 %}
            <div class="rounded-xl p-4 text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                <div class="text-2xl font-display font-bold" style="color: {{ {'1': 'var(--magenta)', '2': 'var(--cyan)', '3': 'var(--yellow)', '4': 'var(--purple)'}[pr.rank|string] }};">
                    <span data-rank="{{ pr.rank }}" class="sr-rate">{{ pr.rate }}%</span>
                </div>
                <div class="text-xs font-heading font-semibold uppercase tracking-wider mt-1" style="color: var(--text-muted);">{{ pr.label }}</div>
                <div class="text-xs mt-1" style="color: var(--text-muted);"><span class="sr-detail" data-rank="{{ pr.rank }}">{{ pr.hits }}/{{ pr.total }}</span></div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Stats CTA -->
        <div class="text-center mt-8">
            <a href="/stats" class="btn-secondary inline-flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                View Punty's Full Stats
            </a>
        </div>

        <!-- Wins Ticker -->
        <div id="wins-ticker" class="mt-8 rounded-xl overflow-hidden" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
            <div class="flex items-center px-4 py-2" style="border-bottom: 1px solid var(--border-subtle);">
                <span class="text-lg mr-2" style="color: var(--magenta);">&#x1F3C6;</span>
                <span class="font-heading font-semibold text-sm uppercase tracking-wider" style="color: var(--text-muted);">Recent Wins</span>
            </div>
            <div class="ticker-container relative overflow-hidden" style="height: 52px;">
                <div id="ticker-content" class="ticker-scroll flex items-center gap-8 px-4 whitespace-nowrap" style="animation: ticker-scroll 30s linear infinite;">
                    <span class="text-sm" style="color: var(--text-muted);">Loading wins...</span>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    @keyframes ticker-scroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    .ticker-scroll:hover {
        animation-play-state: paused;
    }
    .win-item {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .win-celebration {
        font-family: 'Rajdhani', sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        background: var(--gradient-sunset);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .win-horse {
        color: #fff;
        font-weight: 600;
    }
    .win-venue {
        color: var(--text-muted);
        font-size: 0.85rem;
    }
    .win-amounts {
        font-family: 'Orbitron', sans-serif;
        font-size: 0.75rem;
    }
    .win-stake { color: var(--text-muted); }
    .win-return { color: #4ade80; }
</style>

<!-- Today's Tips Section -->
{% if stats.todays_tips %}
<section class="py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">
        <h2 class="text-3xl font-heading font-bold text-center mb-12">
            Today's <span style="color: var(--magenta);">Early Mail</span>
        </h2>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for tip in stats.todays_tips %}
            <a href="/tips/{{ tip.meeting_id }}"
               class="card p-6 hover:border-punty-magenta transition-all hover:-translate-y-1">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: var(--gradient-sunset);">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="font-heading font-bold text-lg">{{ tip.venue }}</div>
                        <div class="text-sm" style="color: var(--cyan);">View Tips →</div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <div class="text-center mt-8">
            <a href="/tips" class="btn-secondary inline-flex items-center gap-2">
                See All Tips
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- Video Section -->
<section class="py-16" style="background: var(--bg-card);">
    <div class="max-w-4xl mx-auto px-4 sm:px-8">
        <h2 class="text-3xl font-heading font-bold text-center mb-4">
            Meet <span style="color: var(--magenta);">Punty</span>
        </h2>
        <p class="text-center mb-8" style="color: var(--text-secondary);">
            Watch how Punty analyses the form and finds the winners
        </p>

        <!-- Intro Video with custom play button -->
        <div class="relative rounded-xl overflow-hidden glow-cyan mx-auto" style="max-width: 360px; aspect-ratio: 9/16; background: #0a0a0f;" id="video-container">
            <video
                id="punty-video"
                class="absolute inset-0 w-full h-full object-contain"
                playsinline
                poster="/static/punty-character.jpg">
                <source src="/static/punty-intro.mp4" type="video/mp4">
                <track kind="captions" src="/static/punty-intro-captions.vtt" srclang="en" label="English">
                Your browser does not support the video tag.
            </video>
            <!-- Custom play button overlay -->
            <div id="play-overlay" class="absolute inset-0 flex items-center justify-center cursor-pointer bg-black/30 hover:bg-black/20 transition-colors">
                <div class="w-20 h-20 rounded-full flex items-center justify-center" style="background: var(--magenta);">
                    <svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
(function() {
    const video = document.getElementById('punty-video');
    const overlay = document.getElementById('play-overlay');

    overlay.addEventListener('click', function() {
        overlay.style.display = 'none';
        video.controls = true;
        video.play();
    });

    video.addEventListener('pause', function() {
        if (video.currentTime > 0 && !video.ended) {
            overlay.style.display = 'flex';
            video.controls = false;
        }
    });

    video.addEventListener('ended', function() {
        overlay.style.display = 'flex';
        video.controls = false;
    });
})();
</script>

<!-- How It Works Preview -->
<section class="py-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">
        <h2 class="text-3xl font-heading font-bold text-center mb-12">
            How <span style="color: var(--cyan);">Punty</span> Picks Winners
        </h2>

        <div class="grid md:grid-cols-4 gap-8">
            <!-- Step 1 -->
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-2xl font-display font-bold" style="background: var(--gradient-sunset);">
                    1
                </div>
                <h3 class="font-heading font-bold text-xl mb-3">Crunch The Form</h3>
                <p style="color: var(--text-secondary);">
                    AI analyses thousands of data points - form, track conditions, barriers, jockeys, trainers, and more.
                </p>
            </div>

            <!-- Step 2 -->
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-2xl font-display font-bold" style="background: var(--gradient-sunset);">
                    2
                </div>
                <h3 class="font-heading font-bold text-xl mb-3">Read The Track</h3>
                <p style="color: var(--text-secondary);">
                    Speed maps, rail positions, weather conditions - all factored in to find where the winners will come from.
                </p>
            </div>

            <!-- Step 3 -->
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-2xl font-display font-bold" style="background: var(--gradient-sunset);">
                    3
                </div>
                <h3 class="font-heading font-bold text-xl mb-3">Find The Value</h3>
                <p style="color: var(--text-secondary);">
                    A 5-factor probability model calculates every runner's true win chance.
                    When our number beats the market — that's a value bet.
                    <a href="/how-it-works#step-2" class="font-semibold" style="color: var(--cyan);">See how it works</a>
                </p>
            </div>

            <!-- Step 4 -->
            <div class="text-center">
                <div class="w-16 h-16 mx-auto mb-6 rounded-full flex items-center justify-center text-2xl font-display font-bold" style="background: linear-gradient(135deg, var(--orange), var(--magenta));">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h3 class="font-heading font-bold text-xl mb-3">Live Updates</h3>
                <p style="color: var(--text-secondary);">
                    Punty watches every race live. Win celebrations, pace analysis, and real-time track reads throughout the day.
                </p>
            </div>
        </div>

        <div class="text-center mt-12">
            <a href="/how-it-works" class="btn-primary">
                Learn More
            </a>
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="py-20 relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-r from-punty-magenta/20 via-punty-purple/10 to-punty-cyan/20"></div>

    <div class="max-w-4xl mx-auto px-4 sm:px-8 text-center relative">
        <img src="/static/punty-character.jpg" alt="Punty"
             class="w-24 h-24 rounded-full mx-auto mb-6 object-cover border-4" style="border-color: var(--magenta);">

        <h2 class="text-3xl md:text-4xl font-heading font-bold mb-6">
            Ready to Stop Losing Your Arse?
        </h2>
        <p class="text-lg mb-8" style="color: var(--text-secondary);">
            Free daily tips and live race-day updates.
            No signup bullshit, no paywalls (yet). Just solid picks.
        </p>

        <div class="flex flex-wrap gap-4 justify-center">
            <a href="/tips" class="btn-primary inline-flex items-center gap-2 text-lg">
                Browse Tips
            </a>
            <a href="https://x.com/PuntyAI/" target="_blank" class="btn-secondary inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                Follow @PuntyAI
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Refresh stats every 60 seconds
    setInterval(function() {
        fetch('/api/public/stats')
            .then(r => r.json())
            .then(data => {
                document.getElementById('today-winners').textContent = data.today_winners;
                document.getElementById('today-winners-label').textContent = data.all_races_complete ? "Today's Winners" : 'Today So Far';
                document.getElementById('alltime-winners').textContent = data.alltime_winners;
                document.getElementById('meetings-today').textContent = data.meetings_today;
                // Update strike rates
                if (data.pick_ranks) {
                    data.pick_ranks.forEach(function(pr) {
                        var rateEl = document.querySelector('.sr-rate[data-rank="' + pr.rank + '"]');
                        var detailEl = document.querySelector('.sr-detail[data-rank="' + pr.rank + '"]');
                        if (rateEl) rateEl.textContent = pr.rate + '%';
                        if (detailEl) detailEl.textContent = pr.hits + '/' + pr.total;
                    });
                }
                // Update best bet
                var bbSection = document.getElementById('best-bet-section');
                if (data.best_bet) {
                    bbSection.style.display = '';
                    document.getElementById('bb-name').textContent = data.best_bet.display_name;
                    var venueText = data.best_bet.venue;
                    if (data.best_bet.race_number) venueText += ' R' + data.best_bet.race_number;
                    document.getElementById('bb-venue').textContent = venueText;
                    document.getElementById('bb-venue-link').href = '/tips/' + data.best_bet.meeting_id;
                    document.getElementById('bb-type').textContent = data.best_bet.bet_type;
                    var oddsInline = document.getElementById('bb-odds-inline');
                    if (data.best_bet.odds) {
                        oddsInline.innerHTML = '<span class="mx-1.5" style="color: var(--border-subtle);">|</span>$' + data.best_bet.odds.toFixed(2);
                    } else {
                        oddsInline.textContent = '';
                    }
                    document.getElementById('bb-stake').textContent = '$' + Math.round(data.best_bet.stake);
                    document.getElementById('bb-returned').textContent = '$' + Math.round(data.best_bet.returned);
                    document.getElementById('bb-roi').textContent = '+' + data.best_bet.roi + '%';
                } else {
                    bbSection.style.display = 'none';
                }
            })
            .catch(() => {});
    }, 60000);

    // Wins Ticker
    (function() {
        async function loadWinsTicker() {
            try {
                const resp = await fetch('/api/public/wins?limit=10');
                const data = await resp.json();
                const ticker = document.getElementById('ticker-content');

                if (!data.wins || data.wins.length === 0) {
                    ticker.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem; padding: 0 1rem;">No wins yet today - let\'s change that!</span>';
                    ticker.style.animation = 'none';
                    return;
                }

                // Build ticker items - duplicate for seamless loop
                let items = '';
                for (let i = 0; i < 2; i++) {
                    data.wins.forEach(function(win) {
                        items += '<div class="win-item">' +
                            '<span class="win-celebration">' + win.celebration + '</span>' +
                            '<span class="win-horse">' + win.display_name + '</span>' +
                            '<span class="win-venue">' + win.venue + '</span>' +
                            '<span class="win-amounts">' +
                                '<span class="win-stake">$' + win.stake.toFixed(0) + '</span>' +
                                ' → ' +
                                '<span class="win-return">$' + win.returned.toFixed(0) + '</span>' +
                            '</span>' +
                        '</div>';
                    });
                }
                ticker.innerHTML = items;

                // Adjust animation speed based on content width
                const totalWidth = ticker.scrollWidth / 2;
                const speed = Math.max(8, totalWidth / 240); // ~240px per second
                ticker.style.animation = 'ticker-scroll ' + speed + 's linear infinite';
            } catch (e) {
                console.error('Failed to load wins ticker:', e);
            }
        }

        loadWinsTicker();
        // Refresh ticker every 60 seconds
        setInterval(loadWinsTicker, 60000);
    })();

    // Next Race Countdown
    (function() {
        let nextRaceTime = null;
        let nextRaceVenue = '';
        let nextRaceNum = 0;

        function formatCountdown(ms) {
            if (ms <= 0) return 'NOW!';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return hours + 'h ' + minutes + 'm';
            } else if (minutes > 0) {
                return minutes + 'm ' + seconds + 's';
            } else {
                return seconds + 's';
            }
        }

        function updateCountdown() {
            const container = document.getElementById('next-race-container');
            const venueEl = document.getElementById('next-race-venue');
            const countdownEl = document.getElementById('next-race-countdown');

            if (!nextRaceTime) {
                container.style.display = 'none';
                return;
            }

            const now = new Date();
            const diff = nextRaceTime - now;

            if (diff <= -60000) {
                // Race started over a minute ago, fetch new data
                loadNextRace();
                return;
            }

            container.style.display = 'block';
            venueEl.textContent = nextRaceVenue + ' R' + nextRaceNum;
            countdownEl.textContent = formatCountdown(diff);
        }

        async function loadNextRace() {
            try {
                const resp = await fetch('/api/public/next-race');
                const data = await resp.json();

                if (data.has_next) {
                    nextRaceTime = new Date(data.start_time_iso);
                    nextRaceVenue = data.venue;
                    nextRaceNum = data.race_number;
                    updateCountdown();
                } else {
                    nextRaceTime = null;
                    document.getElementById('next-race-container').style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load next race:', e);
            }
        }

        loadNextRace();
        // Update countdown every second
        setInterval(updateCountdown, 1000);
        // Refresh race data every 2 minutes
        setInterval(loadNextRace, 120000);
    })();
</script>
{% endblock %}
