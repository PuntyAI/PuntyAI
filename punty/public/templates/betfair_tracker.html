{% extends "base.html" %}

{% block title %}Betfair Tracker — PuntyAI{% endblock %}

{% block head %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6" x-data="trackerApp()" x-init="init()">

    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold" style="font-family: 'Orbitron', sans-serif; background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                BETFAIR TRACKER
            </h1>
            <p class="text-sm mt-1" style="color: var(--text-muted);">
                Live bet tracking &amp; performance
            </p>
        </div>
        <div class="flex items-center gap-4">
            <!-- Balance Badge -->
            <div class="px-4 py-2 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-subtle);">
                <span class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Balance</span>
                <div class="text-xl font-bold" style="font-family: 'Orbitron', sans-serif; color: var(--cyan);">
                    $<span x-text="balance.toFixed(2)">0.00</span>
                </div>
            </div>
            <!-- Today P&L -->
            <div class="px-4 py-2 rounded-lg" style="background: var(--bg-card); border: 1px solid var(--border-subtle);">
                <span class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">Today P&L</span>
                <div class="text-xl font-bold" style="font-family: 'Orbitron', sans-serif;"
                     :style="{ color: todayPnl >= 0 ? '#00ff88' : '#ff4466' }">
                    <span x-text="(todayPnl >= 0 ? '+$' : '-$') + Math.abs(todayPnl).toFixed(2)">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <template x-for="stat in [
            { label: 'Total Bets', value: totalBets, fmt: 'int' },
            { label: 'Strike Rate', value: strikeRate, fmt: 'pct' },
            { label: 'Total P&L', value: totalPnl, fmt: 'pnl' },
            { label: 'ROI', value: roi, fmt: 'pct' },
            { label: 'Current Stake', value: currentStake, fmt: 'dollar' },
        ]">
            <div class="px-3 py-2 rounded-lg text-center" style="background: var(--bg-card); border: 1px solid var(--border-subtle);">
                <div class="text-xs uppercase tracking-wider" style="color: var(--text-muted);" x-text="stat.label"></div>
                <div class="text-lg font-bold mt-1" style="font-family: 'Rajdhani', sans-serif;"
                     :style="{ color: stat.fmt === 'pnl' ? (stat.value >= 0 ? '#00ff88' : '#ff4466') : 'var(--text-primary)' }">
                    <span x-show="stat.fmt === 'int'" x-text="stat.value"></span>
                    <span x-show="stat.fmt === 'pct'" x-text="stat.value.toFixed(1) + '%'"></span>
                    <span x-show="stat.fmt === 'pnl'" x-text="(stat.value >= 0 ? '+$' : '-$') + Math.abs(stat.value).toFixed(2)"></span>
                    <span x-show="stat.fmt === 'dollar'" x-text="'$' + stat.value.toFixed(2)"></span>
                </div>
            </div>
        </template>
    </div>

    <!-- Today's Bets Table -->
    <div class="rounded-xl overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-subtle);">
        <div class="px-4 py-3" style="border-bottom: 1px solid var(--border-subtle);">
            <h2 class="text-lg font-bold" style="font-family: 'Rajdhani', sans-serif;">Today's Bets</h2>
        </div>

        <template x-if="todayBets.length === 0">
            <div class="px-4 py-8 text-center" style="color: var(--text-muted);">
                No bets for today yet.
            </div>
        </template>

        <div class="overflow-x-auto">
            <table x-show="todayBets.length > 0" class="w-full text-sm">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border-subtle);">
                        <th class="px-4 py-2 text-left text-xs uppercase" style="color: var(--text-muted);">Race</th>
                        <th class="px-4 py-2 text-left text-xs uppercase" style="color: var(--text-muted);">Horse</th>
                        <th class="px-4 py-2 text-right text-xs uppercase" style="color: var(--text-muted);">Stake</th>
                        <th class="px-4 py-2 text-right text-xs uppercase" style="color: var(--text-muted);">Odds</th>
                        <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">Time</th>
                        <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">Status</th>
                        <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">P&L</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="bet in todayBets" :key="bet.id">
                        <tr style="border-bottom: 1px solid var(--border-subtle);"
                            :style="['cancelled','failed','lapsed'].includes(bet.status) ? 'opacity: 0.5;' : ''">
                            <td class="px-4 py-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-bold"
                                      :style="bet.settled
                                          ? (bet.hit ? 'background: rgba(0,255,136,0.2); color: #00ff88;' : 'background: rgba(255,68,102,0.2); color: #ff4466;')
                                          : 'background: var(--gradient-sunset); color: #fff;'">
                                    <span x-text="'R' + bet.race_number"></span>
                                </span>
                                <span class="ml-2 text-xs" style="color: var(--text-muted);" x-text="formatMeetingId(bet.meeting_id)"></span>
                            </td>
                            <td class="px-4 py-2 font-bold">
                                <span x-text="bet.horse_name"></span>
                                <span class="ml-1 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase"
                                      :style="(bet.bet_type || 'place') === 'win'
                                          ? 'background: rgba(255,170,0,0.2); color: #ffaa00; border: 1px solid rgba(255,170,0,0.3);'
                                          : 'background: rgba(0,212,255,0.15); color: var(--cyan); border: 1px solid rgba(0,212,255,0.2);'"
                                      x-text="(bet.bet_type || 'place').toUpperCase()"></span>
                            </td>
                            <td class="px-4 py-2 text-right" style="font-family: 'Rajdhani', sans-serif;">
                                $<span x-text="bet.stake.toFixed(2)"></span>
                            </td>
                            <td class="px-4 py-2 text-right" style="font-family: 'Rajdhani', sans-serif;">
                                <span x-text="bet.matched_odds ? '$' + bet.matched_odds.toFixed(2) : (bet.requested_odds ? '$' + bet.requested_odds.toFixed(2) : '—')"></span>
                            </td>
                            <td class="px-4 py-2 text-center text-xs" style="color: var(--text-muted);"
                                x-text="bet.scheduled_at ? new Date(bet.scheduled_at).toLocaleTimeString('en-AU', {hour:'2-digit', minute:'2-digit'}) : '—'">
                            </td>
                            <td class="px-4 py-2 text-center">
                                <template x-if="bet.settled">
                                    <span class="px-2 py-0.5 rounded-full text-xs font-bold"
                                          :style="bet.hit
                                              ? 'background: rgba(0,255,136,0.2); color: #00ff88; border: 1px solid rgba(0,255,136,0.3);'
                                              : 'background: rgba(255,68,102,0.2); color: #ff4466; border: 1px solid rgba(255,68,102,0.3);'"
                                          x-text="bet.hit ? 'WON' : 'LOST'">
                                    </span>
                                </template>
                                <template x-if="!bet.settled">
                                    <span class="px-2 py-0.5 rounded-full text-xs font-bold"
                                          :style="statusStyle(bet.status)" x-text="bet.status.toUpperCase()">
                                    </span>
                                </template>
                            </td>
                            <td class="px-4 py-2 text-center font-bold" style="font-family: 'Rajdhani', sans-serif;"
                                :style="{ color: bet.pnl > 0 ? '#00ff88' : bet.pnl < 0 ? '#ff4466' : 'var(--text-muted)' }">
                                <span x-text="bet.settled ? ((bet.pnl >= 0 ? '+$' : '-$') + Math.abs(bet.pnl).toFixed(2)) : '—'"></span>
                            </td>
                        </tr>
                    </template>
                    <!-- W/L tally row -->
                    <template x-if="todayBets.filter(b => b.settled).length > 0">
                        <tr style="border-top: 2px solid var(--border-subtle); background: rgba(255,255,255,0.02);">
                            <td colspan="7" class="px-4 py-2">
                                <span class="text-xs uppercase tracking-wider font-bold" style="color: var(--text-muted);">
                                    Results:
                                    <span style="color: #00ff88;" x-text="todayBets.filter(b => b.hit).length + 'W'"></span>
                                    / <span style="color: #ff4466;" x-text="todayBets.filter(b => b.settled && !b.hit).length + 'L'"></span>
                                    <span class="ml-1" :style="{ color: todayPnl >= 0 ? '#00ff88' : '#ff4466' }"
                                          x-text="'(' + (todayPnl >= 0 ? '+$' : '-$') + Math.abs(todayPnl).toFixed(2) + ')'"></span>
                                </span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bet History (collapsible) -->
    <div class="rounded-xl overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-subtle);">
        <div class="flex items-center justify-between px-4 py-3 cursor-pointer select-none"
             style="border-bottom: 1px solid var(--border-subtle);"
             @click="toggleHistory()">
            <h2 class="text-lg font-bold" style="font-family: 'Rajdhani', sans-serif;">
                <span x-text="showHistory ? '▼' : '▶'" class="mr-1"></span>
                BET HISTORY
                <span class="text-xs font-normal ml-2" style="color: var(--text-muted);"
                      x-show="historySummary.total" x-text="historySummary.total + ' bets'"></span>
            </h2>
            <span class="text-xs uppercase tracking-wider" style="color: var(--text-muted);">
                <span x-show="!showHistory">Click to expand</span>
                <span x-show="historyLoading" class="animate-pulse">Loading...</span>
            </span>
        </div>

        <div x-show="showHistory" x-transition>
            <!-- Filter bar -->
            <div class="flex flex-wrap items-center gap-3 px-4 py-3" style="border-bottom: 1px solid var(--border-subtle); background: rgba(255,255,255,0.02);">
                <div class="flex items-center gap-1.5">
                    <label class="text-xs uppercase" style="color: var(--text-muted);">Period</label>
                    <select x-model="historyFilters.days" @change="loadHistory()"
                            class="px-2 py-1 rounded text-xs"
                            style="background: var(--bg-card-alt); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                        <option value="0">All time</option>
                    </select>
                </div>
                <div class="flex items-center gap-1.5">
                    <label class="text-xs uppercase" style="color: var(--text-muted);">Status</label>
                    <select x-model="historyFilters.status" @change="loadHistory()"
                            class="px-2 py-1 rounded text-xs"
                            style="background: var(--bg-card-alt); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                        <option value="all">All</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="flex items-center gap-1.5">
                    <label class="text-xs uppercase" style="color: var(--text-muted);">Venue</label>
                    <input type="text" x-model="historyFilters.venue" placeholder="e.g. sale"
                           @keydown.enter="loadHistory()"
                           class="px-2 py-1 rounded text-xs w-28"
                           style="background: var(--bg-card-alt); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                </div>
                <button @click="loadHistory()" class="px-3 py-1 rounded text-xs font-bold"
                        style="background: rgba(0,212,255,0.15); color: var(--cyan); border: 1px solid rgba(0,212,255,0.3);">
                    Apply
                </button>
            </div>

            <!-- Summary cards -->
            <div x-show="historySummary.total !== undefined" class="grid grid-cols-2 md:grid-cols-5 gap-3 px-4 py-3">
                <template x-for="stat in [
                    { label: 'Total Bets', value: historySummary.total, fmt: 'int' },
                    { label: 'Strike Rate', value: historySummary.strike_rate, fmt: 'pct' },
                    { label: 'P&L', value: historySummary.pnl, fmt: 'pnl' },
                    { label: 'ROI', value: historySummary.roi, fmt: 'pct' },
                    { label: 'Avg Stake', value: historySummary.avg_stake, fmt: 'dollar' },
                ]">
                    <div class="px-3 py-2 rounded-lg text-center" style="background: var(--bg-card-alt); border: 1px solid var(--border-subtle);">
                        <div class="text-[10px] uppercase tracking-wider" style="color: var(--text-muted);" x-text="stat.label"></div>
                        <div class="text-base font-bold mt-0.5" style="font-family: 'Rajdhani', sans-serif;"
                             :style="{ color: stat.fmt === 'pnl' ? ((stat.value || 0) >= 0 ? '#00ff88' : '#ff4466') : 'var(--text-primary)' }">
                            <span x-show="stat.fmt === 'int'" x-text="stat.value || 0"></span>
                            <span x-show="stat.fmt === 'pct'" x-text="(stat.value || 0).toFixed(1) + '%'"></span>
                            <span x-show="stat.fmt === 'pnl'" x-text="((stat.value || 0) >= 0 ? '+$' : '-$') + Math.abs(stat.value || 0).toFixed(2)"></span>
                            <span x-show="stat.fmt === 'dollar'" x-text="'$' + (stat.value || 0).toFixed(2)"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- History table -->
            <div class="overflow-x-auto">
                <template x-if="historyBets.length === 0 && !historyLoading">
                    <div class="px-4 py-8 text-center" style="color: var(--text-muted);">
                        No settled bets in this period.
                    </div>
                </template>
                <table x-show="historyBets.length > 0" class="w-full text-sm">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-subtle);">
                            <th class="px-4 py-2 text-left text-xs uppercase" style="color: var(--text-muted);">Race</th>
                            <th class="px-4 py-2 text-left text-xs uppercase" style="color: var(--text-muted);">Horse</th>
                            <th class="px-4 py-2 text-right text-xs uppercase" style="color: var(--text-muted);">Stake</th>
                            <th class="px-4 py-2 text-right text-xs uppercase" style="color: var(--text-muted);">Odds</th>
                            <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">Date</th>
                            <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">Result</th>
                            <th class="px-4 py-2 text-center text-xs uppercase" style="color: var(--text-muted);">P&L</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="bet in historyBets" :key="bet.id">
                            <tr style="border-bottom: 1px solid var(--border-subtle);"
                                :style="bet.hit ? 'border-left: 3px solid #00ff88;' : 'border-left: 3px solid #ff4466;'">
                                <td class="px-4 py-2">
                                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold"
                                          :style="bet.hit
                                              ? 'background: rgba(0,255,136,0.2); color: #00ff88;'
                                              : 'background: rgba(255,68,102,0.2); color: #ff4466;'">
                                        <span x-text="'R' + bet.race_number"></span>
                                    </span>
                                    <span class="ml-2 text-xs" style="color: var(--text-muted);" x-text="formatMeetingId(bet.meeting_id)"></span>
                                </td>
                                <td class="px-4 py-2 font-bold">
                                    <span x-text="bet.horse_name"></span>
                                    <span class="ml-1 px-1.5 py-0.5 rounded text-[10px] font-bold uppercase"
                                          :style="(bet.bet_type || 'place') === 'win'
                                              ? 'background: rgba(255,170,0,0.2); color: #ffaa00; border: 1px solid rgba(255,170,0,0.3);'
                                              : 'background: rgba(0,212,255,0.15); color: var(--cyan); border: 1px solid rgba(0,212,255,0.2);'"
                                          x-text="(bet.bet_type || 'place').toUpperCase()"></span>
                                </td>
                                <td class="px-4 py-2 text-right" style="font-family: 'Rajdhani', sans-serif;">
                                    $<span x-text="bet.stake.toFixed(2)"></span>
                                </td>
                                <td class="px-4 py-2 text-right" style="font-family: 'Rajdhani', sans-serif;">
                                    <span x-text="bet.matched_odds ? '$' + bet.matched_odds.toFixed(2) : '—'"></span>
                                </td>
                                <td class="px-4 py-2 text-center text-xs" style="color: var(--text-muted);">
                                    <span x-text="bet.settled_at ? new Date(bet.settled_at).toLocaleDateString('en-AU', {day:'2-digit', month:'short'}) : '—'"></span>
                                </td>
                                <td class="px-4 py-2 text-center">
                                    <span class="px-2 py-0.5 rounded-full text-xs font-bold"
                                          :style="bet.hit
                                              ? 'background: rgba(0,255,136,0.2); color: #00ff88; border: 1px solid rgba(0,255,136,0.3);'
                                              : 'background: rgba(255,68,102,0.2); color: #ff4466; border: 1px solid rgba(255,68,102,0.3);'"
                                          x-text="bet.hit ? 'WON' : 'LOST'">
                                    </span>
                                </td>
                                <td class="px-4 py-2 text-center font-bold" style="font-family: 'Rajdhani', sans-serif;"
                                    :style="{ color: bet.pnl > 0 ? '#00ff88' : bet.pnl < 0 ? '#ff4466' : 'var(--text-muted)' }">
                                    <span x-text="(bet.pnl >= 0 ? '+$' : '-$') + Math.abs(bet.pnl || 0).toFixed(2)"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
function trackerApp() {
    return {
        balance: 0,
        initialBalance: 50,
        currentStake: 2,
        todayPnl: 0,
        todayBets: [],
        totalBets: 0,
        totalPnl: 0,
        strikeRate: 0,
        roi: 0,

        showHistory: false,
        historyBets: [],
        historyLoading: false,
        historyFilters: { days: 30, status: 'all', venue: '' },
        historySummary: {},

        async init() {
            await this.refresh();
            setInterval(() => this.refresh(), 30000);
        },

        async refresh() {
            try {
                const resp = await fetch('/api/betfair-tracker/queue');
                if (resp.status === 401) { window.location.reload(); return; }
                const data = await resp.json();
                this.balance = data.balance || 0;
                this.initialBalance = data.initial_balance || 50;
                this.currentStake = data.current_stake || 2;
                this.todayPnl = data.today_pnl || 0;
                this.todayBets = data.today_bets || [];
                this.totalBets = data.total_bets || 0;
                this.totalPnl = data.total_pnl || 0;
                this.strikeRate = data.strike_rate || 0;
                this.roi = data.roi || 0;
            } catch (e) { console.error('Failed to refresh:', e); }
        },

        async toggleHistory() {
            this.showHistory = !this.showHistory;
            if (this.showHistory && this.historyBets.length === 0) {
                await this.loadHistory();
            }
        },

        async loadHistory() {
            this.historyLoading = true;
            try {
                const params = new URLSearchParams();
                params.set('days', this.historyFilters.days);
                params.set('status', this.historyFilters.status);
                if (this.historyFilters.venue) params.set('venue', this.historyFilters.venue);
                const resp = await fetch(`/api/betfair-tracker/history?${params}`);
                if (resp.status === 401) { window.location.reload(); return; }
                const data = await resp.json();
                this.historyBets = data.bets || [];
                this.historySummary = data.summary || {};
            } catch (e) { console.error('Failed to load history:', e); }
            this.historyLoading = false;
        },

        formatMeetingId(id) {
            const parts = id.split('-');
            if (parts.length >= 4) {
                return parts.slice(0, -3).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }
            return id;
        },

        statusStyle(status) {
            const styles = {
                queued: 'background: rgba(0,212,255,0.15); color: #00d4ff;',
                placing: 'background: rgba(255,193,7,0.15); color: #ffc107;',
                placed: 'background: rgba(0,255,136,0.15); color: #00ff88;',
                settled: 'background: rgba(157,78,221,0.15); color: #9d4edd;',
                failed: 'background: rgba(255,68,102,0.15); color: #ff4466;',
                cancelled: 'background: rgba(128,128,144,0.15); color: #808090;',
                lapsed: 'background: rgba(128,128,144,0.15); color: #808090;',
            };
            return styles[status] || 'color: var(--text-muted);';
        },
    };
}
</script>
{% endblock %}
