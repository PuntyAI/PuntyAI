{% extends "base.html" %}

{% block title %}Punty's Racing Dashboard | PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="Today's racing dashboard. Live tips, next race countdown, results, and performance tracking. AI-powered horse racing tips.">
<style>
    /* ── Section Headings ── */
    .section-heading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    /* ── Countdown stability ── */
    .countdown-fixed {
        font-variant-numeric: tabular-nums;
        min-width: 10ch;
        display: inline-block;
    }

    /* ── State Badges ── */
    .state-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.6rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .state-vic { background: rgba(0, 70, 173, 0.2); color: #4a9eff; }
    .state-nsw { background: rgba(0, 170, 231, 0.2); color: #00d4ff; }
    .state-qld { background: rgba(128, 0, 0, 0.2); color: #ff6b6b; }
    .state-sa { background: rgba(255, 0, 0, 0.2); color: #ff8080; }
    .state-wa { background: rgba(255, 215, 0, 0.2); color: #ffc107; }
    .state-tas { background: rgba(0, 100, 0, 0.2); color: #66bb6a; }
    .state-act { background: rgba(0, 70, 173, 0.15); color: #7eb8ff; }
    .state-nt { background: rgba(196, 100, 0, 0.2); color: #ff9f43; }
    .state-aus { background: rgba(255,255,255,0.06); color: var(--text-muted); }
    .state-hk { background: rgba(222, 41, 16, 0.2); color: #ff6b6b; }

    /* ── PP Badge ── */
    .pp-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.35rem;
        border-radius: 4px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.55rem;
        font-weight: 800;
        letter-spacing: 0.05em;
        background: var(--gradient-sunset);
        color: white;
        line-height: 1.4;
    }

    /* ── Rank badges ── */
    .rank-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 22px; height: 22px; border-radius: 6px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.7rem;
    }
    .rank-1 { background: rgba(233, 30, 140, 0.2); color: var(--magenta); }
    .rank-2 { background: rgba(0, 212, 255, 0.2); color: var(--cyan); }
    .rank-3 { background: rgba(255, 193, 7, 0.2); color: var(--yellow); }
    .rank-4 { background: rgba(157, 78, 221, 0.2); color: var(--purple); }

    /* ── Type badges ── */
    .type-badge {
        display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem;
        font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .type-selection { background: rgba(233, 30, 140, 0.12); color: var(--magenta); }
    .type-exotic { background: rgba(0, 212, 255, 0.12); color: var(--cyan); }
    .type-sequence { background: rgba(255, 193, 7, 0.12); color: var(--yellow); }
    .type-big3_multi { background: rgba(157, 78, 221, 0.12); color: var(--purple); }

    /* ── Win cards ── */
    .win-card {
        background: var(--bg-card-alt);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 1rem 1.25rem;
        transition: transform 0.15s;
    }
    .win-card:hover { transform: translateY(-2px); }
    .win-card-hero {
        border-color: rgba(233, 30, 140, 0.4);
        box-shadow: 0 0 30px rgba(233, 30, 140, 0.15), inset 0 0 30px rgba(233, 30, 140, 0.03);
    }

    /* ── Product bar ── */
    .product-bar {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.6rem 0.75rem; border-radius: 10px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
    }

    /* ── Best of Meet slots ── */
    .bom-slot { padding: 0.35rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .bom-slot:last-child { border-bottom: none; }
    .bom-label {
        display: flex; align-items: center; gap: 0.35rem;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.25rem;
    }
    .bom-content { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }

    /* ── Performance strip ── */
    .perf-strip {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        scrollbar-width: none;
        padding-bottom: 0.25rem;
    }
    .perf-strip::-webkit-scrollbar { display: none; }
    .perf-chip {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        min-width: 100px;
        flex-shrink: 0;
        text-decoration: none;
        transition: border-color 0.15s;
    }
    .perf-chip:hover { border-color: rgba(233, 30, 140, 0.3); }
    .perf-chip-label {
        font-family: 'Rajdhani', sans-serif; font-size: 0.6rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted);
    }
    .perf-chip-value {
        font-family: 'Orbitron', sans-serif; font-size: 1.25rem; font-weight: 800;
        color: white; margin-top: 0.25rem;
    }

    /* ── Accordion ── */
    .dash-accordion-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 0.875rem 1.25rem; cursor: pointer; user-select: none;
        border-radius: 12px; border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02); transition: background 0.15s;
    }
    .dash-accordion-header:hover { background: rgba(255, 255, 255, 0.05); }

    /* ── Metro card highlight ── */
    .metro-card { border-color: rgba(233, 30, 140, 0.2); }

    /* ── Responsive ── */
    @media (max-width: 639px) {
        .perf-chip { min-width: 80px; padding: 0.5rem 0.75rem; }
        .perf-chip-value { font-size: 1rem; }
    }
</style>
{% endblock %}

{% block content %}
<section class="py-6">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">

        {# ── Header ── #}
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-display font-bold mb-1">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Racing Dashboard</span>
            </h1>
            <p class="text-sm" style="color: var(--text-secondary);">
                Your one-stop shop for today's tips, results, and performance.
            </p>
        </div>

        {# ════════════════════════════════════
           ZONE A: Live Edge Zone (HTMX 30s)
           ════════════════════════════════════ #}
        <div class="mb-6" id="live-edge"
             hx-get="/tips/_live-edge"
             hx-trigger="every 30s [document.visibilityState === 'visible']"
             hx-swap="innerHTML">
            {% include "partials/live_edge.html" %}
        </div>

        {# ════════════════════════════════════
           ZONE B: Today's Control Panel
           ════════════════════════════════════ #}

        {# Performance Strip #}
        {% set perf = dashboard.performance|default({}) %}
        <div class="perf-strip mb-4">
            <a href="/stats" class="perf-chip">
                <span class="perf-chip-label">Bets</span>
                <span class="perf-chip-value">{{ perf.total_bets|default(0) }}</span>
            </a>
            <a href="/stats" class="perf-chip">
                <span class="perf-chip-label">Winners</span>
                <span class="perf-chip-value" style="color: var(--cyan);">{{ perf.total_winners|default(0) }}</span>
            </a>
            <a href="/stats" class="perf-chip">
                <span class="perf-chip-label">Strike %</span>
                {% set sr = (perf.total_winners|default(0) / perf.total_bets * 100)|round(1) if perf.total_bets|default(0) > 0 else 0 %}
                <span class="perf-chip-value" style="color: var(--yellow);">{{ sr }}%</span>
            </a>
            <a href="/stats" class="perf-chip">
                <span class="perf-chip-label">P&L</span>
                {% set total_pnl = perf.total_pnl|default(0) %}
                <span class="perf-chip-value {% if total_pnl >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    {{ '%+.0f'|format(total_pnl) }}
                </span>
            </a>
            <a href="/stats" class="perf-chip">
                <span class="perf-chip-label">7-Day</span>
                <span class="perf-chip-value {% if seven_day_pnl >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                    {{ '%+.0f'|format(seven_day_pnl) }}
                </span>
            </a>
        </div>

        {# Today's Meetings #}
        <div class="mb-6">
            {% include "partials/meetings_grid.html" %}
        </div>

        {# ════════════════════════════════════
           ZONE C: Strategy & Depth (Accordions)
           ════════════════════════════════════ #}
        <div class="space-y-4 mb-6" x-data="{ openSection: 'best_of' }">

            {# Best Bet of Each Meet — default OPEN #}
            {% if best_of %}
            <div class="rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                <div class="dash-accordion-header" @click="openSection = openSection === 'best_of' ? '' : 'best_of'" style="border: none; border-radius: 12px 12px 0 0;">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--yellow);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                        <span class="font-heading font-bold text-white text-sm uppercase tracking-wider">Best Of Each Meet</span>
                    </div>
                    <svg class="w-5 h-5 transition-transform" :class="openSection === 'best_of' && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
                <div x-show="openSection === 'best_of'" x-collapse class="px-4 pb-4">
                    {% include "partials/best_of_meet.html" %}
                </div>
            </div>
            {% endif %}

            {# Sequence Bets — default CLOSED #}
            {% if sequences|default([])|length > 0 %}
            <div class="rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                <div class="dash-accordion-header" @click="openSection = openSection === 'sequences' ? '' : 'sequences'" style="border: none;">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--orange);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        <span class="font-heading font-bold text-white text-sm uppercase tracking-wider">Sequence Bets</span>
                        <span class="text-xs font-heading font-semibold px-2 py-0.5 rounded-full" style="background: rgba(255, 107, 53, 0.12); color: var(--orange);">{{ sequences|length }}</span>
                    </div>
                    <svg class="w-5 h-5 transition-transform" :class="openSection === 'sequences' && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
                <div x-show="openSection === 'sequences'" x-collapse class="px-4 pb-4">
                    {% include "partials/sequence_bets.html" %}
                </div>
            </div>
            {% endif %}

            {# Results & Wins — open if big_wins non-empty #}
            <div class="rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                <div class="dash-accordion-header"
                     @click="openSection = openSection === 'results' ? '' : 'results'"
                     x-init="{% if dashboard.big_wins|default([])|length > 0 %}openSection = 'results'{% endif %}"
                     style="border: none;">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-heading font-bold text-white text-sm uppercase tracking-wider">Results & Wins</span>
                        {% if dashboard.big_wins|default([])|length > 0 %}
                        <span class="text-xs font-heading font-semibold px-2 py-0.5 rounded-full" style="background: rgba(74, 222, 128, 0.12); color: #4ade80;">{{ dashboard.big_wins|length }}</span>
                        {% endif %}
                    </div>
                    <svg class="w-5 h-5 transition-transform" :class="openSection === 'results' && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
                <div x-show="openSection === 'results'" x-collapse>
                    <div class="px-4 pb-4" id="results-feed"
                         hx-get="/tips/_results-feed"
                         hx-trigger="every 120s [document.visibilityState === 'visible']"
                         hx-swap="innerHTML">
                        {% include "partials/results_feed.html" %}
                    </div>
                </div>
            </div>

            {# Performance Breakdown — default CLOSED #}
            <div class="rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                <div class="dash-accordion-header" @click="openSection = openSection === 'perf' ? '' : 'perf'" style="border: none;">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        <span class="font-heading font-bold text-white text-sm uppercase tracking-wider">Performance Breakdown</span>
                    </div>
                    <svg class="w-5 h-5 transition-transform" :class="openSection === 'perf' && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </div>
                <div x-show="openSection === 'perf'" x-collapse class="px-4 pb-4">
                    {% include "partials/performance_snapshot.html" %}
                </div>
            </div>
        </div>

        {# ── Quick Links Footer ── #}
        <div class="flex flex-wrap justify-center gap-3 py-6">
            <a href="/stats" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-heading font-semibold uppercase tracking-wider transition-all" style="color: var(--text-secondary); border: 1px solid var(--border-subtle);" onmouseover="this.style.color='white';this.style.borderColor='var(--magenta)'" onmouseout="this.style.color='var(--text-secondary)';this.style.borderColor='var(--border-subtle)'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                Full Scorecard
            </a>
            <a href="/tips/archive" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-heading font-semibold uppercase tracking-wider transition-all" style="color: var(--text-secondary); border: 1px solid var(--border-subtle);" onmouseover="this.style.color='white';this.style.borderColor='var(--cyan)'" onmouseout="this.style.color='var(--text-secondary)';this.style.borderColor='var(--border-subtle)'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                Tips Archive
            </a>
            <a href="/about" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-heading font-semibold uppercase tracking-wider transition-all" style="color: var(--text-secondary); border: 1px solid var(--border-subtle);" onmouseover="this.style.color='white';this.style.borderColor='var(--orange)'" onmouseout="this.style.color='var(--text-secondary)';this.style.borderColor='var(--border-subtle)'">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                About Punty
            </a>
        </div>

    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Countdown timer for next race / meetings
(function() {
    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    function updateCountdown(el) {
        var start = el.dataset.start;
        if (!start) return;
        var target = new Date(start).getTime();
        if (isNaN(target)) return;
        var now = Date.now();
        var diff = target - now;

        if (diff <= 0) {
            el.textContent = 'JUMPING';
            el.style.color = 'var(--magenta)';
            return;
        }

        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);

        if (h > 0) {
            el.textContent = h + 'h ' + pad(m) + 'm ' + pad(s) + 's';
        } else if (m > 0) {
            el.textContent = pad(m) + 'm ' + pad(s) + 's';
        } else {
            el.textContent = pad(s) + 's';
            el.style.color = 'var(--magenta)';
        }
    }

    function tickAll() {
        document.querySelectorAll('[data-start]').forEach(updateCountdown);
    }

    tickAll();
    setInterval(tickAll, 1000);

    // Re-init after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function() {
        tickAll();
    });
})();
</script>
{% endblock %}
