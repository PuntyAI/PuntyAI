{% extends "base.html" %}

{% block title %}Punty's Racing Dashboard | PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="Today's racing dashboard. Live tips, next race countdown, results, and performance tracking. AI-powered horse racing tips.">
<style>
    /* ── Dashboard Layout ── */
    .dash-container {
        max-width: 1320px;
        margin: 0 auto;
        padding: 0 1rem;
        overflow-x: hidden;
    }
    .dash-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
    }
    @media (min-width: 1024px) {
        .dash-grid {
            grid-template-columns: 65fr 35fr;
            gap: 1.5rem;
        }
        .dash-container { padding: 0 1.5rem; }
    }
    .dash-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    @media (min-width: 1024px) {
        .dash-sidebar {
            position: sticky;
            top: 5rem;
            align-self: start;
        }
    }

    /* ── Section Headings ── */
    .section-heading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.95rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }

    /* ── Countdown stability ── */
    .countdown-fixed {
        font-variant-numeric: tabular-nums;
        min-width: 10ch;
        display: inline-block;
    }

    /* ── State Badges ── */
    .state-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.6rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .state-vic { background: rgba(0, 70, 173, 0.2); color: #4a9eff; }
    .state-nsw { background: rgba(0, 170, 231, 0.2); color: #00d4ff; }
    .state-qld { background: rgba(128, 0, 0, 0.2); color: #ff6b6b; }
    .state-sa { background: rgba(255, 0, 0, 0.2); color: #ff8080; }
    .state-wa { background: rgba(255, 215, 0, 0.2); color: #ffc107; }
    .state-tas { background: rgba(0, 100, 0, 0.2); color: #66bb6a; }
    .state-act { background: rgba(0, 70, 173, 0.15); color: #7eb8ff; }
    .state-nt { background: rgba(196, 100, 0, 0.2); color: #ff9f43; }
    .state-aus { background: rgba(255,255,255,0.06); color: var(--text-muted); }
    .state-hk { background: rgba(222, 41, 16, 0.2); color: #ff6b6b; }

    /* ── PP Badge ── */
    .pp-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.35rem;
        border-radius: 4px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.55rem;
        font-weight: 800;
        letter-spacing: 0.05em;
        background: var(--gradient-sunset);
        color: white;
        line-height: 1.4;
    }

    /* ── Rank badges ── */
    .rank-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 22px; height: 22px; border-radius: 6px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.7rem;
    }
    .rank-1 { background: rgba(233, 30, 140, 0.2); color: var(--magenta); }
    .rank-2 { background: rgba(0, 212, 255, 0.2); color: var(--cyan); }
    .rank-3 { background: rgba(255, 193, 7, 0.2); color: var(--yellow); }
    .rank-4 { background: rgba(157, 78, 221, 0.2); color: var(--purple); }

    /* ── Type badges ── */
    .type-badge {
        display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem;
        font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .type-selection { background: rgba(233, 30, 140, 0.12); color: var(--magenta); }
    .type-exotic { background: rgba(0, 212, 255, 0.12); color: var(--cyan); }
    .type-sequence { background: rgba(255, 193, 7, 0.12); color: var(--yellow); }
    .type-big3_multi { background: rgba(157, 78, 221, 0.12); color: var(--purple); }

    /* ── Win cards ── */
    .win-card {
        background: var(--bg-card-alt);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        transition: transform 0.15s;
        border-left: 3px solid transparent;
    }
    .win-card:hover { transform: translateY(-1px); }
    .win-card-hero {
        border-left-color: #4ade80;
        box-shadow: 0 0 20px rgba(74, 222, 128, 0.08);
    }
    .win-card-loss {
        border-left-color: #ef4444;
    }

    /* ── Product bar ── */
    .product-bar {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.5rem 0.75rem; border-radius: 8px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
    }

    /* ── Best of Meet slots ── */
    .bom-slot { padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .bom-slot:last-child { border-bottom: none; }
    .bom-label {
        display: flex; align-items: center; gap: 0.35rem;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.15rem;
    }
    .bom-content { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }

    /* ── Metrics Card Group ── */
    .metrics-row {
        display: flex;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        overflow: hidden;
    }
    .metric-cell {
        flex: 1;
        padding: 0.75rem 0.5rem;
        text-align: center;
        text-decoration: none;
        transition: background 0.15s;
        position: relative;
    }
    .metric-cell:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 20%;
        height: 60%;
        width: 1px;
        background: var(--border-subtle);
    }
    .metric-cell:hover { background: rgba(255,255,255,0.03); }
    .metric-label {
        font-family: 'Rajdhani', sans-serif; font-size: 0.6rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted);
    }
    .metric-value {
        font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 800;
        color: white; margin-top: 0.15rem; line-height: 1.2;
    }

    /* ── Accordion ── */
    .dash-accordion-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 0.625rem 1rem; cursor: pointer; user-select: none;
        border-radius: 10px; border: 1px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02); transition: background 0.15s;
    }
    .dash-accordion-header:hover { background: rgba(255, 255, 255, 0.05); }

    /* ── Metro card highlight ── */
    .metro-card { border-color: rgba(233, 30, 140, 0.2); }

    /* ── Sidebar panel ── */
    .sidebar-panel {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 1rem;
    }
    .sidebar-panel-title {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }

    /* ── Quick link buttons ── */
    .qlink {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.5rem 0.75rem; border-radius: 8px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.8rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.04em;
        color: var(--text-secondary); text-decoration: none;
        border: 1px solid var(--border-subtle);
        transition: all 0.15s;
    }
    .qlink:hover { color: white; border-color: rgba(233,30,140,0.3); background: rgba(255,255,255,0.03); }

    /* ── Compact stat grid for sidebar ── */
    .stat-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    .stat-cell {
        padding: 0.5rem;
        border-radius: 8px;
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.04);
        text-align: center;
    }
    .stat-cell-label {
        font-family: 'Rajdhani', sans-serif; font-size: 0.6rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted);
    }
    .stat-cell-value {
        font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 800;
        color: white; margin-top: 0.1rem;
    }

    /* ── Timer pulse ── */
    @keyframes timer-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    .timer-urgent { animation: timer-pulse 1s ease-in-out infinite; }

    /* ── Responsive ── */
    @media (max-width: 1023px) {
        .dash-grid > div { display: contents; }
        .dash-accordions { display: contents !important; }
        #live-edge { order: 1; }
        .dash-sidebar-timer { order: 2; }
        .dash-metrics { order: 3; }
        .dash-meetings { order: 4; }
        .dash-accordion-bestof { order: 5; }
        .dash-accordion-sequences { order: 6; }
        .dash-sidebar-performance { order: 7; }
        .dash-sidebar-bettype { order: 8; }
        .dash-sidebar-tiprank { order: 9; }
        .dash-accordion-results { order: 10; }
        .dash-sidebar-links { order: 11; }
        .metric-value { font-size: 1.1rem; }
    }
    @media (max-width: 639px) {
        .metric-cell { padding: 0.5rem 0.25rem; }
        .metric-value { font-size: 0.85rem; }
        .metric-label { font-size: 0.55rem; }
        .metrics-row { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .countdown-fixed { min-width: 6ch; }
    }
</style>
{% endblock %}

{% block content %}
<section style="padding: 1rem 0 2rem;">
    <div class="dash-container">

        {# ── Header (compact) ── #}
        <div class="flex items-center justify-between" style="margin-bottom: 1rem;">
            <h1 class="font-display font-bold" style="font-size: 1.5rem;">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Racing Dashboard</span>
            </h1>
            <span class="text-xs" style="color: var(--text-muted);">Your one-stop shop for today's tips, results, and performance.</span>
        </div>

        {# ════════════════════════════════════
           2-COLUMN GRID LAYOUT
           ════════════════════════════════════ #}
        <div class="dash-grid" x-data="{
            open: { best_of: true, sequences: false, results: {{ 'true' if dashboard.big_wins|default([])|length > 0 else 'false' }}, performance: false },
            hiddenVenues: [],
            meetings: {{ meetings_list|default([])|tojson }},
            primaryNextVenue: '{{ next_race.venue|default("") }}',
            fallbackMeeting: null,
            toggleVenue(v) {
                var i = this.hiddenVenues.indexOf(v);
                if (i > -1) this.hiddenVenues.splice(i, 1);
                else this.hiddenVenues.push(v);
                this._refreshFallback();
            },
            isActive(v) { return this.hiddenVenues.indexOf(v) === -1; },
            _refreshFallback() {
                if (this.isActive(this.primaryNextVenue)) { this.fallbackMeeting = null; return; }
                var now = Date.now();
                var best = null;
                for (var i = 0; i < this.meetings.length; i++) {
                    var m = this.meetings[i];
                    if (!m.next_jump || !this.isActive(m.venue)) continue;
                    if (m.venue === this.primaryNextVenue) continue;
                    var t = new Date(m.next_jump).getTime();
                    if (t > now && (!best || t < best._t)) { best = { venue: m.venue, meeting_id: m.meeting_id, race_num: m.next_race_num, jump: m.next_jump, _t: t }; }
                }
                this.fallbackMeeting = best;
            }
        }">

            {# ═══════ LEFT COLUMN (65%) ═══════ #}
            <div style="display: flex; flex-direction: column; gap: 1rem;">

                {# ── Live Edge Zone ── #}
                <div id="live-edge"
                     hx-get="/tips/_live-edge"
                     hx-trigger="every 30s [document.visibilityState === 'visible']"
                     hx-swap="innerHTML">
                    {% include "partials/live_edge.html" %}
                </div>

                {# ── Fallback Next Up (shown when primary venue is filtered out) ── #}
                <div class="card p-4 text-center" style="border-color: var(--border-subtle); display: none;"
                     x-show="fallbackMeeting" x-transition x-cloak>
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-heading font-bold uppercase tracking-wider"
                              style="background: linear-gradient(135deg, rgba(233, 30, 140, 0.2), rgba(255, 107, 53, 0.15)); color: var(--magenta); border: 1px solid rgba(233, 30, 140, 0.35);">
                            <span style="width: 7px; height: 7px; border-radius: 50%; background: var(--magenta); display: inline-block; animation: live-dot 1.5s ease-in-out infinite;"></span>
                            Next Up
                        </span>
                    </div>
                    <a :href="fallbackMeeting ? '/tips/' + fallbackMeeting.meeting_id + '#race-' + fallbackMeeting.race_num : '#'"
                       class="hover:opacity-80 transition-opacity" style="text-decoration: none;">
                        <p class="font-heading font-semibold text-white mb-1" x-text="fallbackMeeting ? fallbackMeeting.venue + ' — R' + fallbackMeeting.race_num : ''"></p>
                        <p class="text-sm" style="color: var(--text-secondary);">
                            <span class="countdown-fixed font-heading font-bold" style="color: var(--magenta);" x-bind:data-start="fallbackMeeting ? fallbackMeeting.jump : ''">--:--</span>
                            until jump
                        </p>
                    </a>
                </div>

                {# ── Metrics Row ── #}
                {% set perf = dashboard.performance|default({}) %}
                <div class="metrics-row dash-metrics">
                    <a href="/stats" class="metric-cell">
                        <div class="metric-label">Bets</div>
                        <div class="metric-value">{{ perf.total_bets|default(0) }}</div>
                    </a>
                    <a href="/stats" class="metric-cell">
                        <div class="metric-label">Winners</div>
                        <div class="metric-value" style="color: var(--cyan);">{{ perf.total_winners|default(0) }}</div>
                    </a>
                    <a href="/stats" class="metric-cell">
                        <div class="metric-label">Strike %</div>
                        {% set sr = (perf.total_winners|default(0) / perf.total_bets * 100)|round(1) if perf.total_bets|default(0) > 0 else 0 %}
                        <div class="metric-value" style="color: var(--yellow);">{{ sr }}%</div>
                    </a>
                    <a href="/stats" class="metric-cell">
                        <div class="metric-label">P&L</div>
                        {% set total_pnl = perf.total_pnl|default(0) %}
                        <div class="metric-value" style="color: {{ '#4ade80' if total_pnl >= 0 else '#ef4444' }}; font-size: 1.6rem;">
                            {{ '%+.0f'|format(total_pnl) | replace('+', '+$') | replace('-', '-$') }}
                        </div>
                    </a>
                    <a href="/stats" class="metric-cell">
                        <div class="metric-label">7-Day</div>
                        <div class="metric-value" style="color: {{ '#4ade80' if seven_day_pnl >= 0 else '#ef4444' }};">
                            {{ '%+.0f'|format(seven_day_pnl) | replace('+', '+$') | replace('-', '-$') }}
                        </div>
                    </a>
                </div>

                {# ── Today's Meetings ── #}
                <div class="dash-meetings">
                    {% include "partials/meetings_grid.html" %}
                </div>

                {# ═══════ ACCORDIONS ═══════ #}
                <div class="dash-accordions" style="display: flex; flex-direction: column; gap: 0.75rem;">

                    {# Best Bet of Each Meet — default OPEN #}
                    {% if best_of %}
                    <div class="dash-accordion-bestof rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                        <div class="dash-accordion-header" @click="open.best_of = !open.best_of" style="border: none; border-radius: 10px 10px 0 0;">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: var(--yellow);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                <span class="font-heading font-bold text-white text-xs uppercase tracking-wider">Best Of Each Meet</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="open.best_of && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <div x-show="open.best_of" x-collapse class="px-3 pb-3">
                            {% with hide_heading=true %}{% include "partials/best_of_meet.html" %}{% endwith %}
                        </div>
                    </div>
                    {% endif %}

                    {# Sequence Bets — default CLOSED #}
                    {% if sequences|default([])|length > 0 %}
                    <div class="dash-accordion-sequences rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                        <div class="dash-accordion-header" @click="open.sequences = !open.sequences" style="border: none;">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: var(--orange);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                                <span class="font-heading font-bold text-white text-xs uppercase tracking-wider">Sequence Bets</span>
                                <span class="text-xs font-heading font-semibold px-2 py-0.5 rounded-full" style="background: rgba(255, 107, 53, 0.12); color: var(--orange);">{{ sequences|length }}</span>
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="open.sequences && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <div x-show="open.sequences" x-collapse class="px-3 pb-3">
                            {% with hide_heading=true %}{% include "partials/sequence_bets.html" %}{% endwith %}
                        </div>
                    </div>
                    {% endif %}

                    {# Results & Wins — open if big_wins non-empty #}
                    <div class="dash-accordion-results rounded-xl overflow-hidden" style="border: 1px solid var(--border-subtle);">
                        <div class="dash-accordion-header"
                             @click="open.results = !open.results"
                             style="border: none;">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="font-heading font-bold text-white text-xs uppercase tracking-wider">Results & Wins</span>
                                {% if dashboard.big_wins|default([])|length > 0 %}
                                <span class="text-xs font-heading font-semibold px-2 py-0.5 rounded-full" style="background: rgba(74, 222, 128, 0.12); color: #4ade80;">{{ dashboard.big_wins|length }}</span>
                                {% endif %}
                            </div>
                            <svg class="w-4 h-4 transition-transform" :class="open.results && 'rotate-180'" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <div x-show="open.results" x-collapse>
                            <div class="px-3 pb-3" id="results-feed"
                                 hx-get="/tips/_results-feed"
                                 hx-trigger="every 120s [document.visibilityState === 'visible']"
                                 hx-swap="innerHTML">
                                {% with hide_heading=true %}{% include "partials/results_feed.html" %}{% endwith %}
                            </div>
                        </div>
                    </div>

                </div>{# end accordions #}
            </div>{# end left column #}

            {# ═══════ RIGHT COLUMN (35%) — Sidebar ═══════ #}
            <div class="dash-sidebar">

                {# ── Next Race Timer ── #}
                {% if next_race and next_race.has_next %}
                {# Primary: show when next_race venue is active #}
                <div class="sidebar-panel dash-sidebar-timer" style="text-align: center;" x-show="isActive('{{ next_race.venue }}')" x-transition>
                    <div class="sidebar-panel-title">Next Jump</div>
                    <a href="/tips/{{ next_race.meeting_id }}#race-{{ next_race.race_number }}" style="text-decoration: none; display: block;" class="hover:opacity-80 transition-opacity">
                        <div class="countdown-fixed font-display font-bold" style="font-size: 1.75rem; color: var(--magenta);" data-start="{{ next_race.start_time_iso }}" id="sidebar-timer">--:--</div>
                        <div class="text-xs" style="color: var(--text-muted); margin-top: 0.25rem;">
                            {{ next_race.venue }} &mdash; R{{ next_race.race_number }}
                            {% if next_race.distance %} &middot; {{ next_race.distance }}m{% endif %}
                        </div>
                    </a>
                </div>
                {# Fallback: show next visible meeting when primary is filtered #}
                <div class="sidebar-panel dash-sidebar-timer" style="text-align: center; display: none;"
                     x-show="fallbackMeeting" x-transition x-cloak>
                    <div class="sidebar-panel-title">Next Jump</div>
                    <a :href="fallbackMeeting ? '/tips/' + fallbackMeeting.meeting_id + '#race-' + fallbackMeeting.race_num : '#'" style="text-decoration: none; display: block;" class="hover:opacity-80 transition-opacity">
                        <div class="countdown-fixed font-display font-bold" style="font-size: 1.75rem; color: var(--magenta);" x-bind:data-start="fallbackMeeting ? fallbackMeeting.jump : ''">--:--</div>
                        <div class="text-xs" style="color: var(--text-muted); margin-top: 0.25rem;" x-text="fallbackMeeting ? fallbackMeeting.venue + ' — R' + fallbackMeeting.race_num : ''"></div>
                    </a>
                </div>
                {% endif %}

                {# ── Performance Snapshot (compact 2x2 grid) ── #}
                {% set perf = dashboard.performance|default({}) %}
                <div class="sidebar-panel dash-sidebar-performance">
                    <div class="sidebar-panel-title">Performance</div>
                    <div class="stat-grid">
                        <div class="stat-cell">
                            <div class="stat-cell-label">Bets</div>
                            <div class="stat-cell-value">{{ perf.total_bets|default(0) }}</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-cell-label">Winners</div>
                            <div class="stat-cell-value" style="color: var(--cyan);">{{ perf.total_winners|default(0) }}</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-cell-label">Strike</div>
                            {% set sr2 = (perf.total_winners|default(0) / perf.total_bets * 100)|round(1) if perf.total_bets|default(0) > 0 else 0 %}
                            <div class="stat-cell-value" style="color: var(--yellow);">{{ sr2 }}%</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-cell-label">P&L</div>
                            {% set tp2 = perf.total_pnl|default(0) %}
                            <div class="stat-cell-value" style="color: {{ '#4ade80' if tp2 >= 0 else '#ef4444' }};">
                                {{ '%+.0f'|format(tp2) | replace('+', '+$') | replace('-', '-$') }}
                            </div>
                        </div>
                    </div>
                </div>

                {# ── By Bet Type (compact) ── #}
                {% set bt = dashboard.bet_types|default([]) %}
                {% if bt %}
                <div class="sidebar-panel dash-sidebar-bettype">
                    <div class="sidebar-panel-title">By Bet Type</div>
                    <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                        {% for b in bt %}
                        <div class="product-bar" style="padding: 0.4rem 0.6rem;">
                            <span class="font-heading font-semibold text-xs text-white flex-1">{{ b.name }}</span>
                            <span class="text-xs" style="color: var(--text-muted);">{{ b.winners }}/{{ b.bets }}</span>
                            <span class="font-heading font-bold text-xs {% if b.pnl >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                                {{ '+' if b.pnl >= 0 }}${{ '%.0f'|format(b.pnl) }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# ── Tip Rank Rates ── #}
                {% set ranks = stats.pick_ranks|default([]) %}
                {% if ranks %}
                <div class="sidebar-panel dash-sidebar-tiprank">
                    <div class="sidebar-panel-title">By Tip Rank</div>
                    <div class="stat-grid">
                        {% for r in ranks %}
                        <div class="stat-cell" style="display: flex; align-items: center; gap: 0.5rem; text-align: left; padding: 0.4rem 0.5rem;">
                            <span class="rank-badge rank-{{ r.rank }}" style="width: 20px; height: 20px; font-size: 0.65rem;">{{ r.rank }}</span>
                            <div>
                                <div class="font-heading font-bold text-white text-sm">{{ r.rate }}%</div>
                                <div class="text-xs" style="color: var(--text-muted);">{{ r.hits }}/{{ r.total }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# ── Quick Links ── #}
                <div class="dash-sidebar-links" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="/stats" class="qlink">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        Full Scorecard
                    </a>
                    <a href="/tips/archive" class="qlink">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        Tips Archive
                    </a>
                    <a href="/about" class="qlink">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        About Punty
                    </a>
                </div>

            </div>{# end right column #}

        </div>{# end dash-grid #}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Countdown timer for next race / meetings
(function() {
    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    function updateCountdown(el) {
        var start = el.dataset.start;
        if (!start) return;
        var target = new Date(start).getTime();
        if (isNaN(target)) return;
        var now = Date.now();
        var diff = target - now;

        if (diff <= 0) {
            el.textContent = 'JUMPING';
            el.style.color = 'var(--magenta)';
            return;
        }

        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);

        if (h > 0) {
            el.textContent = h + 'h ' + pad(m) + 'm ' + pad(s) + 's';
        } else if (m > 0) {
            el.textContent = pad(m) + 'm ' + pad(s) + 's';
        } else {
            el.textContent = pad(s) + 's';
            el.style.color = 'var(--magenta)';
        }

        // Pulse effect when under 5 minutes
        if (diff < 300000 && el.id === 'sidebar-timer') {
            el.classList.add('timer-urgent');
        } else if (el.id === 'sidebar-timer') {
            el.classList.remove('timer-urgent');
        }
    }

    function tickAll() {
        document.querySelectorAll('[data-start]').forEach(updateCountdown);
    }

    tickAll();
    setInterval(tickAll, 1000);

    // Re-init after HTMX swaps
    document.body.addEventListener('htmx:afterSwap', function() {
        tickAll();
    });
})();
</script>
{% endblock %}
