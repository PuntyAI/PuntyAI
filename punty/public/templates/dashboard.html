{% extends "base.html" %}

{% block title %}Punty's Racing Dashboard | PuntyAI{% endblock %}

{% block head %}
<meta name="description" content="Today's racing dashboard. Live tips, next race countdown, results, and performance tracking. AI-powered horse racing tips.">
<style>
    /* ── Glance Strip ── */
    .glance-strip {
        background: rgba(10, 10, 15, 0.92);
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    .glance-inner {
        max-width: 72rem;
        margin: 0 auto;
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .glance-inner::-webkit-scrollbar { display: none; }
    .glance-chip {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        white-space: nowrap;
        flex-shrink: 0;
    }
    .glance-chip-accent {
        border-color: rgba(233, 30, 140, 0.3);
        background: rgba(233, 30, 140, 0.08);
    }
    .glance-label {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
    }
    .glance-value {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
    }
    .glance-links {
        display: flex;
        gap: 0.375rem;
        margin-left: auto;
        flex-shrink: 0;
    }
    .glance-link {
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--cyan);
        padding: 0.25rem 0.6rem;
        border-radius: 6px;
        border: 1px solid rgba(0, 212, 255, 0.2);
        transition: all 0.15s;
        text-decoration: none;
        white-space: nowrap;
    }
    .glance-link:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.4);
    }

    /* ── Section Headings ── */
    .section-heading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: 'Rajdhani', sans-serif;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    /* ── Countdown stability ── */
    .countdown-fixed {
        font-variant-numeric: tabular-nums;
        min-width: 10ch;
        display: inline-block;
    }

    /* ── Next Race Hero ── */
    .next-race-hero {
        position: relative;
    }
    .next-race-glow {
        position: absolute;
        inset: 0;
        background: radial-gradient(ellipse 50% 80% at 10% 50%, rgba(233, 30, 140, 0.08) 0%, transparent 70%);
        pointer-events: none;
        border-radius: 14px;
    }

    /* ── State Badges ── */
    .state-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.6rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .state-vic { background: rgba(0, 70, 173, 0.2); color: #4a9eff; }
    .state-nsw { background: rgba(0, 170, 231, 0.2); color: #00d4ff; }
    .state-qld { background: rgba(128, 0, 0, 0.2); color: #ff6b6b; }
    .state-sa { background: rgba(255, 0, 0, 0.2); color: #ff8080; }
    .state-wa { background: rgba(255, 215, 0, 0.2); color: #ffc107; }
    .state-tas { background: rgba(0, 100, 0, 0.2); color: #66bb6a; }
    .state-act { background: rgba(0, 70, 173, 0.15); color: #7eb8ff; }
    .state-nt { background: rgba(196, 100, 0, 0.2); color: #ff9f43; }
    .state-aus { background: rgba(255,255,255,0.06); color: var(--text-muted); }
    .state-hk { background: rgba(222, 41, 16, 0.2); color: #ff6b6b; }

    /* ── PP Badge ── */
    .pp-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.35rem;
        border-radius: 4px;
        font-family: 'Orbitron', sans-serif;
        font-size: 0.55rem;
        font-weight: 800;
        letter-spacing: 0.05em;
        background: var(--gradient-sunset);
        color: white;
        line-height: 1.4;
    }

    /* ── Rank badges (from stats.html) ── */
    .rank-badge {
        display: inline-flex; align-items: center; justify-content: center;
        width: 22px; height: 22px; border-radius: 6px;
        font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.7rem;
    }
    .rank-1 { background: rgba(233, 30, 140, 0.2); color: var(--magenta); }
    .rank-2 { background: rgba(0, 212, 255, 0.2); color: var(--cyan); }
    .rank-3 { background: rgba(255, 193, 7, 0.2); color: var(--yellow); }
    .rank-4 { background: rgba(157, 78, 221, 0.2); color: var(--purple); }

    /* ── Type badges ── */
    .type-badge {
        display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px;
        font-family: 'Rajdhani', sans-serif; font-size: 0.65rem;
        font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .type-selection { background: rgba(233, 30, 140, 0.12); color: var(--magenta); }
    .type-exotic { background: rgba(0, 212, 255, 0.12); color: var(--cyan); }
    .type-sequence { background: rgba(255, 193, 7, 0.12); color: var(--yellow); }
    .type-big3_multi { background: rgba(157, 78, 221, 0.12); color: var(--purple); }

    /* ── Win cards (from stats.html) ── */
    .win-card {
        background: var(--bg-card-alt);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 1rem 1.25rem;
        transition: transform 0.15s;
    }
    .win-card:hover { transform: translateY(-2px); }
    .win-card-hero {
        border-color: rgba(233, 30, 140, 0.4);
        box-shadow: 0 0 30px rgba(233, 30, 140, 0.15), inset 0 0 30px rgba(233, 30, 140, 0.03);
    }

    /* ── Product bar ── */
    .product-bar {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.6rem 0.75rem; border-radius: 10px;
        background: var(--bg-card-alt); border: 1px solid var(--border-subtle);
    }

    /* ── Best of Meet slots ── */
    .bom-slot {
        padding: 0.35rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .bom-slot:last-child { border-bottom: none; }
    .bom-label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 0.25rem;
    }
    .bom-content {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    /* ── Dashboard footer links ── */
    .dash-footer-link {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-family: 'Rajdhani', sans-serif;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-secondary);
        border: 1px solid var(--border-subtle);
        text-decoration: none;
        transition: all 0.15s;
    }
    .dash-footer-link:hover {
        color: white;
        border-color: var(--magenta);
        background: rgba(233, 30, 140, 0.08);
    }

    /* ── Responsive ── */
    @media (max-width: 639px) {
        .glance-inner { padding: 0.375rem 0.75rem; gap: 0.5rem; }
        .glance-chip { padding: 0.25rem 0.5rem; }
        .glance-label { font-size: 0.6rem; }
        .glance-value { font-size: 0.75rem; }
    }
</style>
{% endblock %}

{% block content %}
{# ── At-A-Glance Strip (HTMX polling) ── #}
<div id="glance-strip"
     hx-get="/tips/_glance"
     hx-trigger="every 60s [document.visibilityState === 'visible']"
     hx-swap="innerHTML">
    {% include "partials/glance_strip.html" %}
</div>

<section class="py-6">
    <div class="max-w-6xl mx-auto px-4 sm:px-8">

        {# ── Header ── #}
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-display font-bold mb-1">
                <span style="background: var(--gradient-sunset); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Racing Dashboard</span>
            </h1>
            <p class="text-sm" style="color: var(--text-secondary);">
                Your one-stop shop for today's tips, results, and performance.
            </p>
        </div>

        {# ── Next Race Hero (HTMX polling) ── #}
        <div class="mb-6" id="next-race-hero"
             hx-get="/tips/_next-race"
             hx-trigger="every 30s [document.visibilityState === 'visible']"
             hx-swap="innerHTML">
            {% include "partials/next_race.html" %}
        </div>

        {# ── Today's Meetings (always full-width) ── #}
        <div class="mb-6">
            {% include "partials/meetings_grid.html" %}
        </div>

        {# ── Sequence Bets (full-width) ── #}
        {% if sequences|default([])|length > 0 %}
        <div class="mb-6">
            {% include "partials/sequence_bets.html" %}
        </div>
        {% endif %}

        {# ── Main content: 2/3 + 1/3 when we have best-of, else 2-col even ── #}
        {% set has_left = best_of|default({})|length > 0 %}
        {% if has_left %}
        <div class="grid lg:grid-cols-3 gap-6 mb-6">
            {# Left column (2/3) — best-of #}
            <div class="lg:col-span-2 space-y-6">
                {% include "partials/best_of_meet.html" %}
            </div>

            {# Right column (1/3) #}
            <div class="space-y-6">
                <div id="results-feed"
                     hx-get="/tips/_results-feed"
                     hx-trigger="every 120s [document.visibilityState === 'visible']"
                     hx-swap="innerHTML">
                    {% include "partials/results_feed.html" %}
                </div>
                {% include "partials/performance_snapshot.html" %}
            </div>
        </div>
        {% else %}
        {# No best-of yet — show results + performance in even 2-col #}
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div id="results-feed"
                 hx-get="/tips/_results-feed"
                 hx-trigger="every 120s [document.visibilityState === 'visible']"
                 hx-swap="innerHTML">
                {% include "partials/results_feed.html" %}
            </div>
            <div>
                {% include "partials/performance_snapshot.html" %}
            </div>
        </div>
        {% endif %}

        {# ── Quick Links Footer ── #}
        {% include "partials/dashboard_footer.html" %}

    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Countdown timer for next race — tabular-nums prevents layout jitter
(function() {
    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    function updateCountdown(el) {
        var start = el.dataset.start;
        if (!start) return;
        var target = new Date(start).getTime();
        var now = Date.now();
        var diff = target - now;

        if (diff <= 0) {
            el.textContent = 'JUMPING';
            el.style.color = 'var(--magenta)';
            return;
        }

        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);

        // Fixed-width format: always show padded minutes and seconds
        if (h > 0) {
            el.textContent = h + 'h ' + pad(m) + 'm ' + pad(s) + 's';
        } else if (m > 0) {
            el.textContent = pad(m) + 'm ' + pad(s) + 's';
        } else {
            el.textContent = pad(s) + 's';
            el.style.color = 'var(--magenta)';
        }
    }

    function tickAll() {
        var els = document.querySelectorAll('[data-start]');
        els.forEach(updateCountdown);
    }

    tickAll();
    setInterval(tickAll, 1000);
})();
</script>
{% endblock %}
